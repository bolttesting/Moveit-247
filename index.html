<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoveIt 247 - Complete Management System v2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- FORCE MOBILE CSS & SCROLL HINTS - NO CACHE -->
    <script>
        // Inject mobile CSS immediately (treat tablets/phones as mobile)
        if (window.innerWidth <= 768) {
            const style = document.createElement('style');
            style.id = 'force-mobile-css';
            style.innerHTML = `
                @media (max-width: 480px) {
                    body { font-size: 15px !important; background: #f9fafb !important; }
                    .main-header { padding: 16px !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }
                    .main-header h1 { font-size: 22px !important; font-weight: 800 !important; }
                    .content-area { padding: 16px !important; background: #f9fafb !important; }
                    .card { border-radius: 16px !important; margin-bottom: 24px !important; }
                    .card-header { padding: 20px !important; background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%) !important; }
                    .card-header h3 { font-size: 22px !important; font-weight: 800 !important; text-align: center !important; }
                    .stat-card h3 { font-size: 32px !important; font-weight: 900 !important; }
                    .status-badge { padding: 10px 18px !important; font-size: 14px !important; font-weight: 800 !important; border-radius: 24px !important; min-width: 100px !important; }
                    
                    /* FORCE HORIZONTAL SCROLL ON ALL TABLES */
                    .table-responsive { 
                        overflow-x: auto !important; 
                        -webkit-overflow-scrolling: touch !important;
                        width: 100% !important;
                    }
                    .table-responsive table { 
                        min-width: 950px !important; 
                        width: auto !important;
                        display: table !important;
                    }
                    .table-responsive table th, .table-responsive table td { 
                        padding: 16px 12px !important; 
                        font-size: 15px !important; 
                        min-height: 56px !important;
                        white-space: nowrap !important;
                    }
                    .table { min-width: 950px !important; }
                    .btn { min-height: 44px !important; font-weight: 700 !important; border-radius: 8px !important; }
                }
            `;
            document.head.appendChild(style);
            console.log('‚úÖ MOBILE CSS INJECTED!');
            
            // Wrap all bare tables with .table-responsive
            function wrapTablesWithResponsive() {
                const bareTables = document.querySelectorAll('table.table:not(.table-responsive table)');
                console.log(`üîß Found ${bareTables.length} bare tables to wrap...`);
                
                bareTables.forEach((table, index) => {
                    // Skip if already wrapped
                    if (table.parentElement && table.parentElement.classList.contains('table-responsive')) {
                        return;
                    }
                    
                    // Create wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-responsive';
                    
                    // Insert wrapper before table
                    table.parentNode.insertBefore(wrapper, table);
                    
                    // Move table inside wrapper
                    wrapper.appendChild(table);
                    
                    console.log(`‚úÖ Wrapped table #${index + 1}`);
                });
            }

            // Add scroll hints to ALL tables automatically
            function addScrollHints() {
                // First, wrap all bare tables
                wrapTablesWithResponsive();
                
                // Then add hints
                const tables = document.querySelectorAll('.table-responsive');
                console.log(`üì± Found ${tables.length} table containers, adding scroll hints...`);
                
                tables.forEach((table, index) => {
                    // Check if hint already exists
                    if (table.nextElementSibling && table.nextElementSibling.classList.contains('scroll-hint-container')) {
                        return;
                    }
                    
                    // Create hint element
                    const hint = document.createElement('div');
                    hint.className = 'scroll-hint-container';
                    hint.innerHTML = `
                        <div class="scroll-hint-text">üëà Swipe left to see more üëâ</div>
                        <div class="scroll-hint-arrow">‚Üê Swipe ‚Üí</div>
                    `;
                    
                    // Insert after table
                    table.parentNode.insertBefore(hint, table.nextSibling);
                    
                    // Add scroll detection
                    table.addEventListener('scroll', function() {
                        this.classList.add('scrolled');
                        const nextHint = this.nextElementSibling;
                        if (nextHint && nextHint.classList.contains('scroll-hint-container')) {
                            nextHint.style.display = 'none';
                        }
                    }, { once: true });
                    
                    console.log(`‚úÖ Hint #${index + 1} added to table`);
                });
            }
            
            // Run when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    addScrollHints();
                    setupMutationObserver();
                });
            } else {
                addScrollHints();
                setupMutationObserver();
            }
            
            // Setup MutationObserver to watch for new tables
            function setupMutationObserver() {
                console.log('üîç Setting up MutationObserver to watch for new tables...');
                
                const observer = new MutationObserver(function(mutations) {
                    let shouldCheck = false;
                    
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length > 0) {
                            mutation.addedNodes.forEach(function(node) {
                                if (node.nodeType === 1) { // Element node
                                    // Check for table-responsive OR regular table.table
                                    if (node.classList && (node.classList.contains('table-responsive') || node.classList.contains('table'))) {
                                        shouldCheck = true;
                                    } else if (node.querySelector) {
                                        if (node.querySelector('.table-responsive') || node.querySelector('table.table')) {
                                            shouldCheck = true;
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    if (shouldCheck) {
                        console.log('üîÑ New table detected, wrapping and adding hints...');
                        setTimeout(addScrollHints, 100);
                    }
                });
                
                // Start observing the content area for changes
                const contentArea = document.querySelector('.content-area') || document.body;
                observer.observe(contentArea, {
                    childList: true,
                    subtree: true
                });
                
                console.log('‚úÖ MutationObserver active and watching!');
            }
            
            // Also run periodically to catch any missed tables
            setInterval(addScrollHints, 2000);
        }
    </script>
    
    <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

        :root {
            /* Modern Color Palette */
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #a5b4fc;
            --secondary: #f093fb;
            --accent: #4facfe;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --info: #4299e1;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-400: #a0aec0;
            --gray-500: #718096;
            --gray-600: #4a5568;
            --gray-700: #2d3748;
            --gray-800: #1a202c;
            --gray-900: #171923;
            
            /* Background Gradients */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --bg-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --bg-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --bg-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --bg-danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            
            /* Glass Morphism */
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            /* Layout */
            --sidebar-width: 280px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            width: 420px;
            padding: 48px;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-box h2 {
            margin-bottom: 32px;
            color: var(--gray-900);
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .login-logo {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 24px;
            font-weight: 800;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #1f2937;
            font-size: 15px;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        .form-control {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: #ffffff;
            color: #111827;
            font-weight: 500;
            box-sizing: border-box;
            -webkit-appearance: none; /* Remove iOS styling */
            -moz-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray-500);
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }



        .btn {
            padding: 18px 36px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 44px; /* Better touch target */
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--bg-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-2xl);
        }

        .btn-success {
            background: var(--bg-success);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: var(--bg-warning);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: var(--bg-danger);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0891b2);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: #f3f4f6;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #0f172a;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--gray-800);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--gray-600);
            border-radius: 3px;
        }

        .sidebar-header {
            padding: 32px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.025em;
            position: relative;
            z-index: 1;
        }

        .sidebar-close {
            display: none;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .sidebar-close:active {
            transform: translateY(-50%) scale(0.95);
        }

        .sidebar-menu {
            padding: 24px 0;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 4px 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .sidebar-menu li a {
            color: var(--gray-300);
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 16px 20px;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
        }

        .sidebar-menu li a i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-menu li a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .sidebar-menu li.active a {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .sidebar-menu li.active a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: white;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 0;
            min-height: 100vh;
            background: #f3f4f6;
            position: relative;
        }

        .main-header {
            background: #ffffff;
            padding: 20px 32px;
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            display: none;
            border: 1px solid var(--gray-300);
            background: #fff;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
        }

        .header-left h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.025em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            box-shadow: var(--shadow-lg);
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 50%;
        }

        .user-avatar.admin {
            background: var(--bg-primary);
        }

        .user-avatar.supervisor {
            background: var(--bg-secondary);
        }

        .user-avatar.teamleader {
            background: var(--bg-accent);
        }

        .user-avatar.staff {
            background: var(--bg-success);
        }

        .user-details h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-details p {
            margin: 0;
            font-size: 12px;
            color: var(--gray-500);
        }

        .content-area {
            padding: 32px;
            background: transparent;
            position: relative;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                position: fixed;
                z-index: 1001;
                height: 100vh;
                width: 280px !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            body.sidebar-open .sidebar {
                transform: translateX(0);
            }
            body.sidebar-open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .sidebar-close {
                display: block !important;
            }
            .main-content {
                margin-left: 0;
            }
            .menu-toggle {
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            .dashboard-charts {
                grid-template-columns: 1fr;
            }
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .content-area {
            padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-header {
                padding: 16px 20px;
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .header-left h1 {
                font-size: 20px;
            }
            
            .header-right {
                gap: 12px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .stat-card {
                padding: 20px 16px;
            }
            
            .stat-card h3 {
                font-size: 24px;
            }
            
            .card-header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-input {
                width: 100%;
                max-width: 300px;
            }
            
            .content-area {
                padding: 16px;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 600px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .modal {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            .modal-content {
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }
            
            .emirates-id-section {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 640px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .card .card-body form[style*="grid"] {
                grid-template-columns: 1fr !important;
            }
            
            .header-right .user-info { 
                display: none; 
            }
            
            .main-header {
                padding: 12px 16px;
            }
            
            .content-area {
                padding: 12px;
            }
            
            .card-header h3 {
                font-size: 18px;
            }
            
            .stat-card h3 {
                font-size: 20px;
            }
            
            .stat-card p {
                font-size: 12px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .table-responsive table th,
            .table-responsive table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .modal {
                margin: 5px;
                max-height: calc(100vh - 10px);
            }
            
            .modal-content {
                margin: 0;
                max-height: calc(100vh - 10px);
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 16px 20px 12px;
            }
            
            .modal-body {
                padding: 16px 20px;
            }
            
            .modal-footer {
                padding: 12px 20px 16px;
            }
        }

        @media (max-width: 480px) {
            /* === MOBILE OPTIMIZATION === */
            
            /* Body & Container */
            body {
                font-size: 15px;
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            /* Header */
            .main-header {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .header-left {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .header-left h1 {
                font-size: 22px;
                font-weight: 800;
                color: #111827;
                letter-spacing: -0.5px;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            /* Content Area */
            .content-area {
                padding: 16px;
                background: #f9fafb;
            }
            
            /* === CARDS === */
            .card {
                margin-bottom: 24px;
                border-radius: 16px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                border: 1px solid #e5e7eb;
                background: white;
            }
            
            .card-header {
                padding: 20px;
                flex-direction: column;
                gap: 14px;
                border-bottom: 2px solid #f3f4f6;
                background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
            }
            
            .card-header h3 {
                font-size: 22px !important;
                font-weight: 800;
                color: #111827;
                text-align: center;
                width: 100%;
                letter-spacing: -0.5px;
                margin: 0;
            }
            
            .card-body {
                padding: 20px;
            }
            
            /* === STATS CARDS === */
            .stats-container {
                gap: 14px;
                margin-bottom: 24px;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 24px 18px;
                border-radius: 16px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 1px solid #e5e7eb;
                text-align: center;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .stat-card:active {
                transform: scale(0.98);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .stat-card h3 {
                font-size: 32px !important;
                font-weight: 900;
                margin: 0 0 6px 0;
                color: #111827;
                line-height: 1;
            }
            
            .stat-card p {
                font-size: 14px;
                font-weight: 600;
                opacity: 0.7;
                margin: 0;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            /* === BUTTONS === */
            .btn {
                padding: 10px 16px !important;
                font-size: 13px !important;
                font-weight: 700;
                border-radius: 8px;
                min-height: 44px;
                border: none;
                transition: all 0.2s;
            }
            
            .btn:active {
                transform: scale(0.97);
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            }
            
            .search-input {
                font-size: 16px !important;
                padding: 12px 16px;
                width: 100%;
                border-radius: 10px;
                border: 2px solid #e5e7eb;
                min-height: 48px;
            }
            
            .search-input:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            /* === MODALS === */
            .modal {
                margin: 10px;
                max-width: calc(100vw - 20px);
                border-radius: 16px;
            }
            
            .modal-content {
                max-height: calc(100vh - 20px);
                overflow-y: auto;
                border-radius: 16px;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }
            
            .emirates-id-section {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }
            
            /* === WELCOME SECTION === */
            .welcome-section h1 {
                font-size: 28px;
                font-weight: 900;
                line-height: 1.2;
                margin-bottom: 10px;
                color: #111827;
                letter-spacing: -0.5px;
            }
            
            .welcome-section p {
                font-size: 16px;
                line-height: 1.6;
                opacity: 0.75;
                color: #374151;
            }
            
            /* === NAVIGATION === */
            .sidebar-menu a {
                min-height: 52px;
                display: flex;
                align-items: center;
                padding: 16px 20px;
                font-size: 16px;
                font-weight: 600;
            }
            
            /* === CHARTS === */
            .chart-container {
                padding: 20px 12px;
            }
            
            /* === INPUTS === */
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="password"],
            textarea,
            select {
                font-size: 16px !important;
                padding: 12px !important;
                border-radius: 8px;
                min-height: 48px;
            }
            
            /* === TABLES - HORIZONTAL SCROLL === */
            .table-responsive {
                position: relative;
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                border-radius: 12px;
                box-shadow: 0 0 0 1px #e5e7eb;
                background: white;
                margin-bottom: 8px;
            }
            
            .table-responsive::-webkit-scrollbar {
                height: 10px;
            }
            
            .table-responsive::-webkit-scrollbar-track {
                background: #f8fafc;
                border-radius: 5px;
                margin: 0 8px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
                border-radius: 5px;
                border: 2px solid #f8fafc;
            }
            
            .table-responsive::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            }
            
            .table-responsive table {
                min-width: 950px !important;
                margin-bottom: 0;
                border-collapse: separate;
                border-spacing: 0;
            }
            
            .table-responsive table th,
            .table-responsive table td {
                white-space: nowrap;
                padding: 16px 12px !important;
                font-size: 15px !important;
                vertical-align: middle;
                min-height: 56px;
            }
            
            /* First Column (Checkbox) - Sticky */
            .table-responsive table th:first-child,
            .table-responsive table td:first-child {
                position: sticky;
                left: 0;
                background: white;
                z-index: 10;
                box-shadow: 4px 0 8px -2px rgba(0,0,0,0.08);
            }
            
            .table-responsive table thead th:first-child {
                background: #f8fafc;
                font-weight: 800;
            }
            
            /* === TABLE HEADER === */
            .table-responsive table thead {
                background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
                border-bottom: 2px solid #e5e7eb;
            }
            
            .table-responsive table thead th {
                font-weight: 800;
                color: #111827;
                font-size: 14px !important;
                text-transform: uppercase;
                letter-spacing: 0.75px;
                padding: 18px 12px !important;
            }
            
            /* === TABLE ROWS === */
            .table-responsive table tbody tr {
                border-bottom: 1px solid #f3f4f6;
                transition: background-color 0.15s;
            }
            
            .table-responsive table tbody tr:hover {
                background-color: #fafbfc;
            }
            
            .table-responsive table tbody tr:active {
                background-color: #f3f4f6;
            }
            
            /* Job ID Column */
            .table-responsive table tbody td:nth-child(2) {
                font-weight: 800;
                color: #2563eb;
                font-size: 16px !important;
            }
            
            /* === STATUS BADGES === */
            .table-responsive .status-badge,
            .status-badge {
                padding: 10px 18px !important;
                font-size: 14px !important;
                font-weight: 800;
                border-radius: 24px;
                min-width: 100px;
                display: inline-block;
                text-align: center;
                letter-spacing: 0.3px;
                text-transform: uppercase;
                box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            }
            
            /* === SCROLL INDICATOR - BELOW TABLE === */
            .scroll-hint-container {
                display: block;
                text-align: center;
                padding: 16px 20px;
                margin: 0 0 16px 0;
                background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
                border: 2px solid #60a5fa;
                border-radius: 12px;
                animation: hintPulse 2.5s infinite ease-in-out;
                box-shadow: 0 2px 8px rgba(96, 165, 250, 0.2);
            }
            
            .scroll-hint-text {
                font-size: 14px;
                font-weight: 700;
                color: #1e40af;
                margin: 0 0 8px 0;
                letter-spacing: 0.3px;
            }
            
            .scroll-hint-arrow {
                display: inline-block;
                font-size: 18px;
                font-weight: 900;
                color: #ffffff;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                padding: 10px 24px;
                border-radius: 30px;
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                letter-spacing: 2px;
                animation: arrowSlide 2s infinite ease-in-out;
            }
            
            @keyframes arrowSlide {
                0%, 100% { 
                    transform: translateX(0) scale(1);
                    opacity: 0.9;
                }
                50% { 
                    transform: translateX(8px) scale(1.05);
                    opacity: 1;
                }
            }
            
            .table-responsive.scrolled + .scroll-hint-container {
                display: none !important;
            }
            
            /* === MOBILE HINT TEXT === */
            .mobile-scroll-hint {
                display: block !important;
                animation: hintPulse 2.5s infinite ease-in-out;
                font-weight: 700;
                padding: 16px 20px !important;
                background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%) !important;
                border: 2px solid #60a5fa !important;
                border-radius: 12px !important;
                margin: 16px 0 !important;
                font-size: 14px !important;
                color: #1e40af !important;
                text-align: center;
                box-shadow: 0 2px 6px rgba(96, 165, 250, 0.2);
            }
            
            @keyframes hintPulse {
                0%, 100% { 
                    opacity: 0.85;
                    transform: scale(1);
                }
                50% { 
                    opacity: 1;
                    transform: scale(1.03);
                }
            }
            
            .table-responsive.scrolled + .mobile-scroll-hint {
                display: none !important;
            }
            
            /* === ACTION BUTTONS IN TABLE === */
            .table-responsive table td:last-child .btn {
                display: inline-block;
                margin: 3px !important;
                padding: 8px 12px !important;
                font-size: 12px !important;
                white-space: nowrap;
                min-height: 36px;
            }
            
            .table-responsive .btn-sm {
                padding: 6px 10px !important;
                font-size: 11px !important;
                line-height: 1.3;
                min-height: 32px;
            }
            
            /* === QUICK ACTIONS === */
            .quick-actions {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 14px !important;
                justify-content: center !important;
            }
            
            .quick-action-btn {
                flex: 1 1 calc(50% - 7px) !important;
                min-width: 120px !important;
                max-width: none !important;
            }
            
            .quick-action-card {
                text-align: center;
                padding: 24px 20px;
                border-radius: 16px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .quick-action-card:active {
                transform: scale(0.98);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* === PAGINATION === */
            .pagination {
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
                padding: 20px 0;
            }
            
            .pagination button {
                min-width: 48px;
                min-height: 48px;
                font-weight: 700;
                border-radius: 10px;
            }
            
            /* === FILTERS & SEARCH === */
            .header-controls {
                flex-direction: column;
                width: 100%;
                gap: 12px;
            }
            
            .search-box {
                width: 100%;
                flex-direction: column;
                gap: 12px;
            }
            
            .search-box input,
            .search-box select {
                width: 100%;
            }
            
            /* === CHECKBOXES === */
            input[type="checkbox"] {
                width: 22px;
                height: 22px;
                cursor: pointer;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* Cards and Tables */
        .card {
            background: #ffffff;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 28px;
            overflow: hidden;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            position: relative;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 24px 32px;
            background: linear-gradient(135deg, var(--gray-50), white);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.025em;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box input,
        .search-box select {
            min-width: 200px;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid #eee;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-controls button {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-number {
            padding: 5px 10px;
            margin: 0 2px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .page-number.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-number:hover:not(.active) {
            background: #f5f5f5;
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid var(--gray-200);
            padding: 32px 24px;
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--bg-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card i {
            font-size: 2.5rem;
            background: var(--bg-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            display: block;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin: 15px 0;
            color: var(--gray-800);
            font-weight: 700;
        }

        .stat-card p {
            color: var(--gray-600);
            margin: 0;
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .template-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.2);
        }

        .template-card h4 {
            margin: 0 0 10px 0;
            color: var(--dark);
        }

        .template-card p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }

        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .template-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .templates-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .template-form {
            border-right: 1px solid #eee;
            padding-right: 20px;
        }

        .templates-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .template-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .template-item h5 {
            margin: 0 0 10px 0;
            color: var(--dark);
        }

        .template-item p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }

        .template-item-actions {
            display: flex;
            gap: 10px;
        }

        .template-item-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bulk-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .export-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .image-preview {
            margin-top: 8px;
            display: none;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--gray-200);
        }

        .image-preview.show {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .emirates-id-display {
            display: flex;
            gap: 16px;
            margin: 16px 0;
        }

        .emirates-id-item {
            flex: 1;
            text-align: center;
        }

        .emirates-id-item h4 {
            margin-bottom: 8px;
            color: var(--gray-700);
            font-size: 14px;
        }

        .emirates-id-item img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--gray-200);
        }

        .card-body {
            padding: 32px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: var(--light);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-delayed { background: #f8d7da; color: #721c24; }
        .status-available { background: #d4edda; color: #155724; }
        .status-dayoff { background: #f8d7da; color: #721c24; }
        .status-waiting-approval { background: #fff3cd; color: #856404; }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 3000;
            display: none;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border-left: 4px solid var(--primary-color);
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--error-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.info {
            border-left-color: var(--info-color);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: var(--success-color);
        }

        .toast.error .toast-icon {
            background: var(--error-color);
        }

        .toast.warning .toast-icon {
            background: var(--warning-color);
        }

        .toast.info .toast-icon {
            background: var(--info-color);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .toast-message {
            color: var(--text-secondary);
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 18px;
            line-height: 1;
        }

        .toast-close:hover {
            background: var(--background-light);
            color: var(--text-primary);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary-color);
            transition: width linear;
        }

        .toast.success .toast-progress {
            background: var(--success-color);
        }

        .toast.error .toast-progress {
            background: var(--error-color);
        }

        .toast.warning .toast-progress {
            background: var(--warning-color);
        }

        .toast.info .toast-progress {
            background: var(--info-color);
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--background-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Slide In Animation */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }

        /* Modern Progress Bars */
        .progress-container {
            background: var(--background-light);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 10px;
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 4px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.assigned {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .status-badge.arrived {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-badge.packing-start {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
        
        .status-badge.first-location-completed {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .status-badge.arrived-second-location {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .status-badge.unpacking-start {
            background: rgba(236, 72, 153, 0.1);
            color: #ec4899;
        }

        .status-badge.waiting-approval {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-badge.completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-badge.delayed {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .welcome-message h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 10px 0;
            position: relative;
            z-index: 1;
            color: #1a1a1a;
            text-shadow: none;
        }

        .welcome-message p {
            font-size: 1.1rem;
            margin: 0;
            position: relative;
            z-index: 1;
            color: #4a4a4a;
            text-shadow: none;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }

        .quick-action-btn {
            background: #3b82f6;
            border: 1px solid #2563eb;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .quick-action-btn i {
            font-size: 18px;
        }

        /* Enhanced Animations */
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .slide-in-left {
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .scale-in {
            animation: scaleIn 0.4s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Floating Animation */
        .float {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Pulse Animation for Important Elements */
        .pulse-important {
            animation: pulseImportant 2s infinite;
        }

        @keyframes pulseImportant {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        /* Stagger Animation for Lists */
        .stagger-item {
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .stagger-item:nth-child(1) { animation-delay: 0.1s; }
        .stagger-item:nth-child(2) { animation-delay: 0.2s; }
        .stagger-item:nth-child(3) { animation-delay: 0.3s; }
        .stagger-item:nth-child(4) { animation-delay: 0.4s; }
        .stagger-item:nth-child(5) { animation-delay: 0.5s; }
        .stagger-item:nth-child(6) { animation-delay: 0.6s; }

        /* Star Rating System */
        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffc107;
            transform: scale(1.1);
        }

        .star.rated {
            color: #ffc107;
        }

        /* Signature Pad */
        .signature-pad-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            margin: 15px 0;
        }

        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: crosshair;
        }

        .signature-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .signature-preview {
            max-width: 100%;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Job History Styles */
        .job-history-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .history-timeline {
            position: relative;
            padding-left: 30px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }

        .history-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            border: 3px solid white;
        }

        .history-status {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .history-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .history-image:hover {
            transform: scale(1.05);
        }

        .history-notes {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            color: #856404;
        }

        .history-notes::before {
            content: 'üí¨ Comment: ';
            font-weight: 600;
        }

        .history-item-delayed {
            background: #ffe6e6 !important;
            border-left: 4px solid #dc3545;
        }

        .history-item-delayed .history-status {
            color: #dc3545 !important;
            font-weight: 700;
        }

        .history-item-delayed .history-notes {
            background: #ffdddd;
            border-left-color: #dc3545;
            color: #721c24;
        }

        /* Bill Attachment Styles */
        .bill-item {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
        }

        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bill-description {
            font-weight: 600;
            color: #2e7d32;
            font-size: 16px;
        }

        .bill-amount {
            font-size: 18px;
            font-weight: 700;
            color: #1b5e20;
        }

        .bill-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #666;
        }

        .bill-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .bill-file-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: #4caf50;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
        }

        .bill-file-link:hover {
            background: #45a049;
            color: white;
        }

        .bill-notes {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
        }

        .attach-bill-btn {
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* Bill Modal - Higher z-index to appear above job details modal */
        #bill-modal {
            z-index: 10001 !important;
        }

        /* Image Upload Modal for Status Changes */
        .status-image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .status-image-modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: scaleIn 0.3s ease-out;
        }

        .status-image-modal h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .status-image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        /* Completion Modal Styles */
        .completion-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .completion-modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: scaleIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .completion-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .completion-section h4 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .image-item {
            width: 120px;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-content img {
            width: 100%;
            height: auto;
            max-height: 90vh;
            object-fit: contain;
        }

        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
        }

        .staff-card {
            width: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            background: #f9f9f9;
        }

        .staff-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .staff-card h4 {
            margin: 5px 0;
            font-size: 14px;
        }

        .staff-card p {
            font-size: 12px;
            color: #666;
            margin: 2px 0;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #555;
        }

        .detail-value {
            flex: 1;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Delete Image Button Styles */
        .delete-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .image-item {
            position: relative;
        }

        .image-item:hover .delete-image-btn {
            opacity: 1;
        }

        .delete-image-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
        }

        .delete-image-btn i {
            font-size: 14px;
        }

        /* Live Tracking Styles */
        .tracking-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f0fdf4;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #166534;
        }

        .tracking-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .tracking-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tracking-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .tracking-card.active {
            border-color: #48bb78;
            background: #f0fdf4;
        }

        .tracking-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tracking-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .tracking-info h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }

        .tracking-info p {
            margin: 4px 0 0 0;
            font-size: 13px;
            color: #718096;
        }

        .tracking-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .tracking-time {
            font-size: 12px;
            color: #a0aec0;
        }

        .tracking-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .tracking-badge.online {
            background: #d1fae5;
            color: #065f46;
        }

        .tracking-badge.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        #tracking-map {
            border: 2px solid #e2e8f0;
        }

        /* Location Status Indicator */
        .location-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 25px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
            animation: locationPulse 2s infinite;
        }

        @keyframes locationPulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3); }
            50% { box-shadow: 0 2px 12px rgba(72, 187, 120, 0.6); }
        }

        .location-status i {
            animation: locationBounce 2s infinite;
        }

        @keyframes locationBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* Notification Badge */
        .notification-badge {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Browser Notification Toast */
        .browser-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(420px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .browser-notification.slide-out {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(420px); opacity: 0; }
        }

        .browser-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .browser-notification-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .browser-notification-title {
            font-weight: 700;
            font-size: 15px;
            color: #1a202c;
        }

        .browser-notification-body {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
        }

        .browser-notification-time {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 8px;
        }

        /* Notification List Styles */
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notification-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .notification-item.unread {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-item-title {
            font-weight: 700;
            font-size: 15px;
            color: #1a202c;
        }

        .notification-item-time {
            font-size: 12px;
            color: #a0aec0;
        }

        .notification-item-body {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .notification-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #718096;
        }

        .notification-read-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .read-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }

        .unread-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        /* Admin Send Notification Form */
        .send-notification-form {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-truck-moving"></i>
            </div>
            <h2>MoveIt 247 - Login</h2>
            <form id="login-form" novalidate>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="button" class="btn btn-primary" style="width: 100%;" onclick="app.handleLogin(event)">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img id="sidebar-logo" alt="MoveIt 24/7" style="height:40px; width:auto; margin-bottom:8px; display:none;" onerror="this.style.display='none'" />
                <button class="sidebar-close" onclick="document.body.classList.remove('sidebar-open')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li class="active"><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#jobs"><i class="fas fa-tasks"></i> Jobs</a></li>
                    <li id="supervisors-menu-item"><a href="#supervisors"><i class="fas fa-user-tie"></i> Supervisors</a></li>
                    <li id="teamleaders-menu-item"><a href="#teamleaders"><i class="fas fa-users"></i> Team Leaders</a></li>
                    <li id="staff-menu-item"><a href="#staff"><i class="fas fa-user-friends"></i> Staff</a></li>
                    <li id="surveys-menu-item"><a href="#surveys"><i class="fas fa-clipboard-check"></i> Surveys</a></li>
                    <li><a href="#job-history"><i class="fas fa-history"></i> Job History</a></li>
                    <li id="live-tracking-menu-item"><a href="#live-tracking"><i class="fas fa-map-marker-alt"></i> Live Tracking</a></li>
                    <li id="pending-approval-menu-item"><a href="#pending-approval"><i class="fas fa-clock"></i> Pending Approval</a></li>
                    <li id="reports-menu-item"><a href="#reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                    <li id="notifications-menu-item"><a href="#notifications"><i class="fas fa-bell"></i> Notifications <span id="notification-badge" class="notification-badge" style="display: none;">0</span></a></li>
                    <li><a href="#profile"><i class="fas fa-user"></i> My Profile</a></li>
                    <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="header-left">
                <button class="menu-toggle" onclick="document.body.classList.toggle('sidebar-open')"><i class="fas fa-bars"></i></button>
                <h1 id="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                <div id="location-status" class="location-status" style="display: none; margin-right: 15px;">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="location-text">Location Sharing</span>
                </div>
                <button id="clear-data-btn" class="btn btn-outline btn-sm" onclick="app.clearAllData()" style="margin-right: 10px; display: none;">Clear Data</button>
                <div class="user-info">
                        <div class="user-avatar" id="user-avatar">
                            <span id="user-initials">AU</span>
                </div>
                        <div class="user-details">
                            <h4 id="user-name">Admin User</h4>
                            <p id="user-role">Administrator</p>
            </div>
                    </div>
                </div>
            </div>
            <div class="content-area">

            <!-- Dashboard -->
            <div class="tab-content active" id="dashboard-content">
                <div class="welcome-section" id="welcome-section" style="display: none;">
                    <div class="welcome-message">
                        <h1 id="welcome-greeting">Welcome!</h1>
                        <p id="welcome-message">Welcome to your MoveIt 247 dashboard. Here's what's happening today.</p>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="app.navigateTo('jobs')" data-tooltip="View all jobs">
                            <i class="fas fa-tasks"></i>
                            <span>Jobs</span>
                        </button>
                        <button class="quick-action-btn" onclick="app.navigateTo('supervisors')" data-tooltip="Manage supervisors">
                            <i class="fas fa-user-tie"></i>
                            <span>Supervisors</span>
                        </button>
                        <button class="quick-action-btn" onclick="app.navigateTo('teamleaders')" data-tooltip="Manage team leaders">
                            <i class="fas fa-users"></i>
                            <span>Team Leaders</span>
                        </button>
                        <button class="quick-action-btn" onclick="app.navigateTo('staff')" data-tooltip="Manage staff">
                            <i class="fas fa-user-friends"></i>
                            <span>Staff</span>
                        </button>
                    </div>
                </div>
                <div class="stats-container">
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3 id="ongoing-jobs">0</h3>
                        <p>Ongoing Jobs</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-day"></i>
                        <h3 id="future-jobs">0</h3>
                        <p>Future Jobs</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="completed-jobs">0</h3>
                        <p>Completed Jobs</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <h3 id="pending-approval-count">0</h3>
                        <p>Pending Approval</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="total-staff">0</h3>
                        <p>Total Staff</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-tie"></i>
                        <h3 id="total-supervisors">0</h3>
                        <p>Supervisors</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="total-teamleaders">0</h3>
                        <p>Team Leaders</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h3 id="completion-rate">0%</h3>
                        <p>Completion Rate</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3 id="delayed-jobs">0</h3>
                        <p>Delayed Jobs</p>
                    </div>
                </div>

                <div class="dashboard-charts">
                    <div class="card">
                        <div class="card-header">
                            <h3>Job Status Distribution</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="jobStatusChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Monthly Job Trends</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="monthlyTrendsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Jobs</h3>
                    </div>
                    <div class="card-body">
                        <table class="table" id="recent-jobs-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Team Leader</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="no-data">No jobs available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Jobs -->
            <div class="tab-content" id="jobs-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Job Templates</h3>
                        <button class="btn btn-secondary" onclick="app.showTemplatesModal()">Manage Templates</button>
                    </div>
                    <div class="card-body">
                        <div class="templates-grid" id="templates-grid">
                            <!-- Templates will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="card" id="add-job-card">
                    <div class="card-header">
                        <h3>Add New Job</h3>
                    </div>
                    <div class="card-body">
                        <form id="add-job-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Moving Date</label>
                                    <input type="date" class="form-control" id="job-date" required>
                                </div>
                                <div class="form-group">
                                    <label>Moving Time</label>
                                    <input type="time" class="form-control" id="job-time" required>
                                </div>
                                <div class="form-group">
                                    <label>Client Name</label>
                                    <input type="text" class="form-control" id="client-name" required>
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" class="form-control" id="client-phone" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="client-email" required>
                                </div>
                                <div class="form-group">
                                    <label>Apartment Size</label>
                                    <select class="form-control" id="apartment-size" required onchange="app.handleApartmentSizeChange()">
                                        <option value="">Select Size</option>
                                        <option value="small">Small</option>
                                        <option value="medium">Medium</option>
                                        <option value="large">Large</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group" id="apartment-size-custom-group" style="display: none;">
                                    <label>Custom Apartment Size</label>
                                    <input type="text" class="form-control" id="apartment-size-custom" placeholder="E.g., 4 Bedroom Villa, Studio, Penthouse">
                                </div>
                                <div class="form-group">
                                    <label>Moving From</label>
                                    <input type="text" class="form-control" id="move-from" required>
                                </div>
                                <div class="form-group">
                                    <label>Moving To</label>
                                    <input type="text" class="form-control" id="move-to" required>
                                </div>
                                <div class="form-group">
                                    <label>Assign Team Leader</label>
                                    <select class="form-control" id="team-leader-assign">
                                        <option value="">Select Team Leader</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Assign Staff</label>
                                    <select class="form-control" id="assign-staff" multiple>
                                        <option value="">Select Staff</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Moving Out Permit</label>
                                <input type="file" class="form-control" id="move-out-permit" accept="image/*">
                                <div class="image-preview" id="move-out-preview"></div>
                            </div>
                            <div class="form-group">
                                <label>Moving In Permit</label>
                                <input type="file" class="form-control" id="move-in-permit" accept="image/*">
                                <div class="image-preview" id="move-in-preview"></div>
                            </div>
                            <div class="form-group">
                                <label>Item Images</label>
                                <input type="file" class="form-control" id="item-images" accept="image/*" multiple>
                                <div class="image-preview" id="item-images-preview"></div>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Special Instructions (Optional)</label>
                                <textarea class="form-control" id="job-instructions" rows="4" placeholder="Enter any special instructions for this job (e.g., fragile items, parking info, elevator access, etc.)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Job</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Current Jobs</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="jobs-search" placeholder="Search jobs..." class="form-control" onkeyup="app.filterJobs()">
                                <select id="jobs-status-filter" class="form-control" onchange="app.filterJobs()">
                                    <option value="">All Statuses</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="arrived">Arrived at 1st Location</option>
                                    <option value="packing-start">Packing Start</option>
                                    <option value="first-location-completed">1st Location Completed</option>
                                    <option value="arrived-second-location">Arrived at 2nd Location</option>
                                    <option value="unpacking-start">Unpacking Start</option>
                                    <option value="waiting-approval">Waiting Approval</option>
                                    <option value="completed">Completed</option>
                                    <option value="delayed">Delayed</option>
                                </select>
                            </div>
                            <div class="bulk-actions" id="bulk-actions" style="display: none;">
                                <button class="btn btn-secondary btn-sm" onclick="app.bulkUpdateStatus()">Update Status</button>
                                <button class="btn btn-warning btn-sm" onclick="app.bulkAssignTeamLeader()">Assign Team Leader</button>
                                <button class="btn btn-danger btn-sm" onclick="app.bulkDeleteJobs()">Delete Selected</button>
                                <button class="btn btn-info btn-sm" onclick="app.selectAllJobs()">Select All</button>
                                <button class="btn btn-secondary btn-sm" onclick="app.clearSelection()">Clear Selection</button>
                            </div>
                            <div class="export-actions">
                                <button class="btn btn-success btn-sm" onclick="app.exportJobsCSV()">Export CSV</button>
                                <button class="btn btn-primary btn-sm" onclick="app.exportJobsPDF()">Export PDF</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                        <table class="table" id="current-jobs-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-jobs" onchange="app.toggleSelectAllJobs()"></th>
                                    <th>Job ID</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Team Leader</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="no-data">No jobs available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                        <div class="mobile-scroll-hint" style="display: none; text-align: center; padding: 8px; color: #64748b; font-size: 12px; background: #f8fafc; border-radius: 4px; margin-top: 8px;">
                            ‚Üê Swipe left to see more ‚Üí
                    </div>
                        <div class="pagination-container" id="jobs-pagination">
                            <div class="pagination-info">
                                <span id="jobs-pagination-info">Showing 1-10 of 0</span>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-sm" id="jobs-prev" onclick="app.previousPage('jobs')" disabled>Previous</button>
                                <span id="jobs-page-numbers"></span>
                                <button class="btn btn-sm" id="jobs-next" onclick="app.nextPage('jobs')" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Approval -->
            <div class="tab-content" id="pending-approval-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Jobs Pending Approval</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="pending-approval-search" placeholder="Search pending jobs..." class="form-control" onkeyup="app.filterPendingApproval()">
                            </div>
                            <div class="export-actions">
                                <button class="btn btn-success btn-sm" onclick="app.exportPendingApprovalCSV()">Export CSV</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="pending-approval-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Team Leader</th>
                                    <th>Rating</th>
                                    <th>Tip Amount</th>
                                    <th>Boxes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="no-data">No jobs pending approval</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Supervisors -->
            <div class="tab-content" id="supervisors-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Supervisors</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="supervisors-search" placeholder="Search supervisors..." class="form-control" onkeyup="app.filterSupervisors()">
                            </div>
                        <button class="btn btn-primary" id="add-supervisor-btn">Add Supervisor</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="supervisors-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="no-data">No supervisors available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Team Leaders -->
            <div class="tab-content" id="teamleaders-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Team Leaders</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="teamleaders-search" placeholder="Search team leaders..." class="form-control" onkeyup="app.filterTeamLeaders()">
                            </div>
                        <button class="btn btn-primary" id="add-teamleader-btn">Add Team Leader</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="teamleaders-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Designation</th>
                                    <th>Jobs Completed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="no-data">No team leaders available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Staff -->
            <div class="tab-content" id="staff-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Staff Members</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="staff-search" placeholder="Search staff..." class="form-control" onkeyup="app.filterStaff()">
                            </div>
                        <button class="btn btn-primary" id="add-staff-btn">Add Staff</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="staff-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Phone</th>
                                    <th id="staff-designation-header">Designation</th>
                                    <th>Team Leader</th>
                                    <th>Is Team Leader</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="no-data">No staff members available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Surveys -->
            <div class="tab-content" id="surveys-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Surveys</h3>
                        <div class="header-controls">
                            <div class="search-box">
                                <input type="text" id="surveys-search" placeholder="Search surveys..." class="form-control" onkeyup="app.filterSurveys()">
                            </div>
                            <button class="btn btn-primary" id="add-survey-btn" style="display: none;">Create Survey</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="surveys-table">
                                <thead>
                                    <tr>
                                        <th>Survey ID</th>
                                        <th>Client Name</th>
                                        <th>Client Number</th>
                                        <th>Location</th>
                                        <th>Apartment Size</th>
                                        <th>Survey Time</th>
                                        <th>Assigned To</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="9" class="no-data">No surveys available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job History -->
            <div class="tab-content" id="job-history-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Job History</h3>
                    </div>
                    <div class="card-body">
                        <table class="table" id="job-history-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Client</th>
                                    <th>Moving Date</th>
                                    <th>Completed Date</th>
                                    <th>Team Leader</th>
                                    <th>Rating</th>
                                    <th>Tip Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="no-data">No job history available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Live Tracking -->
            <div class="tab-content" id="live-tracking-content">
                <div class="card">
                    <div class="card-header">
                        <h3>üåç Live Team Leader Tracking</h3>
                        <div class="header-controls">
                            <button class="btn btn-primary btn-sm" onclick="app.refreshTracking()" id="refresh-tracking-btn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <span class="tracking-status" id="tracking-status">
                                <i class="fas fa-circle" style="color: #48bb78; font-size: 10px;"></i> Auto-refresh: ON
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="tracking-map" style="height: 600px; border-radius: 8px; overflow: hidden;"></div>
                        
                        <!-- Team Leader List -->
                        <div class="tracking-list" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px;">üìç Team Leader Locations</h4>
                            <div id="tracking-list-container" class="tracking-list-grid">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div class="tab-content" id="reports-content">
                <!-- Team Leader Performance Report -->
                <div class="card">
                    <div class="card-header">
                        <h3>Team Leader Performance Report</h3>
                        <div class="header-controls">
                            <button class="btn btn-success btn-sm" onclick="app.exportTeamLeaderReportCSV()">Export CSV</button>
                            <button class="btn btn-danger btn-sm" onclick="app.exportTeamLeaderReportPDF()">Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="teamleader-performance-table">
                                <thead>
                                    <tr>
                                        <th>Team Leader</th>
                                        <th>Total Jobs</th>
                                        <th>Completed</th>
                                        <th>Pending</th>
                                        <th>Delayed</th>
                                        <th>Completion Rate</th>
                                        <th>Avg Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="no-data">No performance data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Staff Performance Report -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>Staff Performance Report</h3>
                        <div class="header-controls">
                            <button class="btn btn-success btn-sm" onclick="app.exportStaffReportCSV()">Export CSV</button>
                            <button class="btn btn-danger btn-sm" onclick="app.exportStaffReportPDF()">Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="staff-performance-table">
                                <thead>
                                    <tr>
                                        <th>Staff Name</th>
                                        <th>Designation</th>
                                        <th>Team Leader</th>
                                        <th>Total Jobs</th>
                                        <th>Completed</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="no-data">No staff data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Jobs Summary Report -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>Jobs Summary Report</h3>
                        <div class="header-controls">
                            <button class="btn btn-success btn-sm" onclick="app.exportJobsSummaryCSV()">Export CSV</button>
                            <button class="btn btn-danger btn-sm" onclick="app.exportJobsSummaryPDF()">Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="jobs-summary-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="no-data">No jobs data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Revenue Report -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3>Revenue Report (Tips & Completed Jobs)</h3>
                        <div class="header-controls">
                            <button class="btn btn-success btn-sm" onclick="app.exportRevenueReportCSV()">Export CSV</button>
                            <button class="btn btn-danger btn-sm" onclick="app.exportRevenueReportPDF()">Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="revenue-report-table">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Team Leader</th>
                                        <th>Tip Amount (AED)</th>
                                        <th>Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="no-data">No revenue data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="tab-content" id="notifications-content">
                <!-- Admin: Send Custom Notification Form -->
                <div class="card" id="send-notification-card" style="display: none;">
                    <div class="card-header">
                        <h3>üì¢ Send Custom Notification</h3>
                    </div>
                    <div class="card-body">
                        <form id="send-notification-form" class="send-notification-form">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="send-to-all-checkbox" style="margin-right: 8px;">
                                    Send to All Users
                                </label>
                            </div>
                            <div class="form-group" id="recipient-group">
                                <label>Recipient *</label>
                                <select class="form-control" id="notification-recipient" required>
                                    <option value="">Select recipient...</option>
                                    <optgroup label="Supervisors" id="notification-supervisors"></optgroup>
                                    <optgroup label="Team Leaders" id="notification-teamleaders"></optgroup>
                                    <optgroup label="Staff" id="notification-staff"></optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" class="form-control" id="notification-title" placeholder="e.g., Urgent: Schedule Change" required>
                            </div>
                            <div class="form-group">
                                <label>Message *</label>
                                <textarea class="form-control" id="notification-message" rows="4" placeholder="Your notification message..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="card">
                    <div class="card-header">
                        <h3>üîî Your Notifications</h3>
                        <div class="header-controls">
                            <button class="btn btn-outline btn-sm" onclick="app.markAllNotificationsRead()">
                                <i class="fas fa-check-double"></i> Mark All Read
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="notifications-list" class="notification-list">
                            <p style="text-align: center; color: #a0aec0; padding: 40px;">
                                No notifications yet
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile -->
            <div class="tab-content" id="profile-content">
                <div class="card">
                    <div class="card-header">
                        <h3>My Profile</h3>
                    </div>
                    <div class="card-body">
                        <form id="profile-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" class="form-control" id="profile-name">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" class="form-control" id="profile-phone">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="profile-email">
                                </div>
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" class="form-control" id="profile-password">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input type="password" class="form-control" id="profile-confirm-password">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Profile Image</label>
                                <input type="file" class="form-control" id="profile-image" accept="image/*">
                                <div class="image-preview" id="profile-image-preview"></div>
                            </div>
                            <div class="form-group">
                                <label>Emirates ID (Front)</label>
                                <input type="file" class="form-control" id="emirates-id-front" accept="image/*">
                                <div class="image-preview" id="emirates-front-preview"></div>
                            </div>
                            <div class="form-group">
                                <label>Emirates ID (Back)</label>
                                <input type="file" class="form-control" id="emirates-id-back" accept="image/*">
                                <div class="image-preview" id="emirates-back-preview"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
                
                <!-- Branding Section (Admin Only) -->
                <div class="card" id="branding-card" style="display: none; margin-top: 20px;">
                    <div class="card-header">
                        <h3>Company Branding</h3>
                    </div>
                    <div class="card-body">
                        <form id="branding-form">
                            <div class="form-group">
                                <label>Company Logo</label>
                                <p style="color: #64748b; font-size: 14px; margin-bottom: 10px;">Upload your logo to display on the app header, sidebar, and PDF reports.</p>
                                <input type="file" class="form-control" id="branding-logo" accept="image/*">
                                <div class="image-preview" id="branding-logo-preview" style="margin-top: 15px;"></div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="app.saveBranding()">Save Logo</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Modern Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-content">
            <img id="modal-image" src="" alt="Preview">
        </div>
    </div>

    <!-- Status Image Upload Modal -->
    <div class="status-image-modal" id="status-image-modal">
        <div class="status-image-modal-content">
            <h3>Update Job Status</h3>
            <p id="status-modal-instruction">Please upload an image and add comments for this status change:</p>
            
            <div class="form-group">
                <label>Upload Image (Optional)</label>
            <input type="file" id="status-image-input" accept="image/*" onchange="app.previewStatusImage()">
            <img id="status-image-preview" class="status-image-preview" alt="Preview">
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>Comments/Notes <span id="notes-required-indicator" style="color: red; display: none;">*</span></label>
                <textarea id="status-notes" class="form-control" rows="4" placeholder="Add comments about this status change (e.g., traffic delay, client not ready, waiting for permits, etc.)..."></textarea>
                <small class="form-text text-muted" id="status-notes-hint">
                    Please provide details about this status update. This helps track job progress and any issues encountered.
                </small>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="app.closeStatusImageModal()">Back</button>
                <button class="btn btn-primary" onclick="app.confirmStatusChange()">Confirm Status Change</button>
            </div>
        </div>
    </div>

    <!-- Bill Attachment Modal -->
    <div class="modal" id="bill-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attach Bill to Job</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bill-job-id">
                <div class="form-group">
                    <label>Bill Description</label>
                    <input type="text" class="form-control" id="bill-description" placeholder="e.g., Transportation charges, Packing materials, Labor costs" required>
                </div>
                <div class="form-group">
                    <label>Bill Amount (AED)</label>
                    <input type="number" class="form-control" id="bill-amount" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Upload Bill Document/Image</label>
                    <input type="file" class="form-control" id="bill-file" accept="image/*,.pdf" required>
                    <small class="form-text text-muted">Accepted formats: Images (JPG, PNG) or PDF</small>
                    <div class="image-preview" id="bill-preview"></div>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea class="form-control" id="bill-notes" rows="3" placeholder="Additional notes about this bill..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeBillModal()">Cancel</button>
                <button class="btn btn-primary" id="submit-bill-btn" onclick="try { app.submitBill(); } catch(e) { alert('Error: ' + e.message); console.error(e); }">Attach Bill</button>
            </div>
        </div>
    </div>

    <!-- Job Completion Modal -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-modal-content">
            <h3>Complete Job</h3>
            <div class="completion-section">
                <h4>Client Satisfaction Rating</h4>
                <div class="star-rating" id="satisfaction-rating">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
                <p id="rating-text">Please rate your satisfaction</p>
            </div>
            
            <div class="completion-section">
                <h4>Client Signature</h4>
                <div class="signature-pad-container">
                    <canvas id="signature-pad" class="signature-pad" width="500" height="200"></canvas>
                    <div class="signature-controls">
                        <button class="btn btn-secondary btn-sm" onclick="app.clearSignature()">Clear</button>
                        <button class="btn btn-primary btn-sm" onclick="app.saveSignature()">Save Signature</button>
                    </div>
                    <img id="signature-preview" class="signature-preview" style="display: none;">
                </div>
            </div>

            <div class="completion-section">
                <h4>Tip Amount</h4>
                <div class="form-group">
                    <label>Tip Amount (AED)</label>
                    <input type="number" class="form-control" id="completion-tip-amount" min="0" step="0.01" placeholder="Enter tip amount (optional)">
                </div>
            </div>

            <div class="completion-section">
                <h4>Boxes Information</h4>
                <div class="form-group">
                    <label>Were boxes collected?</label>
                    <select class="form-control" id="boxes-collected" onchange="app.toggleBoxesCount()">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group" id="boxes-count-group" style="display: none;">
                    <label>Number of boxes collected</label>
                    <input type="number" class="form-control" id="boxes-count" min="0" placeholder="Enter number of boxes">
                </div>
            </div>

            <div class="completion-section">
                <h4>Completion Notes</h4>
                <textarea id="completion-notes" class="form-control" rows="3" placeholder="Any additional notes about the job completion..."></textarea>
            </div>

            <input type="hidden" id="completion-job-id">

            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="app.closeCompletionModal()">Back</button>
                <button class="btn btn-success" onclick="app.submitJobCompletion()">Submit for Approval</button>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div class="modal" id="job-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Job Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="job-details-body">
                <!-- Job details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-job-details">Close</button>
            </div>
        </div>
    </div>

    <!-- Supervisor Details Modal -->
    <div class="modal" id="supervisor-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Supervisor Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="supervisor-details-body">
                <!-- Supervisor details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-supervisor-details">Close</button>
            </div>
        </div>
    </div>

    <!-- Team Leader Details Modal -->
    <div class="modal" id="teamleader-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Team Leader Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="teamleader-details-body">
                <!-- Team Leader details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-teamleader-details">Close</button>
            </div>
        </div>
    </div>

    <!-- Staff Details Modal -->
    <div class="modal" id="staff-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Staff Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="staff-details-body">
                <!-- Staff details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-staff-details">Close</button>
            </div>
        </div>
    </div>

    <!-- Job Completion Modal -->
    <div class="modal" id="job-completion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Complete Job</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="job-completion-form">
                    <input type="hidden" id="completion-job-id">
                    <div class="form-group">
                        <label>Client Satisfaction</label>
                        <select class="form-control" id="client-satisfaction" required>
                            <option value="">Select Satisfaction Level</option>
                            <option value="very-satisfied">Very Satisfied</option>
                            <option value="satisfied">Satisfied</option>
                            <option value="neutral">Neutral</option>
                            <option value="dissatisfied">Dissatisfied</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tip Amount (AED)</label>
                        <input type="number" class="form-control" id="tip-amount" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Client Comments</label>
                        <textarea class="form-control" id="client-comments" rows="3" placeholder="Any feedback from the client..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-completion">Cancel</button>
                <button class="btn btn-success" id="submit-completion">Submit for Approval</button>
            </div>
        </div>
    </div>

    <!-- Job Approval Modal -->
    <div class="modal" id="job-approval-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Approve Job Completion</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="approval-details">
                <!-- Approval details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-approval">Cancel</button>
                <button class="btn btn-success" id="approve-job">Approve Completion</button>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div class="modal" id="edit-job-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Job</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-job-form">
                    <input type="hidden" id="edit-job-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Moving Date</label>
                            <input type="date" class="form-control" id="edit-job-date" required>
                        </div>
                        <div class="form-group">
                            <label>Moving Time</label>
                            <input type="time" class="form-control" id="edit-job-time" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" class="form-control" id="edit-client-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="edit-client-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="edit-client-email" required>
                        </div>
                        <div class="form-group">
                            <label>Apartment Size</label>
                            <select class="form-control" id="edit-apartment-size" required onchange="app.handleEditApartmentSizeChange()">
                                <option value="">Select Size</option>
                                <option value="small">Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="edit-apartment-size-custom-group" style="display: none;">
                            <label>Custom Apartment Size</label>
                            <input type="text" class="form-control" id="edit-apartment-size-custom" placeholder="E.g., 4 Bedroom Villa, Studio, Penthouse">
                        </div>
                        <div class="form-group">
                            <label>Moving From</label>
                            <input type="text" class="form-control" id="edit-move-from" required>
                        </div>
                        <div class="form-group">
                            <label>Moving To</label>
                            <input type="text" class="form-control" id="edit-move-to" required>
                        </div>
                        <div class="form-group">
                            <label>Assign Team Leader</label>
                            <select class="form-control" id="edit-team-leader-assign">
                                <option value="">Select Team Leader</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assign Staff</label>
                            <select class="form-control" id="edit-assign-staff" multiple>
                                <option value="">Select Staff</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="edit-job-status">
                            <option value="assigned">Assigned</option>
                            <option value="arrived">Arrived at 1st Location</option>
                            <option value="packing-start">Packing Start</option>
                            <option value="first-location-completed">1st Location Completed</option>
                            <option value="arrived-second-location">Arrived at 2nd Location</option>
                            <option value="unpacking-start">Unpacking Start</option>
                            <option value="waiting-approval">Waiting Approval</option>
                            <option value="completed">Completed</option>
                            <option value="delayed">Delayed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-job">Cancel</button>
                <button class="btn btn-primary" id="update-job">Update Job</button>
            </div>
        </div>
    </div>

    <!-- Edit Supervisor Modal -->
    <div class="modal" id="edit-supervisor-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Supervisor</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-supervisor-form">
                    <input type="hidden" id="edit-supervisor-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="edit-supervisor-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="edit-supervisor-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="edit-supervisor-email" required>
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" class="form-control" id="edit-supervisor-designation" required>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="edit-supervisor-username" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-control" id="edit-supervisor-password">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-supervisor">Cancel</button>
                <button class="btn btn-primary" id="update-supervisor">Update Supervisor</button>
            </div>
        </div>
    </div>

    <!-- Edit Team Leader Modal -->
    <div class="modal" id="edit-teamleader-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Team Leader</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-teamleader-form">
                    <input type="hidden" id="edit-teamleader-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="edit-teamleader-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="edit-teamleader-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="edit-teamleader-email" required>
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" class="form-control" id="edit-teamleader-designation" required>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="edit-teamleader-username" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-control" id="edit-teamleader-password">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-teamleader">Cancel</button>
                <button class="btn btn-primary" id="update-teamleader">Update Team Leader</button>
            </div>
        </div>
    </div>

    <!-- Edit Staff Modal -->
    <div class="modal" id="edit-staff-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Staff</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-staff-form">
                    <input type="hidden" id="edit-staff-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="edit-staff-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="edit-staff-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="edit-staff-email" required>
                        </div>
                        <div class="form-group" id="edit-staff-designation-group">
                            <label>Designation</label>
                            <select class="form-control" id="edit-staff-designation" required>
                                <option value="">Select Designation</option>
                                <option value="Packer">Packer</option>
                                <option value="Loader">Loader</option>
                                <option value="Driver">Driver</option>
                                <option value="HandyMan">HandyMan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="edit-staff-username" required>
                        </div>
                        <div class="form-group">
                            <label>Team Leader</label>
                            <select class="form-control" id="edit-staff-teamleader">
                                <option value="">Select Team Leader</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-control" id="edit-staff-password">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-staff">Cancel</button>
                <button class="btn btn-primary" id="update-staff">Update Staff</button>
            </div>
        </div>
    </div>

    <!-- Add Supervisor Modal -->
    <div class="modal" id="add-supervisor-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Supervisor</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-supervisor-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="new-supervisor-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="new-supervisor-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="new-supervisor-email" required>
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" class="form-control" id="new-supervisor-designation" required>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="new-supervisor-username" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="new-supervisor-password" required>
                        </div>
                                <div class="form-group">
                                    <label>Emirates ID Front</label>
                                    <input type="file" class="form-control" id="new-supervisor-emirates-front" accept="image/*">
                                    <div class="image-preview" id="supervisor-emirates-front-preview"></div>
                                </div>
                                <div class="form-group">
                                    <label>Emirates ID Back</label>
                                    <input type="file" class="form-control" id="new-supervisor-emirates-back" accept="image/*">
                                    <div class="image-preview" id="supervisor-emirates-back-preview"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-add-supervisor">Cancel</button>
                <button class="btn btn-primary" id="save-supervisor">Add Supervisor</button>
            </div>
        </div>
    </div>

    <!-- Add Team Leader Modal -->
    <div class="modal" id="add-teamleader-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Team Leader</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-teamleader-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="new-teamleader-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="new-teamleader-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="new-teamleader-email" required>
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" class="form-control" id="new-teamleader-designation" required>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="new-teamleader-username" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="new-teamleader-password" required>
                        </div>
                        <div class="form-group">
                            <label>Emirates ID Front</label>
                            <input type="file" class="form-control" id="new-teamleader-emirates-front" accept="image/*">
                            <div class="image-preview" id="teamleader-emirates-front-preview"></div>
                        </div>
                        <div class="form-group">
                            <label>Emirates ID Back</label>
                            <input type="file" class="form-control" id="new-teamleader-emirates-back" accept="image/*">
                            <div class="image-preview" id="teamleader-emirates-back-preview"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-add-teamleader">Cancel</button>
                <button class="btn btn-primary" id="save-teamleader">Add Team Leader</button>
            </div>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div class="modal" id="add-staff-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Staff</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-staff-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-control" id="new-staff-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="new-staff-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="new-staff-email" required>
                        </div>
                        <div class="form-group" id="new-staff-designation-group">
                            <label>Designation</label>
                            <select class="form-control" id="new-staff-designation" required>
                                <option value="">Select Designation</option>
                                <option value="Packer">Packer</option>
                                <option value="Loader">Loader</option>
                                <option value="Driver">Driver</option>
                                <option value="HandyMan">HandyMan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" id="new-staff-username" required>
                        </div>
                        <div class="form-group">
                            <label>Team Leader</label>
                            <select class="form-control" id="new-staff-teamleader">
                                <option value="">Select Team Leader</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="new-staff-password" required>
                        </div>
                        <div class="form-group">
                            <label>Emirates ID Front</label>
                            <input type="file" class="form-control" id="new-staff-emirates-front" accept="image/*">
                            <div class="image-preview" id="staff-emirates-front-preview"></div>
                        </div>
                        <div class="form-group">
                            <label>Emirates ID Back</label>
                            <input type="file" class="form-control" id="new-staff-emirates-back" accept="image/*">
                            <div class="image-preview" id="staff-emirates-back-preview"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-add-staff">Cancel</button>
                <button class="btn btn-primary" id="save-staff">Add Staff</button>
            </div>
            </div>
        </div>
    </div>

    <!-- Create Survey Modal -->
    <div class="modal" id="add-survey-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Survey</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-survey-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" class="form-control" id="new-survey-client-name" required>
                        </div>
                        <div class="form-group">
                            <label>Client Number</label>
                            <input type="tel" class="form-control" id="new-survey-client-number" required>
                        </div>
                        <div class="form-group">
                            <label>Location/Address</label>
                            <input type="text" class="form-control" id="new-survey-location" required>
                        </div>
                        <div class="form-group">
                            <label>Apartment Size</label>
                            <input type="text" class="form-control" id="new-survey-apartment-size" placeholder="E.g., Studio, 1BR, 3BR, 4BR Villa" required>
                        </div>
                        <div class="form-group">
                            <label>Survey Date</label>
                            <input type="date" class="form-control" id="new-survey-date" required>
                        </div>
                        <div class="form-group">
                            <label>Survey Time</label>
                            <input type="time" class="form-control" id="new-survey-time" required>
                        </div>
                        <div class="form-group">
                            <label>Assign To</label>
                            <select class="form-control" id="new-survey-assigned-to" required>
                                <option value="">Select Person</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-add-survey">Cancel</button>
                <button class="btn btn-primary" id="save-survey">Create Survey</button>
            </div>
        </div>
    </div>

    <!-- Complete Survey Modal - Packing List Form -->
    <div class="modal" id="complete-survey-modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Packing List - Complete Survey</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="complete-survey-form">
                    <input type="hidden" id="complete-survey-id">
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <h4 style="margin:0 0 10px;">Survey Details</h4>
                        <div id="survey-details-preview"></div>
                    </div>

                    <!-- Customer & Move Details Section -->
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <h4 style="margin:0 0 15px;">Customer & Move Details</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" class="form-control" id="pl-company-name">
                            </div>
                            <div class="form-group">
                                <label>Person Name *</label>
                                <input type="text" class="form-control" id="pl-person-name" required>
                            </div>
                            <div class="form-group">
                                <label>Mobile No. *</label>
                                <input type="tel" class="form-control" id="pl-mobile" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="pl-email">
                            </div>
                            <div class="form-group">
                                <label>Source</label>
                                <input type="text" class="form-control" id="pl-source">
                            </div>
                            <div class="form-group">
                                <label>Service Type</label>
                                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-top:8px;">
                                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="pl-type-cargo" value="Cargo"> Cargo</label>
                                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="pl-type-commercial" value="Commercial"> Commercial</label>
                                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="pl-type-local" value="Local"> Local</label>
                                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="pl-type-international" value="International"> International</label>
                                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="pl-type-storage" value="Storage"> Storage</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Origin Address</label>
                                <input type="text" class="form-control" id="pl-origin">
                                <div style="display:flex; gap:10px; margin-top:8px;">
                                    <input type="date" class="form-control" id="pl-origin-date" style="flex:1;">
                                    <input type="time" class="form-control" id="pl-origin-time" style="flex:1;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Destination Address</label>
                                <input type="text" class="form-control" id="pl-destination">
                                <div style="display:flex; gap:10px; margin-top:8px;">
                                    <input type="date" class="form-control" id="pl-dest-date" style="flex:1;">
                                    <input type="time" class="form-control" id="pl-dest-time" style="flex:1;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table Section -->
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                            <h4 style="margin:0;">Items List</h4>
                            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                <input type="text" id="packing-list-search" placeholder="Search items..." class="form-control" style="min-width:200px; max-width:300px;" onkeyup="app.filterPackingListItems()">
                                <button type="button" class="btn btn-sm btn-primary" id="add-custom-item-btn" onclick="app.showAddCustomItemModal()">Add Custom Item</button>
                            </div>
                        </div>
                        <div class="table-responsive" id="packing-list-table-wrapper" style="overflow-x:auto; overflow-y:auto; max-height:400px; -webkit-overflow-scrolling:touch;">
                            <table class="table" id="packing-list-items-table" style="font-size:13px; min-width:600px; width:100%;">
                                <thead>
                                    <tr>
                                        <th style="width:200px; min-width:200px; white-space:nowrap;">Items</th>
                                        <th style="width:80px; min-width:80px; white-space:nowrap;">CBM</th>
                                        <th style="width:100px; min-width:100px; white-space:nowrap;">Nos. of Pcs</th>
                                        <th style="width:100px; min-width:100px; white-space:nowrap;">Total CBM</th>
                                        <th style="width:100px; min-width:100px; white-space:nowrap;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="packing-list-items-tbody">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mobile-scroll-hint" id="packing-list-scroll-hint" style="display: none; text-align: center; padding: 8px; color: #64748b; font-size: 12px; background: #f8fafc; border-radius: 4px; margin-top: 8px;">
                            ‚Üê Swipe horizontally to see all columns ‚Üí
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <h4 style="margin:0 0 15px;">Totals</h4>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="form-group">
                                <label>Total Curtains/Blinds</label>
                                <input type="number" class="form-control" id="pl-total-curtains" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Total Wall Fixtures</label>
                                <input type="number" class="form-control" id="pl-total-fixtures" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>BLDG. PERMIT</label>
                                <input type="text" class="form-control" id="pl-permit">
                            </div>
                            <div class="form-group">
                                <label>Total Boxes</label>
                                <input type="number" class="form-control" id="pl-total-boxes" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Total Packages</label>
                                <input type="number" class="form-control" id="pl-total-packages" min="0" value="0" readonly>
                            </div>
                            <div class="form-group">
                                <label>Commodity</label>
                                <input type="text" class="form-control" id="pl-commodity">
                            </div>
                            <div class="form-group">
                                <label>Total Value of Goods</label>
                                <input type="number" class="form-control" id="pl-total-value" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Total Working Days</label>
                                <input type="number" class="form-control" id="pl-working-days" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>No. of Trips</label>
                                <input type="number" class="form-control" id="pl-trips" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Total CBM</label>
                                <input type="number" class="form-control" id="pl-total-cbm" min="0" step="0.01" value="0" readonly>
                            </div>
                            <div class="form-group">
                                <label>Estimated KG</label>
                                <input type="number" class="form-control" id="pl-estimated-kg" min="0" step="0.01" value="0" readonly>
                            </div>
                            <div class="form-group">
                                <label>Amount of the Move</label>
                                <input type="number" class="form-control" id="pl-amount" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Images, Comments, Signatures Section -->
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <h4 style="margin:0 0 15px;">Additional Information</h4>
                        <div class="form-group">
                            <label>Upload Apartment Images</label>
                            <input type="file" class="form-control" id="survey-images" accept="image/*" multiple>
                            <div class="image-preview" id="survey-images-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>
                        </div>
                        <div class="form-group">
                            <label>Comments/Notes</label>
                            <textarea class="form-control" id="survey-comments" rows="4" placeholder="Add any comments or notes about the apartment, items, condition, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Client Instructions</label>
                            <textarea class="form-control" id="survey-client-instructions" rows="4" placeholder="Any special instructions or requirements from the client"></textarea>
                        </div>
                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); margin-top:15px;">
                            <div class="form-group">
                                <label>Estimator Name</label>
                                <input type="text" class="form-control" id="pl-estimator">
                            </div>
                            <div class="form-group">
                                <label>Stamp/Seal</label>
                                <input type="file" class="form-control" id="pl-stamp" accept="image/*">
                                <div id="pl-stamp-preview" style="margin-top:10px;"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:15px;">
                            <label>Terms & Conditions</label>
                            <textarea class="form-control" id="pl-terms" rows="3" placeholder="Terms and conditions..."></textarea>
                        </div>
                    </div>

                    <!-- Signatures Section -->
                    <div class="card" style="margin-bottom: 20px; padding: 15px;">
                        <h4 style="margin:0 0 15px;">Signatures</h4>
                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="form-group">
                                <label>Customer Signature</label>
                                <canvas id="pl-customer-signature" width="400" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair; background:#fff;"></canvas>
                                <div style="margin-top:10px;">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="app.clearSignature('pl-customer-signature')">Clear</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>MoveIt Signature</label>
                                <canvas id="pl-moveit-signature" width="400" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair; background:#fff;"></canvas>
                                <div style="margin-top:10px;">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="app.clearSignature('pl-moveit-signature')">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-complete-survey">Cancel</button>
                <button class="btn btn-primary" id="submit-survey">Submit Packing List</button>
            </div>
        </div>
    </div>

    <!-- Add Custom Item Modal -->
    <div class="modal" id="add-custom-item-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Add Custom Item</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-custom-item-form">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" class="form-control" id="custom-item-name" required>
                    </div>
                    <div class="form-group">
                        <label>CBM (Cubic Meter) *</label>
                        <input type="number" class="form-control" id="custom-item-cbm" step="0.01" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-custom-item">Cancel</button>
                <button class="btn btn-primary" id="save-custom-item">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Survey Details Modal -->
    <div class="modal" id="survey-details-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Survey Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="survey-details-body">
                <!-- Survey details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-survey-details">Close</button>
                <button class="btn btn-primary" id="download-survey-report">Download Report</button>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div class="modal" id="templates-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Job Templates</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="templates-management">
                    <div class="template-form">
                        <h4>Create New Template</h4>
                        <form id="template-form">
                            <div class="form-group">
                                <label>Template Name</label>
                                <input type="text" class="form-control" id="template-name" required>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control" id="template-description" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Apartment Size</label>
                                <select class="form-control" id="template-apartment-size">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estimated Duration (hours)</label>
                                <input type="number" class="form-control" id="template-duration" min="1" max="24">
                            </div>
                            <div class="form-group">
                                <label>Required Staff Count</label>
                                <input type="number" class="form-control" id="template-staff-count" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>Special Requirements</label>
                                <textarea class="form-control" id="template-requirements" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Template</button>
                        </form>
                    </div>
                    <div class="templates-list">
                        <h4>Existing Templates</h4>
                        <div id="templates-list-content">
                            <!-- Templates will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete implementation with all view buttons working
        class MoveIt247 {
            constructor() {
                this.currentUser = null;
                this.currentRole = null;
                this.data = this.initializeData();
                this.itemCatalog = []; // Will be loaded when needed
                this.initializeApp();
            }

            initializeData() {
                // Clear old localStorage data to prevent conflicts with backend data
                localStorage.removeItem('moveit_jobs');
                localStorage.removeItem('moveit_supervisors');
                localStorage.removeItem('moveit_teamleaders');
                localStorage.removeItem('moveit_staff');
                localStorage.removeItem('moveit_users');
                
                // Start with completely empty data - all data will be fetched from backend
                return {
                    jobs: [],
                    supervisors: [],
                    teamLeaders: [],
                    staff: [],
                    surveys: [],
                    users: {},
                    templates: JSON.parse(localStorage.getItem('moveit_templates')) || this.getDefaultTemplates()
                };
            }

            getDefaultTemplates() {
                return [
                    {
                        id: 1,
                        name: "Small Apartment Move",
                        description: "Standard move for 1-2 bedroom apartment",
                        apartmentSize: "small",
                        duration: 4,
                        staffCount: 2,
                        requirements: "Basic moving equipment, small truck"
                    },
                    {
                        id: 2,
                        name: "Medium Apartment Move",
                        description: "Standard move for 2-3 bedroom apartment",
                        apartmentSize: "medium",
                        duration: 6,
                        staffCount: 3,
                        requirements: "Standard moving equipment, medium truck"
                    },
                    {
                        id: 3,
                        name: "Large Apartment Move",
                        description: "Standard move for 3+ bedroom apartment",
                        apartmentSize: "large",
                        duration: 8,
                        staffCount: 4,
                        requirements: "Full moving equipment, large truck"
                    },
                    {
                        id: 4,
                        name: "Office Relocation",
                        description: "Commercial office move with furniture",
                        apartmentSize: "custom",
                        duration: 12,
                        staffCount: 6,
                        requirements: "Commercial equipment, multiple trucks, disassembly tools"
                    }
                ];
            }

            initializeApp() {
                this.setupUsers();
                this.setupEventListeners();
                this.setupImagePreviews();
                this.checkAutoLogin();
                this.initKeyboardShortcuts();
                this.initTooltips();
                this.initAutoSave();
                this.setupGlobalErrorHandling();
                this.createMobileAppHeader();
                this.loadBrandingLogo();
            }
            
            loadBrandingLogo() {
                // Load branding logo for sidebar and mobile header
                fetch('/api/branding').then(r=>r.json()).then(b=>{
                    if (b && b.logoUrl) {
                        const url = this.getImageUrl(b.logoUrl);
                        localStorage.setItem('moveit_logo_url', b.logoUrl);
                        // Update sidebar logo
                        const sidebarLogo = document.getElementById('sidebar-logo');
                        if (sidebarLogo) {
                            sidebarLogo.src = url;
                            sidebarLogo.style.display = 'block';
                        }
                        // Update mobile header logo if it exists
                        const appLogo = document.getElementById('app-logo');
                        if (appLogo) {
                            appLogo.src = url;
                            appLogo.style.display = 'block';
                        }
                    }
                }).catch(()=>{});
            }

            setupGlobalErrorHandling() {
                // Handle unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled promise rejection:', event.reason);
                    this.showNotification('An unexpected error occurred', 'error');
                    event.preventDefault();
                });

                // Handle global errors
                window.addEventListener('error', (event) => {
                    console.error('Global error:', event.error);
                    this.showNotification('An unexpected error occurred', 'error');
                });
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            isValidPhone(phone) {
                const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
                return phoneRegex.test(phone);
            }

            setupUsers() {
                // Add supervisors to users
                this.data.supervisors.forEach(sup => {
                    this.data.users[sup.username] = {
                        username: sup.username,
                        password: sup.password,
                        role: 'supervisor',
                        name: sup.name
                    };
                });

                // Add team leaders to users
                this.data.teamLeaders.forEach(tl => {
                    this.data.users[tl.username] = {
                        username: tl.username,
                        password: tl.password,
                        role: 'teamleader',
                        name: tl.name
                    };
                });

                // Add staff to users (for profile access)
                this.data.staff.forEach(staff => {
                    this.data.users[staff.username] = {
                        username: staff.username,
                        password: staff.password,
                        role: 'staff',
                        name: staff.name
                    };
                });
            }

            checkAutoLogin() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        this.loginUser(user);
                    } catch (e) {
                        localStorage.removeItem('currentUser');
                    }
                }
                // Always load data for dropdowns
                this.loadDataForDropdowns();
            }

            loadDataForDropdowns() {
                // Load team leaders and staff for dropdowns
                this.fetchPeople('teamLeaders');
                this.fetchPeople('staff');
                // Load users for profile updates
                this.fetchUsers();
            }

            async fetchUsers() {
                try {
                    const response = await fetch('/api/users');
                    if (!response.ok) throw new Error('Failed to fetch users');
                    const data = await response.json();
                    this.data.users = data;
                    console.log('Users loaded:', this.data.users);
                } catch (error) {
                    console.error('Error fetching users:', error);
                }
            }

            async fetchNotifications() {
                if (!this.currentUser || this.currentRole !== 'teamleader') return;
                
                try {
                    const response = await fetch(`/api/notifications?to=${encodeURIComponent(this.currentUser.name)}`);
                    if (!response.ok) throw new Error('Failed to fetch notifications');
                    const notifications = await response.json();
                    
                    // Display unread notification count
                    const unreadCount = notifications.filter(n => !n.read).length;
                    if (unreadCount > 0) {
                        console.log(`Team leader has ${unreadCount} unread notifications`);
                        // You can add a badge or notification indicator here
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                }
            }

            refreshAllData(force = false) {
                // Only refresh if data is stale (older than 30 seconds) or forced
                const now = Date.now();
                if (force || !this.lastDataRefresh || (now - this.lastDataRefresh) > 30000) {
                    this.showLoading('Loading data...');
                    Promise.all([
                        this.fetchJobs(),
                        this.fetchPeople('supervisors'),
                        this.fetchPeople('teamLeaders'),
                        this.fetchPeople('staff')
                    ]).then(() => {
                        this.loadDashboard();
                        this.hideLoading();
                    }).catch(() => {
                        this.hideLoading();
                    });
                    this.lastDataRefresh = now;
                }
            }

            // Force refresh method for when data changes
            forceRefresh() {
                this.refreshAllData(true);
            }

            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'k') {
                        e.preventDefault();
                        const searchInput = document.querySelector('input[type="text"]');
                        if (searchInput) searchInput.focus();
                    }
                    if (e.key === 'Escape') {
                        this.hideModals();
                    }
                });
            }

            initTooltips() {
                // Simple tooltip implementation
                document.addEventListener('mouseover', (e) => {
                    if (e.target.dataset.tooltip) {
                        this.showTooltip(e);
                    }
                });
                document.addEventListener('mouseout', (e) => {
                    if (e.target.dataset.tooltip) {
                        this.hideTooltip(e);
                    }
                });
            }

            initAutoSave() {
                // Auto-save functionality for forms
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    const inputs = form.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        input.addEventListener('input', this.debounce(() => {
                            this.autoSave();
                        }, 1000));
                    });
                });
            }

            showTooltip(e) {
                // Simple tooltip implementation
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = e.target.dataset.tooltip;
                tooltip.style.cssText = `
                    position: absolute;
                    background: #333;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(tooltip);
                
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
            }

            hideTooltip(e) {
                const tooltip = document.querySelector('.tooltip');
                if (tooltip) tooltip.remove();
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            autoSave() {
                // Placeholder for auto-save functionality
                console.log('Auto-saving...');
            }

            handleApartmentSizeChange() {
                const select = document.getElementById('apartment-size');
                const customGroup = document.getElementById('apartment-size-custom-group');
                const customInput = document.getElementById('apartment-size-custom');
                
                if (select && customGroup && customInput) {
                    if (select.value === 'custom') {
                        customGroup.style.display = 'block';
                        customInput.required = true;
                        customInput.focus();
                    } else {
                        customGroup.style.display = 'none';
                        customInput.required = false;
                        customInput.value = '';
                    }
                }
            }

            handleEditApartmentSizeChange() {
                const select = document.getElementById('edit-apartment-size');
                const customGroup = document.getElementById('edit-apartment-size-custom-group');
                const customInput = document.getElementById('edit-apartment-size-custom');
                
                if (select && customGroup && customInput) {
                    if (select.value === 'custom') {
                        customGroup.style.display = 'block';
                        customInput.required = true;
                        customInput.focus();
                    } else {
                        customGroup.style.display = 'none';
                        customInput.required = false;
                        customInput.value = '';
                    }
                }
            }

            addJob(e) {
                e.preventDefault();
                console.log('Add Job form submitted');
                
                // Get form data
                const jobData = {
                    date: document.getElementById('job-date').value,
                    time: document.getElementById('job-time').value,
                    clientName: document.getElementById('client-name').value,
                    clientPhone: document.getElementById('client-phone').value,
                    clientEmail: document.getElementById('client-email').value,
                    apartmentSize: document.getElementById('apartment-size').value,
                    apartmentSizeCustom: document.getElementById('apartment-size-custom').value,
                    moveFrom: document.getElementById('move-from').value,
                    moveTo: document.getElementById('move-to').value,
                    teamLeader: document.getElementById('team-leader-assign').value,
                    assignedStaff: Array.from(document.getElementById('assign-staff').selectedOptions).map(option => option.value).filter(v => v),
                    moveOutPermit: document.getElementById('move-out-permit').dataset.uploadUrl || '',
                    moveInPermit: document.getElementById('move-in-permit').dataset.uploadUrl || '',
                    itemImages: document.getElementById('item-images').dataset.uploadUrls ? JSON.parse(document.getElementById('item-images').dataset.uploadUrls) : [],
                    instructions: document.getElementById('job-instructions')?.value || ''
                };

                console.log('Job form data:', jobData);

                // Validate required fields
                if (!jobData.clientName || !jobData.date || !jobData.time || !jobData.moveFrom || !jobData.moveTo) {
                    console.error('Validation failed - missing required fields:', {
                        clientName: jobData.clientName,
                        date: jobData.date,
                        time: jobData.time,
                        moveFrom: jobData.moveFrom,
                        moveTo: jobData.moveTo
                    });
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Keep apartment size fields separate (don't overwrite apartmentSize with custom text)
                // apartmentSize will remain as 'custom' and apartmentSizeCustom will have the actual text

                // Upload files and get URLs
                this.uploadJobFiles(jobData).then((uploadedData) => {
                    // Merge uploaded data
                    Object.assign(jobData, uploadedData);
                    
                    // Create job via API
                    console.log('Sending job data to API:', jobData);
                    fetch('/api/jobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(jobData)
                    })
                    .then(res => {
                        console.log('Job API response status:', res.status);
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        return res.json();
                    })
                    .then(newJob => {
                        console.log('Job added successfully:', newJob);
                        this.showNotification('Job added successfully!', 'success');
                        this.hideModals();
                        this.resetJobForm();
                        // Only reload jobs, not the entire dashboard
                        this.loadJobs();
                    })
                    .catch(err => {
                        console.error('Error adding job:', err);
                        this.showNotification('Error adding job: ' + err.message, 'error');
                    });
                })
                .catch(err => {
                    console.error('Error uploading files:', err);
                    this.showNotification('Error uploading files', 'error');
                });
            }

            uploadJobFiles(jobData) {
                const uploadPromises = [];
                
                // Upload move out permit
                const moveOutFile = document.getElementById('move-out-permit').files[0];
                if (moveOutFile) {
                    uploadPromises.push(
                        this.uploadFile(moveOutFile).then(url => ({ moveOutPermit: url }))
                    );
                }
                
                // Upload move in permit
                const moveInFile = document.getElementById('move-in-permit').files[0];
                if (moveInFile) {
                    uploadPromises.push(
                        this.uploadFile(moveInFile).then(url => ({ moveInPermit: url }))
                    );
                }
                
                // Upload item images
                const itemFiles = Array.from(document.getElementById('item-images').files || []);
                if (itemFiles.length > 0) {
                    uploadPromises.push(
                        Promise.all(itemFiles.map(file => this.uploadFile(file)))
                            .then(urls => ({ itemImages: urls.filter(url => url) }))
                    );
                }
                
                return Promise.all(uploadPromises).then(results => {
                    return results.reduce((acc, result) => Object.assign(acc, result), {});
                });
            }

            resetJobForm() {
                document.getElementById('add-job-form').reset();
                const customGroup = document.getElementById('apartment-size-custom-group');
                const customInput = document.getElementById('apartment-size-custom');
                if (customGroup) customGroup.style.display = 'none';
                if (customInput) {
                    customInput.required = false;
                    customInput.value = '';
                }
                // Clear image previews
                ['move-out-preview', 'move-in-preview', 'item-images-preview'].forEach(id => {
                    const preview = document.getElementById(id);
                    if (preview) preview.innerHTML = '';
                });
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    max-width: 300px;
                    word-wrap: break-word;
                    animation: slideInRight 0.3s ease;
                `;
                notification.textContent = message;
                
                // Add animation styles
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            }

            handleLogout() {
                // Stop location tracking if active
                this.stopLocationTracking();
                
                // Stop notification polling
                if (this.notificationPollingInterval) {
                    clearInterval(this.notificationPollingInterval);
                    this.notificationPollingInterval = null;
                }
                
                this.currentUser = null;
                this.currentRole = null;
                localStorage.removeItem('currentUser');
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                this.showNotification('Logged out successfully', 'info');
            }

            formatRole(role) {
                const roleMap = {
                    'admin': 'Administrator',
                    'supervisor': 'Supervisor', 
                    'teamleader': 'Team Leader',
                    'staff': 'Staff'
                };
                return roleMap[role] || role;
            }

            formatStatus(status) {
                const statusMap = {
                    'assigned': 'Assigned',
                    'arrived': 'Arrived at 1st Location',
                    'packing-start': 'Packing Start',
                    'first-location-completed': '1st Location Completed',
                    'arrived-second-location': 'Arrived at 2nd Location',
                    'unpacking-start': 'Unpacking Start',
                    'waiting-approval': 'Waiting Approval',
                    'completed': 'Completed',
                    'delayed': 'Delayed',
                    'pending': 'Pending'
                };
                return statusMap[status] || status;
            }

            formatSectionName(section) {
                const sectionMap = {
                    'dashboard': 'Dashboard',
                    'jobs': 'Jobs',
                    'supervisors': 'Supervisors',
                    'teamleaders': 'Team Leaders',
                    'staff': 'Staff',
                    'job-history': 'Job History',
                    'live-tracking': 'Live Tracking',
                    'pending-approval': 'Pending Approval',
                    'reports': 'Reports',
                    'notifications': 'Notifications',
                    'profile': 'Profile',
                    'surveys': 'Surveys'
                };
                return sectionMap[section] || section;
            }

            saveData() {
                // Save data to backend
                console.log('Saving data to backend...');
                console.log('Users data being saved:', this.data.users);
                
                const requests = [];
                if (Array.isArray(this.data.jobs)) {
                    requests.push(fetch('/api/jobs', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.jobs)
                    }).then(res => {
                        console.log('Jobs save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save jobs');
                    }).catch(err => console.error('Failed to save jobs:', err)));
                }
                if (Array.isArray(this.data.supervisors)) {
                    requests.push(fetch('/api/supervisors', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.supervisors)
                    }).then(res => {
                        console.log('Supervisors save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save supervisors');
                    }).catch(err => console.error('Failed to save supervisors:', err)));
                }
                if (Array.isArray(this.data.teamLeaders)) {
                    requests.push(fetch('/api/teamleaders', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.teamLeaders)
                    }).then(res => {
                        console.log('Team leaders save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save team leaders');
                    }).catch(err => console.error('Failed to save team leaders:', err)));
                }
                if (Array.isArray(this.data.staff)) {
                    requests.push(fetch('/api/staff', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.staff)
                    }).then(res => {
                        console.log('Staff save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save staff');
                    }).catch(err => console.error('Failed to save staff:', err)));
                }
                if (Array.isArray(this.data.surveys)) {
                    requests.push(fetch('/api/surveys', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.surveys)
                    }).then(res => {
                        console.log('Surveys save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save surveys');
                    }).catch(err => console.error('Failed to save surveys:', err)));
                }
                if (this.data.users && typeof this.data.users === 'object') {
                    requests.push(fetch('/api/users', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data.users)
                    }).then(res => {
                        console.log('Users save response:', res.status);
                        if (!res.ok) throw new Error('Failed to save users');
                        return res.json();
                    }).then(data => {
                        console.log('Users save success:', data);
                    }).catch(err => console.error('Failed to save users:', err)));
                }

                return Promise.all(requests)
                .then(() => {
                    // Single success toast for any aggregated updates
                    this.showNotification('Changes saved successfully', 'success');
                })
                .catch((err) => {
                    // Already logged per-request; surface a single error toast
                    this.showNotification('Failed to save some changes', 'error');
                    throw err;
                });
            }

            setupEventListeners() {
                // Login is handled by onclick on the button

                // Navigation
                document.querySelectorAll('.sidebar-menu li a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = e.currentTarget.getAttribute('href');
                        if (!href || href === '#') return; // allow logout button handler to run separately
                        this.navigateTo(href.substring(1));
                    });
                });

                // Handle back/forward and manual hash changes
                window.addEventListener('hashchange', () => {
                    const section = location.hash ? location.hash.substring(1) : 'dashboard';
                    this.navigateTo(section);
                });

                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());

                // Job completion
                const submitCompletion = document.getElementById('submit-completion');
                if (submitCompletion) submitCompletion.addEventListener('click', () => this.submitJobCompletion());
                
                const approveJob = document.getElementById('approve-job');
                if (approveJob) approveJob.addEventListener('click', () => this.approveJobCompletion());
                
                const cancelApproval = document.getElementById('cancel-approval');
                if (cancelApproval) cancelApproval.addEventListener('click', () => this.hideModals());

                // Job editing
                document.getElementById('update-job').addEventListener('click', () => this.updateJob());

                // Supervisor editing
                document.getElementById('update-supervisor').addEventListener('click', () => this.updateSupervisor());
                document.getElementById('cancel-edit-supervisor').addEventListener('click', () => this.hideModals());

                // Team Leader editing
                document.getElementById('update-teamleader').addEventListener('click', () => this.updateTeamLeader());
                document.getElementById('cancel-edit-teamleader').addEventListener('click', () => this.hideModals());

                // Staff editing
                document.getElementById('update-staff').addEventListener('click', () => this.updateStaff());
                document.getElementById('cancel-edit-staff').addEventListener('click', () => this.hideModals());

                // Add buttons
                document.getElementById('add-supervisor-btn').addEventListener('click', () => this.showAddSupervisorModal());
                document.getElementById('add-teamleader-btn').addEventListener('click', () => this.showAddTeamLeaderModal());
                document.getElementById('add-staff-btn').addEventListener('click', () => this.showAddStaffModal());

                // Save new items
                document.getElementById('save-supervisor').addEventListener('click', () => this.addSupervisor());
                document.getElementById('save-teamleader').addEventListener('click', () => this.addTeamLeader());
                document.getElementById('save-staff').addEventListener('click', () => this.addStaff());
                document.getElementById('save-survey').addEventListener('click', () => this.addSurvey());
                
                // Survey buttons
                document.getElementById('add-survey-btn')?.addEventListener('click', () => this.showAddSurveyModal());
                document.getElementById('cancel-add-survey')?.addEventListener('click', () => this.hideModals());
                document.getElementById('submit-survey')?.addEventListener('click', () => this.completeSurvey());
                document.getElementById('cancel-complete-survey')?.addEventListener('click', () => this.hideModals());
                document.getElementById('close-survey-details')?.addEventListener('click', () => this.hideModals());
                
                // Packing List Custom Item Modal
                document.getElementById('save-custom-item')?.addEventListener('click', () => this.addCustomItem());
                document.getElementById('cancel-custom-item')?.addEventListener('click', () => this.hideModals());
                
                // Stamp preview
                document.getElementById('pl-stamp')?.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const preview = document.getElementById('pl-stamp-preview');
                            preview.innerHTML = `<img src="${event.target.result}" style="max-width:200px; max-height:200px; border:1px solid #ddd; border-radius:4px;">`;
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });

                // Template form
                document.getElementById('template-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveTemplate();
                });

                // Cancel add buttons
                document.getElementById('cancel-add-supervisor').addEventListener('click', () => this.hideModals());
                document.getElementById('cancel-add-teamleader').addEventListener('click', () => this.hideModals());
                document.getElementById('cancel-add-staff').addEventListener('click', () => this.hideModals());

                // Cancel buttons
                document.querySelectorAll('.btn-secondary').forEach(btn => {
                    if (!btn.id.includes('edit') && !btn.id.includes('add')) {
                        btn.addEventListener('click', () => this.hideModals());
                    }
                });

                // Close buttons
                document.querySelectorAll('.close').forEach(btn => {
                    btn.addEventListener('click', () => this.hideModals());
                });

                // Forms
                document.getElementById('add-job-form')?.addEventListener('submit', (e) => this.addJob(e));
                document.getElementById('profile-form')?.addEventListener('submit', (e) => this.updateProfile(e));
                document.getElementById('send-notification-form')?.addEventListener('submit', (e) => this.sendCustomNotification(e));
                
                // Send to all checkbox toggle
                document.getElementById('send-to-all-checkbox')?.addEventListener('change', (e) => this.toggleSendToAll(e));
                
                // Update job button
                document.getElementById('update-job')?.addEventListener('click', () => this.updateJob());

                // Window click to close modals
                window.addEventListener('click', (e) => {
                    if (e.target && e.target.classList && e.target.classList.contains('modal')) {
                        this.hideModals();
                    }
                    if (e.target && e.target.classList && e.target.classList.contains('image-modal')) {
                        this.hideImageModal();
                    }
                });
            }

            // Mobile (APK) header to avoid content under status bar and provide brand space
            createMobileAppHeader() {
                const isMobile = window.innerWidth <= 768;
                if (!isMobile) return;

                // Styles for header and safe-area
                const styleId = 'mobile-app-header-style';
                if (!document.getElementById(styleId)) {
                    const s = document.createElement('style');
                    s.id = styleId;
                    s.innerHTML = `
                        .mobile-app-header{position:sticky;top:0;left:0;right:0;height:56px;padding-top:env(safe-area-inset-top);background:#0f172a;color:#e2e8f0;display:flex;align-items:center;gap:10px;padding-left:16px;z-index:1000;border-bottom:1px solid #1f2937}
                        .mobile-app-header img{height:28px;width:auto;display:block}
                        .mobile-app-header .title{font-weight:800;letter-spacing:.2px}
                        body{padding-top:calc(env(safe-area-inset-top));}
                    `;
                    document.head.appendChild(s);
                }

                if (document.querySelector('.mobile-app-header')) return;

                const header = document.createElement('div');
                header.className = 'mobile-app-header';
                header.innerHTML = `
                    <img id="app-logo" alt="MoveIt 24/7" onerror="this.style.display='none'" />
                    <div class="title">MoveIt 24/7</div>
                `;
                const storedLogo = localStorage.getItem('moveit_logo_url');
                if (storedLogo) {
                    const img = header.querySelector('#app-logo');
                    img.src = this.getImageUrl(storedLogo);
                } else {
                    // Try backend branding
                    fetch('/api/branding').then(r=>r.json()).then(b=>{
                        if (b && b.logoUrl) {
                            localStorage.setItem('moveit_logo_url', b.logoUrl);
                            const img = header.querySelector('#app-logo');
                            img.src = this.getImageUrl(b.logoUrl);
                        }
                    }).catch(()=>{});
                }
                document.body.prepend(header);
            }

            setupImagePreviews() {
                // Setup image preview for file inputs
                const setupPreview = (inputId, previewId) => {
                    const input = document.getElementById(inputId);
                    const preview = document.getElementById(previewId);
                    
                    if (input && preview) {
                        // Remove existing event listeners to prevent duplicates
                        input.removeEventListener('change', input._imagePreviewHandler);
                        
                        input._imagePreviewHandler = async (e) => {
                            preview.innerHTML = '';
                            const files = Array.from(e.target.files || []);
                            const uploadedUrls = [];

                            for (const file of files) {
                                if (!file.type.startsWith('image/')) continue;

                                // Local preview
                                    const reader = new FileReader();
                                reader.onload = function(evt) {
                                        const previewItem = document.createElement('div');
                                        previewItem.className = 'preview-item';
                                        const img = document.createElement('img');
                                    img.src = evt.target.result;
                                        img.style.width = '100%';
                                        img.style.height = '100%';
                                        img.style.objectFit = 'cover';
                                        previewItem.appendChild(img);
                                        preview.appendChild(previewItem);
                                };
                                    reader.readAsDataURL(file);

                                // Upload to backend and collect URL
                                try {
                                    const url = await this.uploadFile(file);
                                    if (url) uploadedUrls.push(url);
                                } catch (err) {
                                    console.error('Upload failed:', err);
                                }
                            }

                            // Store URLs on the input element for later save
                            if (input.multiple) {
                                input.dataset.uploadUrls = JSON.stringify(uploadedUrls);
                            } else {
                                input.dataset.uploadUrl = uploadedUrls[0] || '';
                            }
                        };
                        
                        input.addEventListener('change', input._imagePreviewHandler);
                    }
                };

                // Job image previews
                setupPreview('move-out-permit', 'move-out-preview');
                setupPreview('move-in-permit', 'move-in-preview');
                setupPreview('item-images', 'item-images-preview');
                setupPreview('profile-image', 'profile-image-preview');
                setupPreview('emirates-id-front', 'emirates-front-preview');
                setupPreview('emirates-id-back', 'emirates-back-preview');
                
                // Emirates ID previews for supervisors
                setupPreview('new-supervisor-emirates-front', 'supervisor-emirates-front-preview');
                setupPreview('new-supervisor-emirates-back', 'supervisor-emirates-back-preview');
                
                // Emirates ID previews for team leaders
                setupPreview('new-teamleader-emirates-front', 'teamleader-emirates-front-preview');
                setupPreview('new-teamleader-emirates-back', 'teamleader-emirates-back-preview');
                
                // Emirates ID previews for staff
                setupPreview('new-staff-emirates-front', 'staff-emirates-front-preview');
                setupPreview('new-staff-emirates-back', 'staff-emirates-back-preview');
                
                // Survey image preview (multiple files)
                const surveyImagesInput = document.getElementById('survey-images');
                const surveyImagesPreview = document.getElementById('survey-images-preview');
                if (surveyImagesInput && surveyImagesPreview) {
                    surveyImagesInput.addEventListener('change', function() {
                        surveyImagesPreview.innerHTML = '';
                        if (this.files && this.files.length > 0) {
                            Array.from(this.files).forEach(file => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imgDiv = document.createElement('div');
                                    imgDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0;';
                                    const img = document.createElement('img');
                                    img.src = e.target.result;
                                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                                    imgDiv.appendChild(img);
                                    surveyImagesPreview.appendChild(imgDiv);
                                };
                                reader.readAsDataURL(file);
                            });
                        }
                    });
                }
            }

            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!res.ok) throw new Error('Upload failed');
                const data = await res.json();
                // Ensure absolute path for images served by backend
                const url = typeof data.url === 'string' ? data.url : '';
                return url.startsWith('http') ? url : `${location.origin}${url}`;
            }

            handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                console.log('Attempting login with username:', username);
                
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                })
                .then(async res => {
                    console.log('Login response status:', res.status);
                    if (!res.ok) {
                        const errorData = await res.json();
                        console.error('Login error:', errorData);
                        throw new Error(errorData.error || 'Invalid credentials');
                    }
                    return res.json();
                })
                .then(({ user }) => {
                    console.log('Login successful, user:', user);
                    this.loginUser(user);
                    // refresh data from backend after login
                    this.refreshAllData();
                })
                .catch((error) => {
                    console.error('Login failed:', error);
                    this.showNotification(error.message || 'Invalid credentials', 'error');
                });
                return false;
            }

            loginUser(user) {
                console.log('loginUser called with:', user);
                const normalizedRole = (user.role || '').toLowerCase();
                // Persist normalized role to avoid 'teamLeader' vs 'teamleader' mismatches
                user.role = normalizedRole;
                this.currentUser = user;
                this.currentRole = normalizedRole;
                console.log('Current role set to:', this.currentRole);
                localStorage.setItem('currentUser', JSON.stringify(user));

                // Update user info display
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-role').textContent = this.formatRole(user.role);
                document.getElementById('user-initials').textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('page-title').textContent = 'Dashboard';

                // Update user avatar with role-specific styling
                const avatar = document.getElementById('user-avatar');
                if (avatar) {
                    avatar.className = `user-avatar ${this.currentRole}`;
                }

                console.log('Calling updateMenuForRole...');
                this.updateMenuForRole();
                console.log('Switching to app container...');
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                // Navigate to section from URL hash (or dashboard by default)
                const sectionFromHash = location.hash ? location.hash.substring(1) : 'dashboard';
                console.log('Navigating after login to section:', sectionFromHash);
                this.navigateTo(sectionFromHash);
                this.showNotification(`Welcome back, ${user.name}!`, 'success');
                
                // Initialize location tracking for team leaders (including promoted staff)
                // When staff is promoted (isTeamLeader: true), login sets role to 'teamleader'
                // So promoted staff will automatically get location tracking enabled
                if (user.role === 'teamleader') {
                    this.initializeLocationTracking();
                }
                
                // Request browser notification permission (for all users)
                this.requestNotificationPermission();
                
                // Fetch notifications and update badge
                this.fetchNotifications().then(() => {
                    this.updateNotificationBadge();
                    this.lastNotificationCheck = Date.now();
                });
                
                // Start polling for new notifications (every 10 seconds)
                if (this.notificationPollingInterval) {
                    clearInterval(this.notificationPollingInterval);
                }
                this.notificationPollingInterval = setInterval(() => {
                    this.checkForNewNotifications();
                }, 10000); // Check every 10 seconds
            }

            updateMenuForRole() {
                const role = this.currentRole;
                console.log('updateMenuForRole called, role:', role);
                const supervisorsItem = document.getElementById('supervisors-menu-item');
                const teamLeadersItem = document.getElementById('teamleaders-menu-item');
                const staffItem = document.getElementById('staff-menu-item');
                const surveysItem = document.getElementById('surveys-menu-item');
                const reportsItem = document.getElementById('reports-menu-item');
                const addJobCard = document.getElementById('add-job-card');
                const addSurveyBtn = document.getElementById('add-survey-btn');
                const pendingApprovalItem = document.getElementById('pending-approval-menu-item');
                const jobsMenuItem = document.querySelector('a[href="#jobs"]')?.parentElement;
                const jobHistoryMenuItem = document.querySelector('a[href="#job-history"]')?.parentElement;
                const liveTrackingMenuItem = document.querySelector('a[href="#live-tracking"]')?.parentElement;
                const clearDataBtn = document.getElementById('clear-data-btn');

                // Hide all management items first
                [supervisorsItem, teamLeadersItem, staffItem, surveysItem, reportsItem, pendingApprovalItem, liveTrackingMenuItem].forEach(item => {
                    if (item) item.style.display = 'none';
                });
                
                // Hide add survey button by default
                if (addSurveyBtn) addSurveyBtn.style.display = 'none';
                
                // Hide Clear Data button (only show for admin)
                if (clearDataBtn) clearDataBtn.style.display = 'none';

                // Show based on role
                if (role === 'admin') {
                    console.log('Setting up admin menu...');
                    [supervisorsItem, teamLeadersItem, staffItem, surveysItem, reportsItem, pendingApprovalItem].forEach(item => {
                        if (item) item.style.display = 'block';
                    });
                    if (addJobCard) addJobCard.style.display = 'block';
                    if (addSurveyBtn) addSurveyBtn.style.display = 'block'; // Only admin can create surveys
                    if (jobsMenuItem) jobsMenuItem.style.display = 'block';
                    if (jobHistoryMenuItem) jobHistoryMenuItem.style.display = 'block';
                    if (liveTrackingMenuItem) liveTrackingMenuItem.style.display = 'block'; // Admin sees live tracking
                    if (clearDataBtn) clearDataBtn.style.display = 'block'; // Only admin sees Clear Data button
                } else if (role === 'supervisor') {
                    console.log('Setting up supervisor menu...');
                    [teamLeadersItem, staffItem, surveysItem, pendingApprovalItem].forEach(item => {
                        if (item) item.style.display = 'block';
                    });
                    // Supervisor does NOT see reports (only admin)
                    if (reportsItem) reportsItem.style.display = 'none';
                    if (addJobCard) addJobCard.style.display = 'none';
                    if (addSurveyBtn) addSurveyBtn.style.display = 'none'; // Supervisors can't create surveys
                    if (jobsMenuItem) jobsMenuItem.style.display = 'block';
                    if (jobHistoryMenuItem) jobHistoryMenuItem.style.display = 'block';
                    if (liveTrackingMenuItem) liveTrackingMenuItem.style.display = 'block'; // Supervisor sees live tracking
                } else if (role === 'teamleader') {
                    console.log('Setting up team leader menu...');
                    // Team leaders can see jobs, pending approvals, surveys, and manage their job workflow
                    if (surveysItem) surveysItem.style.display = 'block'; // Team leaders can see assigned surveys
                    if (pendingApprovalItem) {
                        pendingApprovalItem.style.display = 'block';
                        console.log('Showing pending approval menu for team leader');
                    }
                    if (addJobCard) addJobCard.style.display = 'none';
                    if (addSurveyBtn) addSurveyBtn.style.display = 'none'; // Team leaders can't create surveys
                    if (jobsMenuItem) {
                        jobsMenuItem.style.display = 'block';
                        console.log('Showing jobs menu for team leader');
                    }
                    if (jobHistoryMenuItem) {
                        jobHistoryMenuItem.style.display = 'block';
                        console.log('Showing job history menu for team leader');
                    }
                    // fetch notifications for this TL
                    console.log('Fetching notifications for team leader...');
                    if (typeof this.fetchNotifications === 'function') {
                        this.fetchNotifications();
                    } else {
                        console.log('fetchNotifications not available, skipping...');
                    }
                } else if (role === 'staff') {
                    console.log('Setting up staff menu...');
                    // Staff can see their assigned jobs, profile, and job history (including jobs they completed as promoted team leader)
                    if (addJobCard) addJobCard.style.display = 'none';
                    if (jobsMenuItem) jobsMenuItem.style.display = 'block';
                    if (jobHistoryMenuItem) jobHistoryMenuItem.style.display = 'block'; // Staff can see their completed jobs
                }
                console.log('Menu setup complete for role:', role);
            }

            async navigateTo(section) {
                console.log(`üîÑ Navigating to: ${section}`);
                // Keep URL in sync and close mobile sidebar overlay
                if (location.hash !== `#${section}`) {
                    location.hash = `#${section}`;
                }
                if (document && document.body && document.body.classList) {
                    document.body.classList.remove('sidebar-open');
                }
                
                // Update active menu - with error handling
                document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
                const menuLink = document.querySelector(`a[href="#${section}"]`);
                if (menuLink && menuLink.parentElement) {
                    menuLink.parentElement.classList.add('active');
                    console.log(`‚úÖ Menu item activated: ${section}`);
                } else {
                    console.warn(`‚ö†Ô∏è Menu link not found for: ${section}`);
                }

                // Update content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const contentElement = document.getElementById(`${section}-content`);
                if (contentElement) {
                    contentElement.classList.add('active');
                }
                document.getElementById('page-title').textContent = this.formatSectionName(section);

                // Load section data (only if needed)
                switch(section) {
                    case 'dashboard': 
                        await this.loadDashboard(); 
                        break;
                    case 'jobs': 
                        this.loadJobs(); 
                        break;
                    case 'supervisors': 
                        this.loadSupervisors(); 
                        break;
                    case 'teamleaders': 
                        this.loadTeamLeaders(); 
                        break;
                    case 'staff': 
                        this.loadStaff(); 
                        break;
                    case 'surveys': 
                        this.loadSurveys(); 
                        break;
                    case 'job-history': 
                        this.loadJobHistory(); 
                        break;
                    case 'live-tracking': 
                        this.loadLiveTracking(); 
                        break;
                    case 'pending-approval': 
                        this.loadPendingApproval(); 
                        break;
                    case 'reports': 
                        this.loadReports(); 
                        break;
                    case 'notifications': 
                        this.loadNotifications(); 
                        break;
                    case 'profile': 
                        this.loadProfile(); 
                        break;
                }
            }

            // Data loading methods
            async loadDashboard() {
                console.log('loadDashboard called');
                
                // Only refresh if data is stale
                if (!this.lastDataRefresh || (Date.now() - this.lastDataRefresh) > 30000) {
                    await this.refreshAllData();
                }
                
                // Safety check: ensure data is loaded
                if (!this.data || !this.data.jobs || !Array.isArray(this.data.jobs)) {
                    console.error('Dashboard data not loaded properly');
                    return;
                }
                
                // Check for delayed jobs and update their status
                await this.checkDelayedJobs();
                
                let jobs = this.data.jobs;
                console.log('Dashboard loading with', jobs.length, 'jobs');
                
                // Filter jobs based on role
                if (this.currentRole === 'teamleader') {
                    jobs = jobs.filter(j => j.teamLeader === this.currentUser.name);
                } else if (this.currentRole === 'staff') {
                    jobs = jobs.filter(j => j.assignedStaff && j.assignedStaff.includes(this.currentUser.name));
                }
                
                const ongoing = jobs.filter(j => ['assigned', 'arrived', 'packing-start', 'first-location-completed', 'arrived-second-location', 'unpacking-start'].includes(j.status)).length;
                const future = jobs.filter(j => j.status === 'pending').length;
                const completed = jobs.filter(j => j.status === 'completed').length;
                const pendingApproval = jobs.filter(j => j.status === 'waiting-approval').length;
                const totalStaff = this.data.staff.length;
                const totalSupervisors = this.data.supervisors.length;
                const totalTeamLeaders = this.data.teamLeaders.length;
                const totalJobs = jobs.length;
                const completionRate = totalJobs > 0 ? Math.round((completed / totalJobs) * 100) : 0;
                const delayedJobs = jobs.filter(j => j.status === 'delayed').length;

                // Update welcome section
                const welcomeSection = document.getElementById('welcome-section');
                if (welcomeSection && this.currentUser) {
                    const currentTime = new Date();
                    const greeting = this.getGreeting(currentTime);
                    const userName = this.currentUser.name;
                    
                    document.getElementById('welcome-greeting').textContent = `${greeting}, ${userName}!`;
                    welcomeSection.style.display = 'block';
                    welcomeSection.classList.add('fade-in-up');
                }

                // Animate stat cards
                const statCards = document.querySelectorAll('.stat-card');
                statCards.forEach((card, index) => {
                    card.classList.add('stagger-item');
                    card.style.animationDelay = `${index * 0.1}s`;
                });

                document.getElementById('ongoing-jobs').textContent = ongoing;
                document.getElementById('future-jobs').textContent = future;
                document.getElementById('completed-jobs').textContent = completed;
                document.getElementById('pending-approval-count').textContent = pendingApproval;
                document.getElementById('total-staff').textContent = totalStaff;
                document.getElementById('total-supervisors').textContent = totalSupervisors;
                document.getElementById('total-teamleaders').textContent = totalTeamLeaders;
                document.getElementById('completion-rate').textContent = completionRate + '%';
                document.getElementById('delayed-jobs').textContent = delayedJobs;

                this.populateRecentJobs();
                this.renderCharts();
            }

            getGreeting(time) {
                const hour = time.getHours();
                if (hour < 12) return 'Good Morning';
                if (hour < 17) return 'Good Afternoon';
                return 'Good Evening';
            }

            renderCharts() {
                this.renderJobStatusChart();
                this.renderMonthlyTrendsChart();
            }

            renderJobStatusChart() {
                const ctx = document.getElementById('jobStatusChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (this.jobStatusChartInstance) {
                    this.jobStatusChartInstance.destroy();
                }

                const statusCounts = {
                    'assigned': 0,
                    'arrived': 0,
                    'packing-start': 0,
                    'first-location-completed': 0,
                    'arrived-second-location': 0,
                    'unpacking-start': 0,
                    'waiting-approval': 0,
                    'completed': 0,
                    'delayed': 0
                };

                this.data.jobs.forEach(job => {
                    statusCounts[job.status] = (statusCounts[job.status] || 0) + 1;
                });

                this.jobStatusChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Assigned', 'Arrived at 1st', 'Packing Start', '1st Complete', 'Arrived at 2nd', 'Unpacking Start', 'Waiting Approval', 'Completed', 'Delayed'],
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: [
                                '#3498db', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c', '#34495e', '#e67e22', '#27ae60', '#95a5a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            renderMonthlyTrendsChart() {
                const ctx = document.getElementById('monthlyTrendsChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (this.monthlyTrendsChartInstance) {
                    this.monthlyTrendsChartInstance.destroy();
                }

                const last6Months = [];
                const jobCounts = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const monthYear = date.toISOString().substring(0, 7);
                    last6Months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                    
                    const monthJobs = this.data.jobs.filter(job => 
                        job.date && job.date.startsWith(monthYear)
                    ).length;
                    jobCounts.push(monthJobs);
                }

                this.monthlyTrendsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last6Months,
                        datasets: [{
                            label: 'Jobs',
                            data: jobCounts,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            async loadJobs() {
                console.log('loadJobs called');
                try {
                    // Always fetch latest from backend
                    await this.fetchJobs();
                    console.log('Jobs fetched successfully, jobs count:', this.data.jobs?.length || 0);
                    
                    // Populate tables
                    this.populateCurrentJobs();
                    // this.populateTemplatesGrid(); // Function removed - not needed
                    
                    // Always populate dropdowns when loading jobs
                    await this.fetchPeople('teamLeaders');
                    console.log('Team leaders fetched:', this.data.teamLeaders?.length || 0);
                this.populateTeamLeadersDropdown();
                    
                    await this.fetchPeople('staff');
                    console.log('Staff fetched:', this.data.staff?.length || 0);
                this.populateStaffDropdown();
                    
                    console.log('loadJobs completed successfully');
                } catch (error) {
                    console.error('Error loading jobs:', error);
                    this.showNotification('Failed to load jobs', 'error');
                }
            }

            loadPendingApproval() {
                // Always fetch latest from backend
                this.fetchJobs().then(() => this.populatePendingApprovalTable());
            }

            loadJobHistory() {
                console.log('loadJobHistory called');
                // Always fetch latest from backend
                this.fetchJobs().then(() => {
                    const tbody = document.querySelector('#job-history-table tbody');
                    if (!tbody) {
                        console.error('Job history table not found!');
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    
                    if (!this.data || !this.data.jobs) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                        return;
                    }
                    
                    // Filter completed jobs based on role
                    let completedJobs = this.data.jobs.filter(job => job.status === 'completed');
                    
                    // Team leaders see only their completed jobs
                    if (this.currentRole === 'teamleader') {
                        completedJobs = completedJobs.filter(job => job.teamLeader === this.currentUser.name);
                    } 
                    // Staff see jobs they completed as team leader (even if now demoted) OR jobs they were assigned to as staff
                    else if (this.currentRole === 'staff') {
                        completedJobs = completedJobs.filter(job => 
                            job.teamLeader === this.currentUser.name || // Jobs they completed as promoted team leader
                            (job.assignedStaff && job.assignedStaff.includes(this.currentUser.name)) // Jobs they were assigned to as staff
                        );
                    }
                    // Admin and supervisor see all completed jobs
                    
                    console.log(`Found ${completedJobs.length} completed jobs for ${this.currentRole}`);
                    
                    if (completedJobs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No completed jobs</td></tr>';
                        return;
                    }
                    
                    completedJobs.forEach(job => {
                        const row = document.createElement('tr');
                        const completedDate = job.completionData ? new Date(job.completionData.completedAt).toLocaleDateString() : job.date;
                        const rating = job.completionData && job.completionData.rating ? `${'‚≠ê'.repeat(job.completionData.rating)}` : 'N/A';
                        const tipAmount = job.completionData && job.completionData.tipAmount ? `AED ${job.completionData.tipAmount}` : 'No tip';
                        
                        row.innerHTML = `
                            <td style="font-weight:bold;">#${job.id}</td>
                            <td>${job.clientName}</td>
                            <td>${job.date}</td>
                            <td>${completedDate}</td>
                            <td>${job.teamLeader || 'N/A'}</td>
                            <td>${rating}</td>
                            <td style="color: #27ae60; font-weight:bold;">${tipAmount}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="app.showJobDetails(${job.id})" style="margin:2px;">VIEW</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            }

            // Live Tracking Functions
            async loadLiveTracking() {
                console.log('loadLiveTracking called');
                
                // Initialize map if not already done
                if (!this.trackingMap) {
                    this.initializeTrackingMap();
                }
                
                // Load tracking data
                await this.refreshTracking();
                
                // Start auto-refresh (every 10 seconds)
                if (this.trackingInterval) {
                    clearInterval(this.trackingInterval);
                }
                this.trackingInterval = setInterval(() => {
                    this.refreshTracking(true); // Silent refresh
                }, 10000);
            }

            initializeTrackingMap() {
                const mapContainer = document.getElementById('tracking-map');
                if (!mapContainer) return;

                // Default center (Dubai, UAE)
                const center = [25.2048, 55.2708];
                
                // Initialize Leaflet map
                this.trackingMap = L.map('tracking-map').setView(center, 12);
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.trackingMap);
                
                this.trackingMarkers = {};
                console.log('Tracking map initialized');
            }

            async refreshTracking(silent = false) {
                if (!silent) {
                    const refreshBtn = document.getElementById('refresh-tracking-btn');
                    if (refreshBtn) {
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                        refreshBtn.disabled = true;
                    }
                }
                
                try {
                    // Fetch team leaders and staff (to get promoted staff)
                    await this.fetchPeople('teamLeaders');
                    await this.fetchPeople('staff');
                    
                    // Fetch tracking data from backend (includes promoted staff)
                    const response = await fetch('/api/tracking');
                    const trackingData = await response.json();
                    
                    // Update map and list
                    this.updateTrackingMap(trackingData);
                    this.updateTrackingList(trackingData);
                    
                    if (!silent) {
                        this.showNotification('Tracking data refreshed', 'success');
                    }
                } catch (error) {
                    console.error('Error refreshing tracking:', error);
                    if (!silent) {
                        this.showNotification('Failed to refresh tracking', 'error');
                    }
                } finally {
                    if (!silent) {
                        const refreshBtn = document.getElementById('refresh-tracking-btn');
                        if (refreshBtn) {
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                            refreshBtn.disabled = false;
                        }
                    }
                }
            }

            updateTrackingMap(trackingData) {
                if (!this.trackingMap) return;
                
                // Clear existing markers
                Object.values(this.trackingMarkers).forEach(marker => marker.remove());
                this.trackingMarkers = {};
                
                // Add markers for each team leader (including promoted staff)
                trackingData.forEach(item => {
                    if (item.latitude && item.longitude) {
                        const promotedLabel = item.isPromoted ? ' <span style="color: #f59e0b; font-size: 0.85em;">(Promoted)</span>' : '';
                        const marker = L.marker([item.latitude, item.longitude])
                            .bindPopup(`
                                <div style="text-align: center;">
                                    <strong>${item.name}${promotedLabel}</strong><br>
                                    <small>${item.lastUpdate}</small><br>
                                    ${item.currentJob ? `<span style="color: #48bb78;">üìç On Job #${item.currentJob}</span>` : '<span style="color: #a0aec0;">No active job</span>'}
                                </div>
                            `)
                            .addTo(this.trackingMap);
                        
                        this.trackingMarkers[item.username] = marker;
                    }
                });
                
                // Fit map to show all markers
                if (Object.keys(this.trackingMarkers).length > 0) {
                    const group = L.featureGroup(Object.values(this.trackingMarkers));
                    this.trackingMap.fitBounds(group.getBounds().pad(0.1));
                }
            }

            updateTrackingList(trackingData) {
                const container = document.getElementById('tracking-list-container');
                if (!container) return;
                
                if (trackingData.length === 0) {
                    container.innerHTML = '<p style="text-align:center;padding:20px;color:#a0aec0;">No team leaders available</p>';
                    return;
                }
                
                container.innerHTML = trackingData.map(item => {
                    const isOnline = item.latitude && item.longitude;
                    const initials = item.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    
                    return `
                        <div class="tracking-card ${isOnline ? 'active' : ''}" onclick="app.focusOnTeamLeader('${item.username}')">
                            <div class="tracking-card-header">
                                <div class="tracking-avatar">${initials}</div>
                                <div class="tracking-info">
                                    <h4>${item.name}</h4>
                                    <p>${item.currentJob ? `On Job #${item.currentJob}` : 'No active job'}</p>
                                </div>
                            </div>
                            <div class="tracking-meta">
                                <span class="tracking-time">${item.lastUpdate || 'Never'}</span>
                                <span class="tracking-badge ${isOnline ? 'online' : 'offline'}">
                                    ${isOnline ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            focusOnTeamLeader(username) {
                const marker = this.trackingMarkers[username];
                if (marker) {
                    this.trackingMap.setView(marker.getLatLng(), 15);
                    marker.openPopup();
                }
            }

            // Notification Functions
            async loadNotifications() {
                console.log('üì¢ Loading notifications...');
                
                // Show send notification form only for admin
                const sendNotificationCard = document.getElementById('send-notification-card');
                if (sendNotificationCard) {
                    sendNotificationCard.style.display = this.currentRole === 'admin' ? 'block' : 'none';
                }
                
                // Populate recipient dropdown if admin
                if (this.currentRole === 'admin') {
                    this.populateNotificationRecipients();
                }
                
                // Fetch and display notifications
                await this.fetchNotifications();
                this.renderNotifications();
                
                // Update badge
                this.updateNotificationBadge();
            }

            async fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) throw new Error('Failed to fetch notifications');
                    const data = await response.json();
                    this.data.notifications = data || [];
                    console.log(`‚úÖ Fetched ${this.data.notifications.length} notifications`);
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                    this.data.notifications = [];
                }
            }

            async checkForNewNotifications() {
                try {
                    // Fetch latest notifications
                    const response = await fetch('/api/notifications');
                    if (!response.ok) return;
                    const allNotifications = await response.json();
                    
                    // Filter for current user
                    const userNotifications = allNotifications.filter(notif => {
                        if (this.currentRole === 'admin') return false; // Don't show popups for admin
                        return notif.recipient === this.currentUser.username || notif.recipient === 'all';
                    });
                    
                    // Find new unread notifications
                    const oldNotificationIds = this.data.notifications.map(n => n.id);
                    const newNotifications = userNotifications.filter(notif => {
                        const isNew = !oldNotificationIds.includes(notif.id);
                        const isUnread = !notif.readBy || !notif.readBy.includes(this.currentUser.username);
                        return isNew && isUnread;
                    });
                    
                    // Update stored notifications
                    this.data.notifications = allNotifications;
                    
                    // Show popup for each new notification
                    newNotifications.forEach(notif => {
                        console.log(`üîî New notification received: ${notif.title}`);
                        this.showBrowserNotification(notif.title, notif.message);
                    });
                    
                    // Update badge
                    if (newNotifications.length > 0) {
                        this.updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error checking for new notifications:', error);
                }
            }

            renderNotifications() {
                const container = document.getElementById('notifications-list');
                if (!container) {
                    console.error('‚ùå notifications-list container not found!');
                    return;
                }
                
                console.log('üîç Rendering notifications...');
                console.log('Current user:', this.currentUser.username);
                console.log('Current role:', this.currentRole);
                console.log('Total notifications:', this.data.notifications.length);
                console.log('All notifications:', JSON.stringify(this.data.notifications, null, 2));
                
                // Filter notifications for current user
                let userNotifications = this.data.notifications.filter(notif => {
                    if (this.currentRole === 'admin') return true; // Admin sees all
                    const matches = notif.recipient === this.currentUser.username || notif.recipient === 'all';
                    console.log(`Notification "${notif.title}" - recipient: ${notif.recipient}, currentUser: ${this.currentUser.username}, matches: ${matches}`);
                    return matches;
                });
                
                console.log(`‚úÖ Filtered to ${userNotifications.length} notifications for ${this.currentUser.username}`);
                
                // Sort by date (newest first)
                userNotifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (userNotifications.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #a0aec0; padding: 40px;">
                            No notifications yet
                            <br><br>
                            <small style="color: #cbd5e0;">Debug: Username: ${this.currentUser.username}, Role: ${this.currentRole}</small>
                        </p>
                    `;
                    return;
                }
                
                container.innerHTML = userNotifications.map(notif => {
                    const isRead = notif.readBy && notif.readBy.includes(this.currentUser.username);
                    const timeAgo = this.getTimeAgo(notif.createdAt);
                    
                    // Admin: Show detailed read status with names
                    let readStatus = '';
                    if (this.currentRole === 'admin') {
                        const readCount = notif.readBy ? notif.readBy.length : 0;
                        const readByList = notif.readBy && notif.readBy.length > 0 
                            ? notif.readBy.join(', ') 
                            : 'Not read yet';
                        
                        readStatus = `
                            <div class="notification-read-status" style="display: flex; flex-direction: column; gap: 4px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-eye" style="color: ${readCount > 0 ? '#48bb78' : '#cbd5e0'};"></i>
                                    <span style="font-weight: 600; color: ${readCount > 0 ? '#48bb78' : '#a0aec0'};">
                                        ${readCount > 0 ? `‚úì Read by ${readCount} ${readCount === 1 ? 'person' : 'people'}` : '‚úó Unread'}
                                    </span>
                                </div>
                                ${readCount > 0 ? `<div style="font-size: 11px; color: #718096; margin-left: 22px;">
                                    <i class="fas fa-users" style="font-size: 10px;"></i> ${readByList}
                                </div>` : ''}
                            </div>
                        `;
                    } else {
                        readStatus = `<div class="notification-read-status">
                            ${isRead ? '<div class="read-indicator"></div> Read' : '<div class="unread-indicator"></div> Unread'}
                        </div>`;
                    }
                    
                    return `
                        <div class="notification-item ${isRead ? '' : 'unread'}" onclick="app.markNotificationAsRead('${notif.id}')">
                            <div class="notification-item-header">
                                <div class="notification-item-title">${notif.title || 'Notification'}</div>
                                <div class="notification-item-time">${timeAgo}</div>
                            </div>
                            <div class="notification-item-body">${notif.message}</div>
                            <div class="notification-item-footer">
                                ${readStatus}
                                ${this.currentRole === 'admin' ? `<small style="color: #a0aec0;">To: ${notif.recipientName || notif.recipient}</small>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateNotificationBadge() {
                const badge = document.getElementById('notification-badge');
                if (!badge) return;
                
                // Count unread notifications for current user
                const unreadCount = this.data.notifications.filter(notif => {
                    if (this.currentRole === 'admin') return false; // Don't show badge for admin
                    const isForUser = notif.recipient === this.currentUser.username || notif.recipient === 'all';
                    const isUnread = !notif.readBy || !notif.readBy.includes(this.currentUser.username);
                    return isForUser && isUnread;
                }).length;
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }

            async markNotificationAsRead(notificationId) {
                console.log('üîî Marking notification as read:', notificationId, 'for user:', this.currentUser.username);
                try {
                    const response = await fetch(`/api/notifications/${notificationId}/read`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: this.currentUser.username })
                    });
                    
                    console.log('üì° Mark as read response:', response.status, response.ok);
                    
                    if (!response.ok) throw new Error('Failed to mark notification as read');
                    
                    // Update local data
                    const notif = this.data.notifications.find(n => String(n.id) === String(notificationId));
                    console.log('üîç Found notification:', notif);
                    
                    if (notif) {
                        if (!notif.readBy) notif.readBy = [];
                        if (!notif.readBy.includes(this.currentUser.username)) {
                            notif.readBy.push(this.currentUser.username);
                            console.log('‚úÖ Added user to readBy:', notif.readBy);
                        } else {
                            console.log('‚ÑπÔ∏è User already in readBy');
                        }
                    } else {
                        console.log('‚ùå Notification not found in local data');
                    }
                    
                    // Re-render
                    console.log('üîÑ Re-rendering notifications...');
                    this.renderNotifications();
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            async markAllNotificationsRead() {
                try {
                    const unreadNotifications = this.data.notifications.filter(notif => {
                        const isForUser = notif.recipient === this.currentUser.username || notif.recipient === 'all';
                        const isUnread = !notif.readBy || !notif.readBy.includes(this.currentUser.username);
                        return isForUser && isUnread;
                    });
                    
                    for (const notif of unreadNotifications) {
                        await this.markNotificationAsRead(notif.id);
                    }
                    
                    this.showNotification('All notifications marked as read', 'success');
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    this.showNotification('Failed to mark notifications as read', 'error');
                }
            }

            populateNotificationRecipients() {
                const supervisorsGroup = document.getElementById('notification-supervisors');
                const teamLeadersGroup = document.getElementById('notification-teamleaders');
                const staffGroup = document.getElementById('notification-staff');
                
                if (!supervisorsGroup || !teamLeadersGroup || !staffGroup) return;
                
                // Clear existing options
                supervisorsGroup.innerHTML = '';
                teamLeadersGroup.innerHTML = '';
                staffGroup.innerHTML = '';
                
                // Populate supervisors
                this.data.supervisors.forEach(sup => {
                    const option = document.createElement('option');
                    option.value = sup.username;
                    option.textContent = sup.name;
                    supervisorsGroup.appendChild(option);
                });
                
                // Populate team leaders
                this.data.teamLeaders.forEach(tl => {
                    const option = document.createElement('option');
                    option.value = tl.username;
                    option.textContent = tl.name;
                    teamLeadersGroup.appendChild(option);
                });
                
                // Populate staff
                this.data.staff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.username;
                    option.textContent = staff.name;
                    staffGroup.appendChild(option);
                });
            }

            toggleSendToAll(e) {
                const isChecked = e.target.checked;
                const recipientGroup = document.getElementById('recipient-group');
                const recipientSelect = document.getElementById('notification-recipient');
                
                if (isChecked) {
                    recipientGroup.style.display = 'none';
                    recipientSelect.required = false;
                    recipientSelect.value = '';
                } else {
                    recipientGroup.style.display = 'block';
                    recipientSelect.required = true;
                }
            }

            async sendCustomNotification(e) {
                e.preventDefault();
                
                const sendToAll = document.getElementById('send-to-all-checkbox').checked;
                const recipient = sendToAll ? 'all' : document.getElementById('notification-recipient').value;
                const title = document.getElementById('notification-title').value;
                const message = document.getElementById('notification-message').value;
                
                if (!recipient || !title || !message) {
                    this.showNotification('Please fill all fields', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/notifications', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipient,
                            title,
                            message,
                            type: 'custom',
                            createdBy: this.currentUser.username
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to send notification');
                    
                    const result = await response.json();
                    if (sendToAll) {
                        this.showNotification(`Notification sent to ${result.count} people!`, 'success');
                    } else {
                        this.showNotification('Notification sent successfully!', 'success');
                    }
                    
                    // Clear form
                    document.getElementById('send-notification-form').reset();
                    document.getElementById('send-to-all-checkbox').checked = false;
                    document.getElementById('recipient-group').style.display = 'block';
                    document.getElementById('notification-recipient').required = true;
                    
                    // Refresh notifications
                    await this.fetchNotifications();
                    this.renderNotifications();
                } catch (error) {
                    console.error('Error sending notification:', error);
                    this.showNotification('Failed to send notification', 'error');
                }
            }

            async requestNotificationPermission() {
                // Check if we're in Capacitor (mobile) environment
                const isCapacitor = window.Capacitor !== undefined;
                const LocalNotifications = isCapacitor && window.Capacitor?.Plugins?.LocalNotifications;
                
                if (LocalNotifications) {
                    // Use Capacitor Local Notifications API (better for mobile)
                    try {
                        const permissionStatus = await LocalNotifications.checkPermissions();
                        console.log('Local Notifications permission status:', permissionStatus);
                        if (permissionStatus.display !== 'granted') {
                            const requestStatus = await LocalNotifications.requestPermissions();
                            console.log('Local Notifications request status:', requestStatus);
                            return requestStatus.display === 'granted';
                        }
                        return true;
                    } catch (error) {
                        console.error('Local Notifications permission request failed:', error);
                        return false;
                    }
                } else if ('Notification' in window) {
                    // Fallback to web Notification API
                    if (Notification.permission === 'granted') {
                        return true;
                    }
                    
                    if (Notification.permission !== 'denied') {
                        const permission = await Notification.requestPermission();
                        return permission === 'granted';
                    }
                } else {
                    console.log('Notifications not supported');
                    return false;
                }
                
                return false;
            }

            async showBrowserNotification(title, message) {
                // Check if we're in Capacitor (mobile) environment
                const isCapacitor = window.Capacitor !== undefined;
                const LocalNotifications = isCapacitor && window.Capacitor?.Plugins?.LocalNotifications;
                
                if (LocalNotifications) {
                    // Use Capacitor Local Notifications API (better for mobile)
                    try {
                        await LocalNotifications.schedule({
                            notifications: [{
                                title: title,
                                body: message,
                                id: Date.now(),
                                schedule: { at: new Date(Date.now() + 1000) }, // Show immediately
                                sound: 'default',
                                attachments: null,
                                actionTypeId: '',
                                extra: null
                            }]
                        });
                        console.log('Local notification shown:', title);
                    } catch (error) {
                        console.error('Failed to show local notification:', error);
                        // Fallback to in-app notification
                        this.showInAppNotification(title, message);
                    }
                } else if ('Notification' in window && Notification.permission === 'granted') {
                    // Fallback to web Notification API
                    const notification = new Notification(title, {
                        body: message,
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        tag: 'moveit247-notification',
                        requireInteraction: false
                    });
                    
                    // Auto-close after 10 seconds
                    setTimeout(() => notification.close(), 10000);
                } else {
                    // Fallback to in-app notification
                    this.showInAppNotification(title, message);
                }
            }

            showInAppNotification(title, message) {
                // Create notification element
                const notificationEl = document.createElement('div');
                notificationEl.className = 'browser-notification';
                notificationEl.innerHTML = `
                    <div class="browser-notification-header">
                        <div class="browser-notification-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="browser-notification-title">${title}</div>
                    </div>
                    <div class="browser-notification-body">${message}</div>
                    <div class="browser-notification-time">Just now</div>
                `;
                
                // Add to page
                document.body.appendChild(notificationEl);
                
                // Update badge
                this.updateNotificationBadge();
                
                // Auto-dismiss after 10 seconds with animation
                setTimeout(() => {
                    notificationEl.classList.add('slide-out');
                    setTimeout(() => notificationEl.remove(), 300);
                }, 10000);
                
                // Click to dismiss
                notificationEl.addEventListener('click', () => {
                    notificationEl.classList.add('slide-out');
                    setTimeout(() => notificationEl.remove(), 300);
                });
            }

            getTimeAgo(timestamp) {
                const now = new Date();
                const then = new Date(timestamp);
                const seconds = Math.floor((now - then) / 1000);
                
                if (seconds < 60) return 'Just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                if (days < 7) return `${days}d ago`;
                const weeks = Math.floor(days / 7);
                if (weeks < 4) return `${weeks}w ago`;
                return then.toLocaleDateString();
            }

            // Location Sharing Functions (for Team Leaders)
            async initializeLocationTracking() {
                console.log('üåç Initializing location tracking for team leader...');
                
                // Check if we're in Capacitor (mobile) environment
                const isCapacitor = window.Capacitor !== undefined;
                const Geolocation = isCapacitor && window.Capacitor?.Plugins?.Geolocation;
                
                // Check if geolocation is supported
                if (!navigator.geolocation && !Geolocation) {
                    console.warn('Geolocation is not supported');
                    this.showNotification('Location services not available', 'error');
                    return;
                }
                
                // Request location permission
                try {
                    // Request permission first (for Capacitor/mobile)
                    if (Geolocation) {
                        try {
                            const permissionStatus = await Geolocation.checkPermissions();
                            console.log('Permission status:', permissionStatus);
                            if (permissionStatus.location !== 'granted') {
                                const requestStatus = await Geolocation.requestPermissions();
                                console.log('Request status:', requestStatus);
                                if (requestStatus.location !== 'granted') {
                                    throw new Error('Location permission denied. Please enable location in app settings.');
                                }
                            }
                        } catch (permError) {
                            console.error('Permission request failed:', permError);
                            throw new Error('Permission request failed: ' + permError.message);
                        }
                    }
                    
                    const position = await this.getCurrentPosition();
                    console.log('‚úÖ Location permission granted, position:', position);
                    
                    // Show location indicator
                    const locationStatus = document.getElementById('location-status');
                    if (locationStatus) {
                        locationStatus.style.display = 'inline-flex';
                        document.getElementById('location-text').textContent = 'Sharing Location';
                    }
                    
                    // Send initial location
                    await this.sendLocation(position.coords.latitude, position.coords.longitude);
                    
                    // Set up periodic location updates (every 30 seconds)
                    this.locationInterval = setInterval(() => {
                        this.updateLocation();
                    }, 30000); // 30 seconds
                    
                    this.showNotification('Location sharing started', 'success');
                } catch (error) {
                    console.error('Location permission denied:', error);
                    this.showNotification('Location permission is required. Please enable in app settings.', 'warning');
                    
                    // Show disabled indicator
                    const locationStatus = document.getElementById('location-status');
                    if (locationStatus) {
                        locationStatus.style.display = 'inline-flex';
                        locationStatus.style.background = 'linear-gradient(135deg, #f56565, #c53030)';
                        document.getElementById('location-text').textContent = 'Location Disabled';
                    }
                }
            }

            async getCurrentPosition() {
                // Check if we're in Capacitor (mobile) environment
                const isCapacitor = window.Capacitor !== undefined;
                const Geolocation = isCapacitor && window.Capacitor?.Plugins?.Geolocation;
                
                if (Geolocation) {
                    // Use Capacitor Geolocation API (better for mobile)
                    try {
                        const position = await Geolocation.getCurrentPosition({
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                        // Capacitor returns position in same format, but ensure compatibility
                        return {
                            coords: {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                altitude: position.coords.altitude || null,
                                altitudeAccuracy: position.coords.altitudeAccuracy || null,
                                heading: position.coords.heading || null,
                                speed: position.coords.speed || null
                            },
                            timestamp: position.timestamp || Date.now()
                        };
                    } catch (error) {
                        console.error('Capacitor Geolocation error:', error);
                        throw error;
                    }
                } else if (navigator.geolocation) {
                    // Fallback to web geolocation API
                    return new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                } else {
                    throw new Error('Geolocation not supported');
                }
            }

            async updateLocation() {
                try {
                    const position = await this.getCurrentPosition();
                    await this.sendLocation(position.coords.latitude, position.coords.longitude);
                    console.log('üìç Location updated');
                } catch (error) {
                    console.error('Error updating location:', error);
                }
            }

            async sendLocation(latitude, longitude) {
                try {
                    const response = await fetch('/api/tracking/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: this.currentUser.username,
                            latitude,
                            longitude,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send location');
                    }
                    
                    console.log('‚úÖ Location sent to server');
                } catch (error) {
                    console.error('Error sending location:', error);
                }
            }

            stopLocationTracking() {
                if (this.locationInterval) {
                    clearInterval(this.locationInterval);
                    this.locationInterval = null;
                }
                
                const locationStatus = document.getElementById('location-status');
                if (locationStatus) {
                    locationStatus.style.display = 'none';
                }
                
                console.log('üõë Location tracking stopped');
            }

            async fetchJobs() {
                try {
                    const response = await fetch('/api/jobs');
                    if (!response.ok) throw new Error('Failed to fetch jobs');
                    const data = await response.json();
                    this.data.jobs = data;
                } catch (error) {
                    console.error('Error fetching jobs:', error);
                    this.showNotification('Failed to load jobs', 'error');
                }
            }

            async checkDelayedJobs() {
                if (!this.data || !this.data.jobs) return;
                
                const now = new Date();
                let updated = false;
                
                for (const job of this.data.jobs) {
                    // Only check jobs that are not completed, cancelled, or already delayed
                    if (['completed', 'cancelled', 'delayed', 'waiting-approval'].includes(job.status)) {
                        continue;
                    }
                    
                    // Check if job date/time has passed
                    if (job.date && job.time) {
                        const jobDateTime = new Date(`${job.date}T${job.time}`);
                        if (now > jobDateTime) {
                            console.log(`Job #${job.id} is delayed. Expected: ${jobDateTime}, Now: ${now}`);
                            // Update job status to delayed
                            try {
                                const response = await fetch(`/api/jobs/${job.id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ ...job, status: 'delayed' })
                                });
                                if (response.ok) {
                                    job.status = 'delayed';
                                    updated = true;
                                }
                            } catch (error) {
                                console.error(`Error updating job #${job.id} to delayed:`, error);
                            }
                        }
                    }
                }
                
                if (updated) {
                    console.log('Some jobs were updated to delayed status');
                }
            }

            loadReports() {
                console.log('loadReports called');
                this.fetchJobs().then(() => {
                    this.populateTeamLeaderPerformanceReport();
                    this.populateStaffPerformanceReport();
                    this.populateJobsSummaryReport();
                    this.populateRevenueReport();
                });
            }

            populateTeamLeaderPerformanceReport() {
                const tbody = document.querySelector('#teamleader-performance-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                // Get all team leaders (regular + promoted staff)
                const allTeamLeaders = [];
                
                // Add regular team leaders
                if (this.data.teamLeaders && this.data.teamLeaders.length > 0) {
                    this.data.teamLeaders.forEach(tl => {
                        allTeamLeaders.push({ name: tl.name, isPromoted: false });
                    });
                }
                
                // Add promoted staff members
                if (this.data.staff && this.data.staff.length > 0) {
                    this.data.staff.forEach(staff => {
                        if (staff.isTeamLeader === true) {
                            allTeamLeaders.push({ name: staff.name, isPromoted: true });
                        }
                    });
                }

                if (allTeamLeaders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No team leaders available</td></tr>';
                    return;
                }

                allTeamLeaders.forEach(tlInfo => {
                    const tlJobs = this.data.jobs.filter(j => j.teamLeader === tlInfo.name);
                    const completed = tlJobs.filter(j => j.status === 'completed').length;
                    const pending = tlJobs.filter(j => !['completed', 'delayed'].includes(j.status)).length;
                    const delayed = tlJobs.filter(j => j.status === 'delayed').length;
                    const total = tlJobs.length;
                    const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    // Calculate average rating
                    const completedWithRating = tlJobs.filter(j => j.status === 'completed' && j.completionData && j.completionData.rating);
                    const avgRating = completedWithRating.length > 0
                        ? (completedWithRating.reduce((sum, j) => sum + j.completionData.rating, 0) / completedWithRating.length).toFixed(1)
                        : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight:bold;">${tlInfo.name}${tlInfo.isPromoted ? ' <span style="color:#10b981; font-size:0.85em;">(Promoted)</span>' : ''}</td>
                        <td>${total}</td>
                        <td>${completed}</td>
                        <td>${pending}</td>
                        <td>${delayed}</td>
                        <td>${completionRate}%</td>
                        <td>${avgRating !== 'N/A' ? '‚≠ê ' + avgRating : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            populateStaffPerformanceReport() {
                const tbody = document.querySelector('#staff-performance-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (!this.data.staff || this.data.staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No staff available</td></tr>';
                    return;
                }

                this.data.staff.forEach(staff => {
                    const staffJobs = this.data.jobs.filter(j => j.assignedStaff && j.assignedStaff.includes(staff.name));
                    const completed = staffJobs.filter(j => j.status === 'completed').length;
                    const total = staffJobs.length;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight:bold;">${staff.name}</td>
                        <td>${staff.designation}</td>
                        <td>${staff.teamLeader || 'N/A'}</td>
                        <td>${total}</td>
                        <td>${completed}</td>
                        <td><span class="status-badge status-${staff.status}">${this.formatStatus(staff.status)}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            populateJobsSummaryReport() {
                const tbody = document.querySelector('#jobs-summary-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (!this.data.jobs || this.data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                    return;
                }

                const statusCounts = {};
                const total = this.data.jobs.length;

                this.data.jobs.forEach(job => {
                    statusCounts[job.status] = (statusCounts[job.status] || 0) + 1;
                });

                Object.keys(statusCounts).forEach(status => {
                    const count = statusCounts[status];
                    const percentage = Math.round((count / total) * 100);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="status-badge status-${status}">${this.formatStatus(status)}</span></td>
                        <td style="font-weight:bold;">${count}</td>
                        <td>${percentage}%</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            populateRevenueReport() {
                const tbody = document.querySelector('#revenue-report-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                const completedJobs = this.data.jobs.filter(j => j.status === 'completed' && j.completionData);

                if (completedJobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No revenue data available</td></tr>';
                    return;
                }

                let totalRevenue = 0;

                completedJobs.forEach(job => {
                    const tipAmount = job.completionData.tipAmount || 0;
                    totalRevenue += parseFloat(tipAmount);
                    const rating = job.completionData.rating ? '‚≠ê'.repeat(job.completionData.rating) : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight:bold;">#${job.id}</td>
                        <td>${job.clientName}</td>
                        <td>${job.date}</td>
                        <td>${job.teamLeader || 'N/A'}</td>
                        <td style="color: #27ae60; font-weight:bold;">${tipAmount} AED</td>
                        <td>${rating}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.style.backgroundColor = '#f0f9ff';
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td colspan="4" style="text-align:right;">TOTAL TIPS:</td>
                    <td style="color: #27ae60; font-weight:bold; font-size:16px;">${totalRevenue.toFixed(2)} AED</td>
                    <td></td>
                `;
                tbody.appendChild(totalRow);
            }

            // Show loading state
            showLoading(text = 'Loading...') {
                const existing = document.getElementById('loading-overlay');
                if (existing) existing.remove();
                
                const overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    color: white;
                    font-size: 18px;
                `;
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        ${text}
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.remove();
            }

            async fetchPeople(type) {
                try {
                    const path = type === 'teamLeaders' ? 'teamleaders' : type;
                    const response = await fetch(`/api/${path}`);
                    if (!response.ok) throw new Error(`Failed to fetch ${type}`);
                    const data = await response.json();
                    this.data[type] = data;
                    
                    // Update users collection after fetching people data
                    this.setupUsers();
                } catch (error) {
                    console.error(`Error fetching ${type}:`, error);
                    this.showNotification(`Failed to load ${type}`, 'error');
                }
            }

            loadSupervisors() {
                // Always fetch latest from backend
                this.fetchPeople('supervisors').then(() => this.populateSupervisorsTable());
            }

            loadTeamLeaders() {
                // Always fetch latest from backend
                this.fetchPeople('teamLeaders').then(() => this.populateTeamLeadersTable());
            }

            loadStaff() {
                // Always fetch latest from backend
                this.fetchPeople('staff').then(() => {
                    // Hide/show designation header based on role
                    const designationHeader = document.getElementById('staff-designation-header');
                    if (designationHeader) {
                        designationHeader.style.display = this.currentRole === 'admin' ? '' : 'none';
                    }
                    this.populateStaffTable();
                });
            }

            async loadSurveys() {
                try {
                    const response = await fetch('/api/surveys');
                    if (!response.ok) throw new Error('Failed to fetch surveys');
                    const data = await response.json();
                    this.data.surveys = data || [];
                    this.populateSurveysTable();
                } catch (error) {
                    console.error('Error fetching surveys:', error);
                    this.showNotification('Failed to load surveys', 'error');
                }
            }

            populateTeamLeadersDropdown() {
                const select = document.getElementById('team-leader-assign');
                const editSelect = document.getElementById('edit-team-leader-assign');
                const selects = [select, editSelect].filter(s => s);
                
                if (selects.length === 0) return;
                
                selects.forEach(sel => {
                    sel.innerHTML = '<option value="">Select Team Leader</option>';
                    
                    // Add regular team leaders
                    if (this.data.teamLeaders) {
                        this.data.teamLeaders.forEach(tl => {
                            const option = document.createElement('option');
                            option.value = tl.name;
                            option.textContent = tl.name;
                            sel.appendChild(option);
                        });
                    }
                    
                    // Add promoted staff members (staff with isTeamLeader: true)
                    if (this.data.staff) {
                        this.data.staff.forEach(staff => {
                            if (staff.isTeamLeader === true) {
                                const option = document.createElement('option');
                                option.value = staff.name;
                                option.textContent = `${staff.name} (Promoted Staff)`;
                                sel.appendChild(option);
                            }
                        });
                    }
                });
            }

            populateStaffDropdown() {
                const select = document.getElementById('assign-staff');
                const editSelect = document.getElementById('edit-assign-staff');
                const selects = [select, editSelect].filter(s => s);
                
                if (selects.length === 0) return;
                
                // Only admin can see designation in job assignment dropdowns
                const showDesignation = this.currentRole === 'admin';
                
                selects.forEach(sel => {
                    sel.innerHTML = '';
                    this.data.staff.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.name;
                        if (showDesignation) {
                            const designation = staff.designation || 'N/A';
                            option.textContent = `${staff.name} - ${designation}`;
                        } else {
                            option.textContent = staff.name;
                        }
                        sel.appendChild(option);
                    });
                });
            }

            // Population methods
            populateRecentJobs() {
                console.log('>>> populateRecentJobs called');
                const tbody = document.querySelector('#recent-jobs-table tbody');
                
                if (!tbody) {
                    console.error('Recent jobs table tbody not found!');
                    return;
                }
                
                tbody.innerHTML = '';

                if (!this.data || !this.data.jobs || this.data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                    return;
                }

                // Filter jobs based on role
                let jobsToShow = this.data.jobs;
                if (this.currentRole === 'teamleader') {
                    jobsToShow = this.data.jobs.filter(job => job.teamLeader === this.currentUser.name);
                } else if (this.currentRole === 'staff') {
                    jobsToShow = this.data.jobs.filter(job => 
                        job.assignedStaff && job.assignedStaff.includes(this.currentUser.name)
                    );
                }

                // Show only last 5 jobs (most recent first)
                const recentJobs = jobsToShow.slice(-5).reverse();
                
                console.log(`Showing ${recentJobs.length} recent jobs in dashboard`);
                
                if (recentJobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">No recent jobs</td></tr>';
                    return;
                }

                // Create rows using inline onclick (same as Jobs section)
                recentJobs.forEach(job => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight:bold;">#${job.id}</td>
                        <td>${job.clientName}</td>
                        <td>${job.date}</td>
                        <td>${job.teamLeader || 'Unassigned'}</td>
                        <td><span class="status-badge status-${job.status}">${this.formatStatus(job.status)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="app.showJobDetails(${job.id})" style="margin:2px;">VIEW</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('>>> populateRecentJobs completed');
            }

            populateCurrentJobs() {
                console.log('>>> populateCurrentJobs called');
                const tbody = document.querySelector('#current-jobs-table tbody');
                
                if (!tbody) {
                    console.error('ERROR: Table tbody not found!');
                    return;
                }
                
                // Clear existing rows
                tbody.innerHTML = '';

                // Check if jobs data exists
                if (!this.data || !this.data.jobs) {
                    console.log('No jobs data available');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                    return;
                }

                const allJobs = this.data.jobs;
                console.log('Total jobs in database:', allJobs.length);
                console.log('Current user role:', this.currentRole);

                if (allJobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                    return;
                }

                // Filter based on role
                let jobsToShow = allJobs;
                if (this.currentRole === 'teamleader') {
                    jobsToShow = allJobs.filter(j => j.teamLeader === this.currentUser.name);
                } else if (this.currentRole === 'staff') {
                    jobsToShow = allJobs.filter(j => j.assignedStaff && j.assignedStaff.includes(this.currentUser.name));
                }

                console.log('Jobs to show after filtering:', jobsToShow.length);

                if (jobsToShow.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">No jobs assigned to you</td></tr>';
                    return;
                }

                // Create rows for each job
                jobsToShow.forEach((job, index) => {
                    console.log(`Creating row for job #${job.id} (${index + 1}/${jobsToShow.length})`);
                    const row = this.createJobRow(job);
                    if (row) {
                    tbody.appendChild(row);
                        console.log(`Row for job #${job.id} appended successfully`);
                    } else {
                        console.error(`Failed to create row for job #${job.id}`);
                    }
                });

                console.log('>>> populateCurrentJobs completed');
                
                // Add scroll detection for mobile table hint
                this.setupTableScrollDetection();
            }
            
            setupTableScrollDetection() {
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    // Remove existing listener if any
                    tableContainer.removeEventListener('scroll', this.handleTableScroll);
                    // Add scroll listener
                    this.handleTableScroll = () => {
                        tableContainer.classList.add('scrolled');
                    };
                    tableContainer.addEventListener('scroll', this.handleTableScroll, { once: true });
                }
            }

            // Pagination Methods
            updatePagination(type) {
                const paginationInfo = document.getElementById(`${type}-pagination-info`);
                const prevBtn = document.getElementById(`${type}-prev`);
                const nextBtn = document.getElementById(`${type}-next`);
                const pageNumbers = document.getElementById(`${type}-page-numbers`);

                if (!this.pagination[type] || !paginationInfo) return;

                const { currentPage, itemsPerPage, totalItems } = this.pagination[type];
                const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
                const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);

                // Update pagination info text
                paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems}`;

                // Update button states
                if (prevBtn) prevBtn.disabled = currentPage === 1;
                if (nextBtn) nextBtn.disabled = currentPage === totalPages;

                // Update page numbers
                if (pageNumbers) {
                    pageNumbers.innerHTML = '';
                    for (let i = 1; i <= totalPages; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `btn btn-sm page-number ${i === currentPage ? 'active' : ''}`;
                        pageBtn.textContent = i;
                        pageBtn.onclick = () => this.goToPage(type, i);
                        pageNumbers.appendChild(pageBtn);
                    }
                }
            }

            goToPage(type, page) {
                if (!this.pagination[type]) return;
                this.pagination[type].currentPage = page;
                
                // Re-render the appropriate table
                if (type === 'jobs') {
                    this.populateCurrentJobs();
                }
            }

            previousPage(type) {
                if (!this.pagination[type]) return;
                if (this.pagination[type].currentPage > 1) {
                    this.pagination[type].currentPage--;
                    if (type === 'jobs') {
                        this.populateCurrentJobs();
                    }
                }
            }

            nextPage(type) {
                if (!this.pagination[type]) return;
                const totalPages = Math.ceil(this.pagination[type].totalItems / this.pagination[type].itemsPerPage);
                if (this.pagination[type].currentPage < totalPages) {
                    this.pagination[type].currentPage++;
                    if (type === 'jobs') {
                        this.populateCurrentJobs();
                    }
                }
            }

            createJobRow(job) {
                console.log(`  >> Creating row for job #${job.id}`);
                
                const row = document.createElement('tr');
                row.id = `job-row-${job.id}`;
                
                // Simple role checks
                const isAdmin = (this.currentRole === 'admin');
                const isSupervisor = (this.currentRole === 'supervisor');
                const isTeamLeader = (this.currentRole === 'teamleader');
                const canEdit = (isAdmin || isSupervisor);
                
                console.log(`  >> Role: ${this.currentRole}, Can Edit: ${canEdit}, TL: ${isTeamLeader}`);
                
                // Build action buttons
                let actionButtons = `<button class="btn btn-primary btn-sm" onclick="app.showJobDetails(${job.id})" style="margin:2px;">VIEW</button>`;
                
                // Admin/Supervisor buttons
                if (canEdit) {
                    actionButtons += `<button class="btn btn-warning btn-sm" onclick="app.editJob(${job.id})" style="margin:2px;">EDIT</button>`;
                    actionButtons += `<button class="btn btn-danger btn-sm" onclick="app.deleteJob(${job.id})" style="margin:2px;">DELETE</button>`;
                }
                
                // Team Leader workflow buttons - NEW FLOW
                if (isTeamLeader && job.teamLeader === this.currentUser.name) {
                    if (job.status === 'assigned') {
                        actionButtons += `<button class="btn btn-success btn-sm" onclick="app.tlSetStatus(${job.id}, 'arrived')" style="margin:2px;">Arrived at 1st Location</button>`;
                    } else if (job.status === 'arrived') {
                        actionButtons += `<button class="btn btn-warning btn-sm" onclick="app.tlSetStatus(${job.id}, 'packing-start')" style="margin:2px;">Start Packing</button>`;
                    } else if (job.status === 'packing-start') {
                        actionButtons += `<button class="btn btn-primary btn-sm" onclick="app.tlSetStatus(${job.id}, 'first-location-completed')" style="margin:2px;">1st Location Complete</button>`;
                    } else if (job.status === 'first-location-completed') {
                        actionButtons += `<button class="btn btn-info btn-sm" onclick="app.tlSetStatus(${job.id}, 'arrived-second-location')" style="margin:2px;">Arrived at 2nd Location</button>`;
                    } else if (job.status === 'arrived-second-location') {
                        actionButtons += `<button class="btn btn-warning btn-sm" onclick="app.tlSetStatus(${job.id}, 'unpacking-start')" style="margin:2px;">Start Unpacking</button>`;
                    } else if (job.status === 'unpacking-start') {
                        actionButtons += `<button class="btn btn-success btn-sm" onclick="app.showJobCompletionModal(${job.id})" style="margin:2px;">Complete Job</button>`;
                    }
                    
                    // Add delay button for any active job (not completed or waiting approval)
                    if (!['completed', 'waiting-approval', 'delayed'].includes(job.status)) {
                        actionButtons += `<button class="btn btn-danger btn-sm" onclick="app.tlSetStatus(${job.id}, 'delayed')" style="margin:2px; margin-left:5px;">Mark as Delayed</button>`;
                    } else if (job.status === 'delayed') {
                        // If job is delayed, show button to resume
                        actionButtons += `<button class="btn btn-warning btn-sm" onclick="app.tlResumeFromDelay(${job.id})" style="margin:2px;">Resume Job</button>`;
                    }
                }
                
                // Build the row HTML with data-label for mobile responsiveness
                const html = `
                    <td data-label=""><input type="checkbox" class="job-checkbox" data-job-id="${job.id}"></td>
                    <td data-label="Job ID: " style="font-weight:bold;">#${job.id}</td>
                    <td data-label="Client: ">${job.clientName}</td>
                    <td data-label="Date: ">${job.date}</td>
                    <td data-label="Team Leader: ">${job.teamLeader || 'Unassigned'}</td>
                    <td data-label="Status: "><span class="status-badge status-${job.status}">${this.formatStatus(job.status)}</span></td>
                    <td data-label="Actions: " style="white-space:nowrap; padding:8px;">
                        ${actionButtons}
                    </td>
                `;
                
                row.innerHTML = html;
                console.log(`  >> Row HTML created with buttons: ${actionButtons}`);
                
                return row;
            }

            populateSupervisorsTable() {
                const tbody = document.querySelector('#supervisors-table tbody');
                tbody.innerHTML = '';

                if (this.data.supervisors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No supervisors available</td></tr>';
                    return;
                }

                this.data.supervisors.forEach(sup => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sup.name}</td>
                        <td>${sup.phone}</td>
                        <td>${sup.email}</td>
                        <td><span class="status-badge status-${sup.status}">${this.formatStatus(sup.status)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm view-supervisor-btn" data-id="${sup.id}">View</button>
                            ${this.currentRole === 'admin' ? `
                                <button class="btn btn-warning btn-sm edit-supervisor-btn" data-id="${sup.id}">Edit</button>
                                <button class="btn btn-${sup.status === 'available' ? 'danger' : 'success'} btn-sm toggle-supervisor-status" data-id="${sup.id}">
                                    ${sup.status === 'available' ? 'Day Off' : 'Available'}
                                </button>
                            ` : ''}
                        </td>
                    `;

                    row.querySelector('.view-supervisor-btn').addEventListener('click', (e) => {
                        this.showSupervisorDetails(parseInt(e.target.dataset.id));
                    });

                    const editBtn = row.querySelector('.edit-supervisor-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            this.editSupervisor(parseInt(e.target.dataset.id));
                        });
                    }

                    const toggleBtn = row.querySelector('.toggle-supervisor-status');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', (e) => {
                            this.toggleSupervisorStatus(parseInt(e.target.dataset.id));
                        });
                    }

                    tbody.appendChild(row);
                });
            }

            populateSurveysTable() {
                const tbody = document.querySelector('#surveys-table tbody');
                tbody.innerHTML = '';

                if (this.data.surveys.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="no-data">No surveys available</td></tr>';
                    return;
                }

                // Filter surveys based on role
                let surveysToShow = this.data.surveys;
                if (this.currentRole === 'supervisor' || this.currentRole === 'teamleader') {
                    // Show only surveys assigned to current user
                    const assignedName = this.currentUser.name;
                    surveysToShow = this.data.surveys.filter(s => s.assignedTo === assignedName);
                }

                if (surveysToShow.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="no-data">No surveys available</td></tr>';
                    return;
                }

                surveysToShow.forEach(survey => {
                    const row = document.createElement('tr');
                    const assignedToName = survey.assignedTo || 'Unassigned';
                    const surveyTime = survey.surveyDate && survey.surveyTime 
                        ? `${survey.surveyDate} ${survey.surveyTime}` 
                        : 'Not set';
                    
                    row.innerHTML = `
                        <td>#${survey.id}</td>
                        <td>${survey.clientName || 'N/A'}</td>
                        <td>${survey.clientNumber || 'N/A'}</td>
                        <td>${survey.location || 'N/A'}</td>
                        <td>${this.formatApartmentSize(survey.apartmentSize, survey.apartmentSizeCustom) || 'N/A'}</td>
                        <td>${surveyTime}</td>
                        <td>${assignedToName}</td>
                        <td><span class="status-badge status-${survey.status || 'pending'}">${this.formatStatus(survey.status || 'pending')}</span></td>
                        <td>
                            ${survey.status === 'completed' ? `
                                <button class="btn btn-primary btn-sm view-survey-btn" data-id="${survey.id}">View</button>
                            ` : (this.currentRole === 'admin' || survey.assignedTo === this.currentUser.name) ? `
                                <button class="btn btn-success btn-sm complete-survey-btn" data-id="${survey.id}">Complete</button>
                                ${this.currentRole === 'admin' ? `
                                    <button class="btn btn-primary btn-sm view-survey-btn" data-id="${survey.id}">View</button>
                                ` : ''}
                            ` : ''}
                        </td>
                    `;

                    const completeBtn = row.querySelector('.complete-survey-btn');
                    if (completeBtn) {
                        completeBtn.addEventListener('click', (e) => {
                            this.showCompleteSurveyModal(parseInt(e.target.dataset.id));
                        });
                    }

                    const viewBtn = row.querySelector('.view-survey-btn');
                    if (viewBtn) {
                        viewBtn.addEventListener('click', (e) => {
                            this.showSurveyDetails(parseInt(e.target.dataset.id));
                        });
                    }

                    tbody.appendChild(row);
                });
            }

            formatApartmentSize(size, customText) {
                const sizeMap = {
                    'studio': 'Studio',
                    '1br': '1 Bedroom',
                    '2br': '2 Bedrooms',
                    '3br': '3 Bedrooms',
                    'villa': 'Villa',
                    'custom': 'Custom'
                };
                if (size === 'custom') {
                    return customText && customText.trim() ? customText : 'Custom';
                }
                return sizeMap[size] || size;
            }

            populateTeamLeadersTable() {
                const tbody = document.querySelector('#teamleaders-table tbody');
                tbody.innerHTML = '';

                if (this.data.teamLeaders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No team leaders available</td></tr>';
                    return;
                }

                this.data.teamLeaders.forEach(tl => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tl.name}</td>
                        <td>${tl.phone}</td>
                        <td>${tl.designation}</td>
                        <td>${tl.jobsCompleted}</td>
                        <td><span class="status-badge status-${tl.status}">${this.formatStatus(tl.status)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm view-teamleader-btn" data-id="${tl.id}">View</button>
                            ${this.currentRole !== 'teamleader' ? `
                                <button class="btn btn-warning btn-sm edit-teamleader-btn" data-id="${tl.id}">Edit</button>
                                <button class="btn btn-${tl.status === 'available' ? 'danger' : 'success'} btn-sm toggle-teamleader-status" data-id="${tl.id}">
                                    ${tl.status === 'available' ? 'Day Off' : 'Available'}
                                </button>
                            ` : ''}
                        </td>
                    `;

                    row.querySelector('.view-teamleader-btn').addEventListener('click', (e) => {
                        this.showTeamLeaderDetails(parseInt(e.target.dataset.id));
                    });

                    const editBtn = row.querySelector('.edit-teamleader-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            this.editTeamLeader(parseInt(e.target.dataset.id));
                        });
                    }

                    const toggleBtn = row.querySelector('.toggle-teamleader-status');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', (e) => {
                            this.toggleTeamLeaderStatus(parseInt(e.target.dataset.id));
                        });
                    }

                    tbody.appendChild(row);
                });
            }

            populateStaffTable() {
                const tbody = document.querySelector('#staff-table tbody');
                tbody.innerHTML = '';

                const showDesignation = this.currentRole === 'admin';
                const colCount = showDesignation ? 8 : 7;
                
                if (this.data.staff.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${colCount}" class="no-data">No staff members available</td></tr>`;
                    return;
                }

                this.data.staff.forEach(staff => {
                    const isPromoted = staff.isTeamLeader || false;
                    const showDesignation = this.currentRole === 'admin';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${staff.name}</td>
                        <td>${staff.username}</td>
                        <td>${staff.phone}</td>
                        ${showDesignation ? `<td>${staff.designation || 'N/A'}</td>` : ''}
                        <td>${staff.teamLeader || 'N/A'}</td>
                        <td>
                            ${isPromoted ? '<span class="status-badge status-completed" style="background:#10b981;">Team Leader</span>' : '<span class="status-badge" style="background:#64748b;">Staff</span>'}
                        </td>
                        <td><span class="status-badge status-${staff.status}">${this.formatStatus(staff.status)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm view-staff-btn" data-id="${staff.id}">View</button>
                            ${(this.currentRole === 'admin' || this.currentRole === 'supervisor') ? `
                                <button class="btn btn-warning btn-sm edit-staff-btn" data-id="${staff.id}">Edit</button>
                                <button class="btn btn-${isPromoted ? 'secondary' : 'info'} btn-sm toggle-teamleader-promotion" data-id="${staff.id}" data-promoted="${isPromoted}">
                                    ${isPromoted ? 'Demote from TL' : 'Promote to TL'}
                                </button>
                                <button class="btn btn-${staff.status === 'available' ? 'danger' : 'success'} btn-sm toggle-staff-status" data-id="${staff.id}">
                                    ${staff.status === 'available' ? 'Day Off' : 'Available'}
                                </button>
                            ` : this.currentRole !== 'teamleader' ? `
                                <button class="btn btn-warning btn-sm edit-staff-btn" data-id="${staff.id}">Edit</button>
                                <button class="btn btn-${staff.status === 'available' ? 'danger' : 'success'} btn-sm toggle-staff-status" data-id="${staff.id}">
                                    ${staff.status === 'available' ? 'Day Off' : 'Available'}
                                </button>
                            ` : ''}
                        </td>
                    `;

                    row.querySelector('.view-staff-btn').addEventListener('click', (e) => {
                        this.showStaffDetails(parseInt(e.target.dataset.id));
                    });

                    const editBtn = row.querySelector('.edit-staff-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            this.editStaff(parseInt(e.target.dataset.id));
                        });
                    }

                    const promoteBtn = row.querySelector('.toggle-teamleader-promotion');
                    if (promoteBtn && (this.currentRole === 'admin' || this.currentRole === 'supervisor')) {
                        promoteBtn.addEventListener('click', (e) => {
                            this.toggleStaffTeamLeaderPromotion(parseInt(e.target.dataset.id));
                        });
                    }

                    const toggleBtn = row.querySelector('.toggle-staff-status');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', (e) => {
                            this.toggleStaffStatus(parseInt(e.target.dataset.id));
                        });
                    }

                    tbody.appendChild(row);
                });
            }
            
            toggleStaffTeamLeaderPromotion(staffId) {
                const staff = this.data.staff.find(s => s.id === staffId);
                if (!staff) return;
                
                const isPromoted = staff.isTeamLeader || false;
                const newStatus = !isPromoted;
                
                fetch(`/api/staff/${encodeURIComponent(staffId)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...staff, isTeamLeader: newStatus })
                })
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.json();
                })
                .then(() => {
                    // Update local data
                    staff.isTeamLeader = newStatus;
                    // Update users collection if exists
                    if (this.data.users && this.data.users[staff.username]) {
                        this.data.users[staff.username].isTeamLeader = newStatus;
                    }
                    this.loadStaff();
                    this.showNotification(`Staff ${newStatus ? 'promoted to' : 'demoted from'} Team Leader successfully`, 'success');
                })
                .catch(() => this.showNotification('Failed to update promotion status', 'error'));
            }

            populatePendingApprovalTable() {
                console.log('>>> populatePendingApprovalTable called');
                const tbody = document.querySelector('#pending-approval-table tbody');
                
                if (!tbody) {
                    console.error('Pending approval table tbody not found!');
                    return;
                }
                
                tbody.innerHTML = '';

                if (!this.data || !this.data.jobs) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No jobs available</td></tr>';
                    return;
                }

                const pendingJobs = this.data.jobs.filter(job => job.status === 'waiting-approval');
                
                console.log(`Found ${pendingJobs.length} jobs pending approval`);
                
                if (pendingJobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">No jobs pending approval</td></tr>';
                    return;
                }
                
                const canApprove = this.currentRole === 'admin' || this.currentRole === 'supervisor';
                console.log(`User role: ${this.currentRole}, Can Approve: ${canApprove}`);
                
                pendingJobs.forEach(job => {
                    const row = document.createElement('tr');
                    
                    // Format rating
                    const rating = job.completionData && job.completionData.rating 
                        ? `${'‚≠ê'.repeat(job.completionData.rating)} (${job.completionData.rating}/5)` 
                        : 'N/A';
                    
                    // Format tip amount
                    const tipAmount = job.completionData && job.completionData.tipAmount 
                        ? `AED ${job.completionData.tipAmount}` 
                        : 'No tip';
                    
                    // Format boxes
                    let boxesInfo = 'No';
                    if (job.completionData && job.completionData.boxesCollected === 'yes') {
                        const count = job.completionData.boxesCount || 0;
                        boxesInfo = `Yes (${count})`;
                    }
                    
                    // Build action buttons with inline onclick
                    let actionButtons = `<button class="btn btn-primary btn-sm" onclick="app.showApprovalModal(${job.id})" style="margin:2px;">REVIEW</button>`;
                    if (canApprove) {
                        actionButtons += `<button class="btn btn-success btn-sm" onclick="app.approveJob(${job.id})" style="margin:2px;">APPROVE</button>`;
                    }
                    
                    row.innerHTML = `
                        <td style="font-weight:bold;">#${job.id}</td>
                        <td>${job.clientName}</td>
                        <td>${job.date}</td>
                        <td>${job.teamLeader || 'N/A'}</td>
                        <td>${rating}</td>
                        <td>${tipAmount}</td>
                        <td>${boxesInfo}</td>
                        <td style="white-space:nowrap; padding:8px;">
                            ${actionButtons}
                        </td>
                    `;

                    tbody.appendChild(row);
                });
                
                console.log('>>> populatePendingApprovalTable completed');
            }

            // Approval Modal
            showApprovalModal(jobId) {
                const job = this.data.jobs.find(j => j.id === jobId);
                if (!job) {
                    this.showNotification('Job not found', 'error');
                    return;
                }

                // Debug logging
                console.log('Approval Modal - Job:', job);
                console.log('Approval Modal - Completion Data:', job.completionData);
                console.log('Approval Modal - Signature:', job.completionData?.signature);

                const approvalDetails = document.getElementById('approval-details');
                approvalDetails.innerHTML = `
                    <div class="approval-job-info">
                        <h4>Job #${job.id} - ${job.clientName}</h4>
                        <p><strong>Date:</strong> ${job.date}</p>
                        <p><strong>Team Leader:</strong> ${job.teamLeader}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${job.status}">${this.formatStatus(job.status)}</span></p>
                    </div>
                    
                    ${job.completionData ? `
                        <div class="completion-details">
                            <h4>Completion Details</h4>
                            <p><strong>Rating:</strong> ${'‚≠ê'.repeat(job.completionData.rating)} (${job.completionData.rating}/5 stars)</p>
                            <p><strong>Tip Amount:</strong> ${job.completionData.tipAmount ? job.completionData.tipAmount + ' AED' : 'No tip'}</p>
                            <p><strong>Boxes Collected:</strong> ${job.completionData.boxesCollected === 'yes' ? `Yes (${job.completionData.boxesCount} boxes)` : 'No'}</p>
                            <p><strong>Completed At:</strong> ${new Date(job.completionData.completedAt).toLocaleString()}</p>
                            ${job.completionData.notes ? `<p><strong>Notes:</strong> ${job.completionData.notes}</p>` : ''}
                            ${job.completionData.signature ? `
                                <div class="signature-display">
                                    <h5>Client Signature:</h5>
                                    <img src="${job.completionData.signature.startsWith('data:') ? job.completionData.signature : app.getImageUrl(job.completionData.signature)}" alt="Client Signature" style="max-width: 300px; border: 1px solid #ddd; border-radius: 8px;" onerror="console.error('Signature image failed to load:', this.src)">
                                </div>
                            ` : '<p><strong>Client Signature:</strong> No signature provided</p>'}
                        </div>
                    ` : '<p>No completion data available</p>'}
                `;

                // Set up approve button
                const approveBtn = document.getElementById('approve-job');
                approveBtn.onclick = () => this.approveJob(jobId);
                
                this.showModal('job-approval-modal');
            }

            approveJob(jobId) {
                fetch(`/api/jobs/${jobId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                })
                .then(res => res.json())
                .then(() => {
                    this.hideModals();
                    this.loadJobs();
                    this.showNotification('Job approved successfully!', 'success');
                })
                .catch(() => {
                    this.showNotification('Failed to approve job', 'error');
                });
            }

            // Search and Filter Functions
            filterJobs() {
                const searchTerm = document.getElementById('jobs-search')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('jobs-status-filter')?.value || '';
                const rows = document.querySelectorAll('#current-jobs-table tbody tr');
                
                rows.forEach(row => {
                    const jobId = row.cells[1]?.textContent.toLowerCase() || '';
                    const clientName = row.cells[2]?.textContent.toLowerCase() || '';
                    const teamLeader = row.cells[4]?.textContent.toLowerCase() || '';
                    const status = row.cells[5]?.textContent.toLowerCase() || '';
                    
                    const matchesSearch = jobId.includes(searchTerm) || clientName.includes(searchTerm) || teamLeader.includes(searchTerm);
                    const matchesStatus = !statusFilter || status.includes(statusFilter.toLowerCase());
                    
                    row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                });
            }

            filterSupervisors() {
                const searchTerm = document.getElementById('supervisors-search')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#supervisors-table tbody tr');
                
                rows.forEach(row => {
                    const name = row.cells[0]?.textContent.toLowerCase() || '';
                    const phone = row.cells[1]?.textContent.toLowerCase() || '';
                    const email = row.cells[2]?.textContent.toLowerCase() || '';
                    
                    const matches = name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            }

            filterTeamLeaders() {
                const searchTerm = document.getElementById('teamleaders-search')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#teamleaders-table tbody tr');
                
                rows.forEach(row => {
                    const name = row.cells[0]?.textContent.toLowerCase() || '';
                    const phone = row.cells[1]?.textContent.toLowerCase() || '';
                    const email = row.cells[2]?.textContent.toLowerCase() || '';
                    
                    const matches = name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            }

            filterStaff() {
                const searchTerm = document.getElementById('staff-search')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#staff-table tbody tr');
                
                rows.forEach(row => {
                    const name = row.cells[0]?.textContent.toLowerCase() || '';
                    const phone = row.cells[1]?.textContent.toLowerCase() || '';
                    const email = row.cells[2]?.textContent.toLowerCase() || '';
                    
                    const matches = name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            }

            // Export Functions
            exportJobsCSV() {
                const jobs = this.data.jobs.filter(job => job.status !== 'completed');
                const csv = this.convertToCSV(jobs, [
                    'id', 'clientName', 'email', 'phone', 'date', 'movingFrom', 'movingTo', 
                    'apartmentSize', 'teamLeader', 'status', 'requirementsAcknowledged'
                ]);
                this.downloadCSV(csv, 'current-jobs.csv');
            }

            exportPendingApprovalCSV() {
                const jobs = this.data.jobs.filter(job => job.status === 'waiting-approval');
                const csv = this.convertToCSV(jobs, [
                    'id', 'clientName', 'email', 'phone', 'date', 'movingFrom', 'movingTo', 
                    'apartmentSize', 'teamLeader', 'status', 'completionData'
                ]);
                this.downloadCSV(csv, 'pending-approval-jobs.csv');
            }

            exportJobsPDF() {
                // Simple PDF generation using browser print
                const jobs = this.data.jobs.filter(job => job.status !== 'completed');
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head><title>Current Jobs Report</title></head>
                        <body>
                            <h1>Current Jobs Report</h1>
                            <table border="1" style="width:100%; border-collapse: collapse;">
                                <tr>
                                    <th>ID</th><th>Client</th><th>Date</th><th>Team Leader</th><th>Status</th>
                                </tr>
                                ${jobs.map(job => `
                                    <tr>
                                        <td>#${job.id}</td>
                                        <td>${job.clientName}</td>
                                        <td>${job.date}</td>
                                        <td>${job.teamLeader}</td>
                                        <td>${this.formatStatus(job.status)}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            convertToCSV(data, fields) {
                const headers = fields.map(field => field.charAt(0).toUpperCase() + field.slice(1));
                const rows = data.map(item => 
                    fields.map(field => {
                        const value = item[field];
                        if (typeof value === 'object') {
                            return JSON.stringify(value);
                        }
                        return `"${String(value || '').replace(/"/g, '""')}"`;
                    }).join(',')
                );
                return [headers.join(','), ...rows].join('\n');
            }

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Reports Export Functions
            exportTeamLeaderReportCSV() {
                const data = [];
                this.data.teamLeaders.forEach(tl => {
                    const tlJobs = this.data.jobs.filter(j => j.teamLeader === tl.name);
                    const completed = tlJobs.filter(j => j.status === 'completed').length;
                    const pending = tlJobs.filter(j => !['completed', 'delayed'].includes(j.status)).length;
                    const delayed = tlJobs.filter(j => j.status === 'delayed').length;
                    const total = tlJobs.length;
                    const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                    const completedWithRating = tlJobs.filter(j => j.status === 'completed' && j.completionData && j.completionData.rating);
                    const avgRating = completedWithRating.length > 0
                        ? (completedWithRating.reduce((sum, j) => sum + j.completionData.rating, 0) / completedWithRating.length).toFixed(1)
                        : 'N/A';

                    data.push({
                        'Team Leader': tl.name,
                        'Total Jobs': total,
                        'Completed': completed,
                        'Pending': pending,
                        'Delayed': delayed,
                        'Completion Rate': completionRate + '%',
                        'Average Rating': avgRating
                    });
                });

                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'team-leader-performance-report.csv');
            }

            exportTeamLeaderReportPDF() {
                const printWindow = window.open('', '_blank');
                let tableRows = '';
                
                this.data.teamLeaders.forEach(tl => {
                    const tlJobs = this.data.jobs.filter(j => j.teamLeader === tl.name);
                    const completed = tlJobs.filter(j => j.status === 'completed').length;
                    const pending = tlJobs.filter(j => !['completed', 'delayed'].includes(j.status)).length;
                    const delayed = tlJobs.filter(j => j.status === 'delayed').length;
                    const total = tlJobs.length;
                    const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                    const completedWithRating = tlJobs.filter(j => j.status === 'completed' && j.completionData && j.completionData.rating);
                    const avgRating = completedWithRating.length > 0
                        ? (completedWithRating.reduce((sum, j) => sum + j.completionData.rating, 0) / completedWithRating.length).toFixed(1)
                        : 'N/A';

                    tableRows += `
                        <tr>
                            <td>${tl.name}</td>
                            <td>${total}</td>
                            <td>${completed}</td>
                            <td>${pending}</td>
                            <td>${delayed}</td>
                            <td>${completionRate}%</td>
                            <td>${avgRating}</td>
                        </tr>
                    `;
                });

                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Team Leader Performance Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { color: #333; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                                th { background-color: #3498db; color: white; }
                                tr:nth-child(even) { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            <h1>Team Leader Performance Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Team Leader</th>
                                        <th>Total Jobs</th>
                                        <th>Completed</th>
                                        <th>Pending</th>
                                        <th>Delayed</th>
                                        <th>Completion Rate</th>
                                        <th>Avg Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            exportStaffReportCSV() {
                const data = [];
                this.data.staff.forEach(staff => {
                    const staffJobs = this.data.jobs.filter(j => j.assignedStaff && j.assignedStaff.includes(staff.name));
                    const completed = staffJobs.filter(j => j.status === 'completed').length;
                    const total = staffJobs.length;

                    data.push({
                        'Staff Name': staff.name,
                        'Designation': staff.designation,
                        'Team Leader': staff.teamLeader || 'N/A',
                        'Total Jobs': total,
                        'Completed': completed,
                        'Status': staff.status
                    });
                });

                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'staff-performance-report.csv');
            }

            exportStaffReportPDF() {
                const printWindow = window.open('', '_blank');
                let tableRows = '';
                
                this.data.staff.forEach(staff => {
                    const staffJobs = this.data.jobs.filter(j => j.assignedStaff && j.assignedStaff.includes(staff.name));
                    const completed = staffJobs.filter(j => j.status === 'completed').length;
                    const total = staffJobs.length;

                    tableRows += `
                        <tr>
                            <td>${staff.name}</td>
                            <td>${staff.designation}</td>
                            <td>${staff.teamLeader || 'N/A'}</td>
                            <td>${total}</td>
                            <td>${completed}</td>
                            <td>${staff.status}</td>
                        </tr>
                    `;
                });

                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Staff Performance Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { color: #333; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                                th { background-color: #3498db; color: white; }
                                tr:nth-child(even) { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            <h1>Staff Performance Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Staff Name</th>
                                        <th>Designation</th>
                                        <th>Team Leader</th>
                                        <th>Total Jobs</th>
                                        <th>Completed</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            exportJobsSummaryCSV() {
                const statusCounts = {};
                const total = this.data.jobs.length;

                this.data.jobs.forEach(job => {
                    statusCounts[job.status] = (statusCounts[job.status] || 0) + 1;
                });

                const data = [];
                Object.keys(statusCounts).forEach(status => {
                    const count = statusCounts[status];
                    const percentage = Math.round((count / total) * 100);

                    data.push({
                        'Status': status,
                        'Count': count,
                        'Percentage': percentage + '%'
                    });
                });

                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'jobs-summary-report.csv');
            }

            exportJobsSummaryPDF() {
                const printWindow = window.open('', '_blank');
                let tableRows = '';
                
                const statusCounts = {};
                const total = this.data.jobs.length;

                this.data.jobs.forEach(job => {
                    statusCounts[job.status] = (statusCounts[job.status] || 0) + 1;
                });

                Object.keys(statusCounts).forEach(status => {
                    const count = statusCounts[status];
                    const percentage = Math.round((count / total) * 100);

                    tableRows += `
                        <tr>
                            <td>${status}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });

                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Jobs Summary Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { color: #333; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                                th { background-color: #3498db; color: white; }
                                tr:nth-child(even) { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            <h1>Jobs Summary Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <p><strong>Total Jobs: ${total}</strong></p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            exportRevenueReportCSV() {
                const completedJobs = this.data.jobs.filter(j => j.status === 'completed' && j.completionData);
                const data = [];
                let totalRevenue = 0;

                completedJobs.forEach(job => {
                    const tipAmount = job.completionData.tipAmount || 0;
                    totalRevenue += parseFloat(tipAmount);

                    data.push({
                        'Job ID': job.id,
                        'Client': job.clientName,
                        'Date': job.date,
                        'Team Leader': job.teamLeader || 'N/A',
                        'Tip Amount (AED)': tipAmount,
                        'Rating': job.completionData.rating || 'N/A'
                    });
                });

                // Add total row
                data.push({
                    'Job ID': '',
                    'Client': '',
                    'Date': '',
                    'Team Leader': 'TOTAL TIPS:',
                    'Tip Amount (AED)': totalRevenue.toFixed(2),
                    'Rating': ''
                });

                const csv = this.convertToCSV(data);
                this.downloadCSV(csv, 'revenue-report.csv');
            }

            exportRevenueReportPDF() {
                const printWindow = window.open('', '_blank');
                let tableRows = '';
                const completedJobs = this.data.jobs.filter(j => j.status === 'completed' && j.completionData);
                let totalRevenue = 0;

                completedJobs.forEach(job => {
                    const tipAmount = job.completionData.tipAmount || 0;
                    totalRevenue += parseFloat(tipAmount);
                    const rating = job.completionData.rating ? '‚≠ê'.repeat(job.completionData.rating) : 'N/A';

                    tableRows += `
                        <tr>
                            <td>#${job.id}</td>
                            <td>${job.clientName}</td>
                            <td>${job.date}</td>
                            <td>${job.teamLeader || 'N/A'}</td>
                            <td style="color: #27ae60; font-weight:bold;">${tipAmount} AED</td>
                            <td>${rating}</td>
                        </tr>
                    `;
                });

                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Revenue Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { color: #333; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                                th { background-color: #3498db; color: white; }
                                tr:nth-child(even) { background-color: #f2f2f2; }
                                .total-row { background-color: #e8f5e9 !important; font-weight: bold; }
                            </style>
                        </head>
                        <body>
                            <h1>Revenue Report (Tips & Completed Jobs)</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Team Leader</th>
                                        <th>Tip Amount (AED)</th>
                                        <th>Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                    <tr class="total-row">
                                        <td colspan="4" style="text-align:right;">TOTAL TIPS:</td>
                                        <td style="color: #27ae60; font-weight:bold; font-size:16px;">${totalRevenue.toFixed(2)} AED</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            // Modal methods
            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }

            hideModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                // Also hide custom modals that don't use the .modal class
                const statusModal = document.getElementById('status-image-modal');
                if (statusModal) statusModal.style.display = 'none';
                const completionModal = document.getElementById('completion-modal');
                if (completionModal) completionModal.style.display = 'none';
            }

            // Helper function to get correct image URL for current platform
            getImageUrl(imageSrc) {
                if (!imageSrc) return '';
                
                // Debug logging
                console.log('getImageUrl input:', imageSrc);
                
                // If it's already a full URL or starts with /api/file/, return as is
                if (imageSrc.startsWith('http') || imageSrc.startsWith('/api/file/')) {
                    console.log('getImageUrl: Using existing URL:', imageSrc);
                    return imageSrc;
                }
                // If it starts with /uploads/, it's from file system, return as is
                if (imageSrc.startsWith('/uploads/')) {
                    console.log('getImageUrl: Using file system URL:', imageSrc);
                    return imageSrc;
                }
                // Otherwise, assume it's a filename and use the API endpoint
                const apiUrl = `/api/file/${imageSrc}`;
                console.log('getImageUrl: Using API URL:', apiUrl);
                return apiUrl;
            }

            showImageModal(imageSrc) {
                if (!imageSrc) {
                    this.showNotification('No image available', 'error');
                    return;
                }
                const correctUrl = this.getImageUrl(imageSrc);
                document.getElementById('modal-image').src = correctUrl;
                document.getElementById('image-modal').style.display = 'flex';
            }

            hideImageModal() {
                document.getElementById('image-modal').style.display = 'none';
            }

            // Add Modal Methods
            showAddSupervisorModal() {
                document.getElementById('add-supervisor-form').reset();
                this.showModal('add-supervisor-modal');
            }

            showAddTeamLeaderModal() {
                document.getElementById('add-teamleader-form').reset();
                this.showModal('add-teamleader-modal');
            }

            showAddStaffModal() {
                document.getElementById('add-staff-form').reset();
                // Populate team leaders dropdown
                const teamLeaderSelect = document.getElementById('new-staff-teamleader');
                teamLeaderSelect.innerHTML = '<option value="">Select Team Leader</option>';
                this.data.teamLeaders.forEach(tl => {
                    const option = document.createElement('option');
                    option.value = tl.name;
                    option.textContent = tl.name;
                    teamLeaderSelect.appendChild(option);
                });
                
                // Hide designation field for supervisors (admin only)
                const designationGroup = document.getElementById('new-staff-designation-group');
                const designationField = document.getElementById('new-staff-designation');
                if (designationGroup && designationField) {
                    if (this.currentRole === 'admin') {
                        designationGroup.style.display = 'block';
                        designationField.required = true;
                    } else {
                        designationGroup.style.display = 'none';
                        designationField.required = false;
                    }
                }
                
                this.showModal('add-staff-modal');
            }

            // Edit Job Method
            editJob(jobId) {
                const job = this.data.jobs.find(j => j.id == jobId);
                if (!job) {
                    this.showNotification('Job not found', 'error');
                    return;
                }

                // Populate edit form
                document.getElementById('edit-job-id').value = job.id;
                document.getElementById('edit-job-date').value = job.date;
                document.getElementById('edit-job-time').value = job.time || '';
                document.getElementById('edit-client-name').value = job.clientName;
                document.getElementById('edit-client-phone').value = job.clientPhone;
                document.getElementById('edit-client-email').value = job.clientEmail;
                document.getElementById('edit-apartment-size').value = job.apartmentSize;
                document.getElementById('edit-apartment-size-custom').value = job.apartmentSizeCustom || '';
                document.getElementById('edit-move-from').value = job.moveFrom;
                document.getElementById('edit-move-to').value = job.moveTo;
                document.getElementById('edit-job-status').value = job.status;

                // Handle custom apartment size
                this.handleEditApartmentSizeChange();

                // Populate team leader dropdown
                const teamLeaderSelect = document.getElementById('edit-team-leader-assign');
                if (teamLeaderSelect) {
                    teamLeaderSelect.innerHTML = '<option value="">Select Team Leader</option>';
                    this.data.teamLeaders.forEach(tl => {
                        const option = document.createElement('option');
                        option.value = tl.name;
                        option.textContent = tl.name;
                        if (tl.name === job.teamLeader) option.selected = true;
                        teamLeaderSelect.appendChild(option);
                    });
                }

                // Populate staff dropdown (with designation only for admin)
                const staffSelect = document.getElementById('edit-assign-staff');
                if (staffSelect) {
                    staffSelect.innerHTML = '';
                    const showDesignation = this.currentRole === 'admin';
                    this.data.staff.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.name;
                        if (showDesignation) {
                            const designation = staff.designation || 'N/A';
                            option.textContent = `${staff.name} - ${designation}`;
                        } else {
                            option.textContent = staff.name;
                        }
                        if (job.assignedStaff && job.assignedStaff.includes(staff.name)) {
                            option.selected = true;
                        }
                        staffSelect.appendChild(option);
                    });
                }

                this.showModal('edit-job-modal');
            }

            // Update Job Method
            updateJob() {
                const jobId = document.getElementById('edit-job-id').value;
                const job = this.data.jobs.find(j => j.id == jobId);
                if (!job) {
                    this.showNotification('Job not found', 'error');
                    return;
                }

                // Get form data
                const updatedJob = {
                    ...job,
                    date: document.getElementById('edit-job-date').value,
                    time: document.getElementById('edit-job-time').value,
                    clientName: document.getElementById('edit-client-name').value,
                    clientPhone: document.getElementById('edit-client-phone').value,
                    clientEmail: document.getElementById('edit-client-email').value,
                    apartmentSize: document.getElementById('edit-apartment-size').value,
                    apartmentSizeCustom: document.getElementById('edit-apartment-size-custom').value,
                    moveFrom: document.getElementById('edit-move-from').value,
                    moveTo: document.getElementById('edit-move-to').value,
                    teamLeader: document.getElementById('edit-team-leader-assign').value,
                    assignedStaff: Array.from(document.getElementById('edit-assign-staff').selectedOptions).map(option => option.value).filter(v => v),
                    status: document.getElementById('edit-job-status').value
                };

                // Keep apartment size fields separate (don't overwrite apartmentSize with custom text)
                // apartmentSize will remain as 'custom' and apartmentSizeCustom will have the actual text
                // This ensures the edit form can properly show the custom field when editing again
                if (updatedJob.apartmentSize !== 'custom') {
                    updatedJob.apartmentSizeCustom = '';
                }

                // Validate required fields
                if (!updatedJob.clientName || !updatedJob.date || !updatedJob.time || !updatedJob.moveFrom || !updatedJob.moveTo) {
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Update job via API
                fetch(`/api/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedJob)
                })
                .then(res => res.json())
                .then(updated => {
                    // Update local data
                    const index = this.data.jobs.findIndex(j => j.id == jobId);
                    if (index !== -1) {
                        this.data.jobs[index] = updated;
                    }
                    
                    this.showNotification('Job updated successfully!', 'success');
                    this.hideModals();
                    this.populateCurrentJobs();
                })
                .catch(err => {
                    console.error('Error updating job:', err);
                    this.showNotification('Error updating job', 'error');
                });
            }

            // Delete Job Method
            deleteJob(jobId) {
                if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                    return;
                }

                fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to delete job');
                    return res.json();
                })
                .then(() => {
                    // Remove from local data
                    const index = this.data.jobs.findIndex(j => j.id == jobId);
                    if (index !== -1) {
                        this.data.jobs.splice(index, 1);
                    }
                    
                    this.showNotification('Job deleted successfully!', 'success');
                    this.populateCurrentJobs();
                    this.loadDashboard();
                })
                .catch(err => {
                    console.error('Error deleting job:', err);
                    this.showNotification('Error deleting job', 'error');
                });
            }

            // Add Methods
            addSupervisor() {
                console.log('addSupervisor called');
                
                const emiratesFrontInput = document.getElementById('new-supervisor-emirates-front');
                const emiratesBackInput = document.getElementById('new-supervisor-emirates-back');
                
                // Get form values
                const name = document.getElementById('new-supervisor-name').value.trim();
                const phone = document.getElementById('new-supervisor-phone').value.trim();
                const email = document.getElementById('new-supervisor-email').value.trim();
                const designation = document.getElementById('new-supervisor-designation').value.trim();
                const username = document.getElementById('new-supervisor-username').value.trim();
                const password = document.getElementById('new-supervisor-password').value;

                console.log('Form values:', { name, phone, email, designation, username, password: password ? '***' : 'empty' });

                // Validate required fields
                if (!name || !phone || !email || !username || !password) {
                    console.error('Validation failed - missing required fields');
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Validate email format
                if (email && !this.isValidEmail(email)) {
                    this.showNotification('Please enter a valid email address', 'error');
                    return;
                }

                // Validate phone format
                if (phone && !this.isValidPhone(phone)) {
                    this.showNotification('Please enter a valid phone number', 'error');
                    return;
                }

                // Validate password length
                if (password.length < 6) {
                    this.showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                const newSupervisor = {
                    name,
                    phone,
                    email,
                    designation: designation || 'Supervisor',
                    username,
                    password,
                    status: 'available',
                    profileImage: '',
                    emiratesIdFront: emiratesFrontInput?.dataset.uploadUrl || '',
                    emiratesIdBack: emiratesBackInput?.dataset.uploadUrl || ''
                };

                console.log('Adding supervisor:', newSupervisor); // Debug log

                fetch('/api/supervisors', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(newSupervisor) 
                })
                .then(res => {
                    console.log('Response status:', res.status); // Debug log
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then((data) => {
                    console.log('Supervisor added:', data); // Debug log
                this.hideModals();
                this.loadSupervisors();
                this.showNotification('Supervisor added successfully!', 'success');
                    // Reset form
                    document.getElementById('add-supervisor-form').reset();
                })
                .catch((error) => {
                    console.error('Error adding supervisor:', error);
                    this.showNotification('Failed to add supervisor: ' + error.message, 'error');
                });
            }

            addTeamLeader() {
                console.log('addTeamLeader called');
                
                const emiratesFrontInput = document.getElementById('new-teamleader-emirates-front');
                const emiratesBackInput = document.getElementById('new-teamleader-emirates-back');
                
                // Get form values
                const name = document.getElementById('new-teamleader-name').value.trim();
                const phone = document.getElementById('new-teamleader-phone').value.trim();
                const email = document.getElementById('new-teamleader-email').value.trim();
                const designation = document.getElementById('new-teamleader-designation').value.trim();
                const username = document.getElementById('new-teamleader-username').value.trim();
                const password = document.getElementById('new-teamleader-password').value;

                console.log('Form values:', { name, phone, email, designation, username, password: password ? '***' : 'empty' });

                // Validate required fields
                if (!name || !phone || !email || !username || !password) {
                    console.error('Validation failed - missing required fields');
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Validate email format
                if (email && !this.isValidEmail(email)) {
                    this.showNotification('Please enter a valid email address', 'error');
                    return;
                }

                // Validate phone format
                if (phone && !this.isValidPhone(phone)) {
                    this.showNotification('Please enter a valid phone number', 'error');
                    return;
                }

                // Validate password length
                if (password.length < 6) {
                    this.showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                const newTeamLeader = {
                    name,
                    phone,
                    email,
                    designation: designation || 'Team Leader',
                    username,
                    password,
                    jobsCompleted: 0,
                    jobsDelayed: 0,
                    status: 'available',
                    profileImage: '',
                    emiratesIdFront: emiratesFrontInput?.dataset.uploadUrl || '',
                    emiratesIdBack: emiratesBackInput?.dataset.uploadUrl || '',
                    assignedStaff: []
                };

                console.log('Adding team leader:', newTeamLeader); // Debug log

                fetch('/api/teamleaders', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(newTeamLeader) 
                })
                .then(res => {
                    console.log('Response status:', res.status); // Debug log
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then((data) => {
                    console.log('Team leader added:', data); // Debug log
                this.hideModals();
                this.loadTeamLeaders();
                this.showNotification('Team Leader added successfully!', 'success');
                    // Reset form
                    document.getElementById('add-teamleader-form').reset();
                })
                .catch((error) => {
                    console.error('Error adding team leader:', error);
                    this.showNotification('Failed to add team leader: ' + error.message, 'error');
                });
            }

            addStaff() {
                console.log('addStaff called');
                
                const emiratesFrontInput = document.getElementById('new-staff-emirates-front');
                const emiratesBackInput = document.getElementById('new-staff-emirates-back');
                
                // Get form values
                const name = document.getElementById('new-staff-name').value.trim();
                const phone = document.getElementById('new-staff-phone').value.trim();
                const email = document.getElementById('new-staff-email').value.trim();
                const designation = this.currentRole === 'admin' ? document.getElementById('new-staff-designation').value.trim() : '';
                const username = document.getElementById('new-staff-username').value.trim();
                const password = document.getElementById('new-staff-password').value;
                const teamLeader = document.getElementById('new-staff-teamleader').value;

                console.log('Form values:', { name, phone, email, designation, username, password: password ? '***' : 'empty', teamLeader });

                // Validate required fields (designation only required for admin)
                if (!name || !phone || !email || !username || !password) {
                    console.error('Validation failed - missing required fields');
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Validate designation for admin
                if (this.currentRole === 'admin' && !designation) {
                    this.showNotification('Please select a designation', 'error');
                    return;
                }

                // Validate email format
                if (email && !this.isValidEmail(email)) {
                    this.showNotification('Please enter a valid email address', 'error');
                    return;
                }

                // Validate phone format
                if (phone && !this.isValidPhone(phone)) {
                    this.showNotification('Please enter a valid phone number', 'error');
                    return;
                }

                // Validate password length
                if (password.length < 6) {
                    this.showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                const newStaff = {
                    name,
                    phone,
                    email,
                    designation: this.currentRole === 'admin' ? (designation || 'Staff') : 'Staff', // Only admin can set designation
                    username,
                    password,
                    teamLeader: teamLeader || '',
                    status: 'available',
                    profileImage: '',
                    isTeamLeader: false,
                    emiratesIdFront: emiratesFrontInput?.dataset.uploadUrl || '',
                    emiratesIdBack: emiratesBackInput?.dataset.uploadUrl || ''
                };

                console.log('Adding staff:', newStaff); // Debug log

                fetch('/api/staff', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(newStaff) 
                })
                .then(res => {
                    console.log('Response status:', res.status); // Debug log
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then((data) => {
                    console.log('Staff added:', data); // Debug log
                this.hideModals();
                this.loadStaff();
                this.showNotification('Staff added successfully!', 'success');
                    // Reset form
                    document.getElementById('add-staff-form').reset();
                })
                .catch((error) => {
                    console.error('Error adding staff:', error);
                    this.showNotification('Failed to add staff: ' + error.message, 'error');
                });
            }

            // Survey Methods
            showAddSurveyModal() {
                // Populate assigned to dropdown with supervisors and team leaders
                const assignedToSelect = document.getElementById('new-survey-assigned-to');
                assignedToSelect.innerHTML = '<option value="">Select Person</option>';
                
                // Add supervisors
                this.data.supervisors.forEach(sup => {
                    const option = document.createElement('option');
                    option.value = sup.name;
                    option.textContent = `${sup.name} (Supervisor)`;
                    assignedToSelect.appendChild(option);
                });
                
                // Add team leaders
                this.data.teamLeaders.forEach(tl => {
                    const option = document.createElement('option');
                    option.value = tl.name;
                    option.textContent = `${tl.name} (Team Leader)`;
                    assignedToSelect.appendChild(option);
                });
                
                // Reset form
                document.getElementById('add-survey-form').reset();
                const sizeInput = document.getElementById('new-survey-apartment-size');
                if (sizeInput) sizeInput.value = '';
                this.showModal('add-survey-modal');

            }

            addSurvey() {
                const clientName = document.getElementById('new-survey-client-name').value.trim();
                const clientNumber = document.getElementById('new-survey-client-number').value.trim();
                const location = document.getElementById('new-survey-location').value.trim();
                const apartmentSize = document.getElementById('new-survey-apartment-size').value.trim();
                const surveyDate = document.getElementById('new-survey-date').value;
                const surveyTime = document.getElementById('new-survey-time').value;
                const assignedTo = document.getElementById('new-survey-assigned-to').value;

                if (!clientName || !clientNumber || !location || !apartmentSize || !surveyDate || !surveyTime || !assignedTo) {
                    this.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const newSurvey = {
                    clientName,
                    clientNumber,
                    location,
                    apartmentSize,
                    surveyDate,
                    surveyTime,
                    assignedTo,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                fetch('/api/surveys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newSurvey)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then((data) => {
                    this.hideModals();
                    this.loadSurveys();
                    this.showNotification('Survey created successfully!', 'success');
                    document.getElementById('add-survey-form').reset();
                })
                .catch((error) => {
                    console.error('Error adding survey:', error);
                    this.showNotification('Failed to create survey: ' + error.message, 'error');
                });
            }

            async showCompleteSurveyModal(surveyId) {
                const survey = this.data.surveys.find(s => s.id === surveyId);
                if (!survey) {
                    this.showNotification('Survey not found', 'error');
                    return;
                }

                document.getElementById('complete-survey-id').value = surveyId;
                
                // Show survey details in preview
                const preview = document.getElementById('survey-details-preview');
                preview.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Client Name:</div>
                        <div class="detail-value">${survey.clientName}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Client Number:</div>
                        <div class="detail-value">${survey.clientNumber}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Location:</div>
                        <div class="detail-value">${survey.location}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Apartment Size:</div>
                        <div class="detail-value">${this.formatApartmentSize(survey.apartmentSize, survey.apartmentSizeCustom)}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Survey Time:</div>
                        <div class="detail-value">${survey.surveyDate} ${survey.surveyTime}</div>
                    </div>
                `;

                // Reset packing list form
                document.getElementById('complete-survey-form').reset();
                document.getElementById('survey-images').value = '';
                document.getElementById('survey-comments').value = '';
                document.getElementById('survey-client-instructions').value = '';
                document.getElementById('survey-images-preview').innerHTML = '';
                document.getElementById('pl-stamp-preview').innerHTML = '';
                
                // Reset checkboxes
                ['pl-type-cargo', 'pl-type-commercial', 'pl-type-local', 'pl-type-international', 'pl-type-storage'].forEach(id => {
                    document.getElementById(id).checked = false;
                });
                
                // Clear signature canvases
                this.clearSignature('pl-customer-signature');
                this.clearSignature('pl-moveit-signature');
                
                // Load item catalog and populate items table
                await this.loadItemCatalog();
                this.populateItemsTable([]);
                
                // If survey already has packing list data, populate it
                if (survey.packingList) {
                    this.populatePackingListForm(survey.packingList);
                }
                
                // Initialize signature canvases
                this.initSignatureCanvases();
                
                // Reset totals
                this.updatePackingListTotals();
                
                // Setup scroll hint for packing list table on mobile
                this.setupPackingListScrollHint();
                
                this.showModal('complete-survey-modal');
            }
            
            setupPackingListScrollHint() {
                const wrapper = document.getElementById('packing-list-table-wrapper');
                const hint = document.getElementById('packing-list-scroll-hint');
                if (!wrapper || !hint) return;
                
                // Show hint on mobile after modal is visible
                setTimeout(() => {
                    if (window.innerWidth <= 768) {
                        hint.style.display = 'block';
                        
                        // Hide hint when user scrolls horizontally
                        let hasScrolled = false;
                        wrapper.addEventListener('scroll', () => {
                            if (!hasScrolled && wrapper.scrollLeft > 10) {
                                hasScrolled = true;
                                hint.style.display = 'none';
                            }
                        }, { once: false });
                        
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 3000);
                    }
                }, 100);
            }

            async completeSurvey() {
                const surveyId = parseInt(document.getElementById('complete-survey-id').value);
                const comments = document.getElementById('survey-comments').value.trim();
                const clientInstructions = document.getElementById('survey-client-instructions').value.trim();
                const imagesInput = document.getElementById('survey-images');

                // Collect packing list data
                const serviceTypes = [];
                ['pl-type-cargo', 'pl-type-commercial', 'pl-type-local', 'pl-type-international', 'pl-type-storage'].forEach(id => {
                    if (document.getElementById(id).checked) {
                        serviceTypes.push(document.getElementById(id).value);
                    }
                });

                // Collect items from table
                const items = [];
                const rows = document.querySelectorAll('#packing-list-items-tbody tr');
                rows.forEach(row => {
                    const itemName = row.querySelector('.item-name')?.textContent || '';
                    const cbm = parseFloat(row.querySelector('.item-cbm')?.textContent || 0);
                    const pieces = parseInt(row.querySelector('.item-pieces')?.value || 0);
                    if (pieces > 0 || itemName) {
                        items.push({
                            name: itemName,
                            cbm: cbm,
                            pieces: pieces,
                            totalCbm: (cbm * pieces).toFixed(2)
                        });
                    }
                });

                // Collect signatures as base64
                const customerSig = document.getElementById('pl-customer-signature')?.toDataURL() || '';
                const moveitSig = document.getElementById('pl-moveit-signature')?.toDataURL() || '';

                // Upload stamp if provided
                let stampUrl = '';
                const stampInput = document.getElementById('pl-stamp');
                if (stampInput && stampInput.files && stampInput.files[0]) {
                    try {
                        stampUrl = await this.uploadFile(stampInput.files[0]);
                    } catch (error) {
                        console.error('Error uploading stamp:', error);
                    }
                }

                // Upload images
                const uploadedImages = [];
                if (imagesInput && imagesInput.files && imagesInput.files.length > 0) {
                    try {
                        for (let i = 0; i < imagesInput.files.length; i++) {
                            const file = imagesInput.files[i];
                            const url = await this.uploadFile(file);
                            if (url) uploadedImages.push(url);
                        }
                    } catch (error) {
                        console.error('Error uploading images:', error);
                        this.showNotification('Failed to upload some images', 'warning');
                    }
                }

                // Build packing list object
                const packingList = {
                    companyName: document.getElementById('pl-company-name').value.trim(),
                    personName: document.getElementById('pl-person-name').value.trim(),
                    mobile: document.getElementById('pl-mobile').value.trim(),
                    email: document.getElementById('pl-email').value.trim(),
                    source: document.getElementById('pl-source').value.trim(),
                    serviceTypes: serviceTypes,
                    origin: document.getElementById('pl-origin').value.trim(),
                    originDate: document.getElementById('pl-origin-date').value,
                    originTime: document.getElementById('pl-origin-time').value,
                    destination: document.getElementById('pl-destination').value.trim(),
                    destDate: document.getElementById('pl-dest-date').value,
                    destTime: document.getElementById('pl-dest-time').value,
                    items: items,
                    totalCurtains: parseInt(document.getElementById('pl-total-curtains').value || 0),
                    totalFixtures: parseInt(document.getElementById('pl-total-fixtures').value || 0),
                    permit: document.getElementById('pl-permit').value.trim(),
                    totalBoxes: parseInt(document.getElementById('pl-total-boxes').value || 0),
                    totalPackages: parseInt(document.getElementById('pl-total-packages').value || 0),
                    commodity: document.getElementById('pl-commodity').value.trim(),
                    totalValue: parseFloat(document.getElementById('pl-total-value').value || 0),
                    workingDays: parseInt(document.getElementById('pl-working-days').value || 0),
                    trips: parseInt(document.getElementById('pl-trips').value || 0),
                    totalCbm: parseFloat(document.getElementById('pl-total-cbm').value || 0),
                    estimatedKg: parseFloat(document.getElementById('pl-estimated-kg').value || 0),
                    amount: parseFloat(document.getElementById('pl-amount').value || 0),
                    estimator: document.getElementById('pl-estimator').value.trim(),
                    stamp: stampUrl,
                    terms: document.getElementById('pl-terms').value.trim(),
                    customerSignature: customerSig,
                    moveitSignature: moveitSig
                };

                const surveyData = {
                    images: uploadedImages,
                    comments: comments || '',
                    clientInstructions: clientInstructions || '',
                    packingList: packingList
                };

                fetch(`/api/surveys/${surveyId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(surveyData)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then((data) => {
                    this.hideModals();
                    this.loadSurveys();
                    this.showNotification('Packing list completed successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error completing survey:', error);
                    this.showNotification('Failed to complete survey: ' + error.message, 'error');
                });
            }

            // Packing List Helper Functions
            async loadItemCatalog() {
                try {
                    const res = await fetch('/api/item-catalog');
                    const catalog = await res.json();
                    this.itemCatalog = catalog || [];
                } catch (error) {
                    console.error('Error loading item catalog:', error);
                    this.itemCatalog = [];
                }
            }

            populateItemsTable(existingItems = []) {
                const tbody = document.getElementById('packing-list-items-tbody');
                tbody.innerHTML = '';
                
                // Add all items from catalog
                const catalogToAdd = existingItems.length > 0 ? existingItems : this.itemCatalog || [];
                
                catalogToAdd.forEach((item, index) => {
                    const row = this.createItemRow(item, index);
                    tbody.appendChild(row);
                });
                
                // Update totals
                this.updatePackingListTotals();
            }

            createItemRow(item, index) {
                const row = document.createElement('tr');
                const existingPieces = item.pieces || 0;
                
                row.innerHTML = `
                    <td class="item-name" style="white-space:nowrap; min-width:200px;">${item.name || ''}</td>
                    <td class="item-cbm" style="white-space:nowrap; text-align:center; min-width:80px;">${(item.cbm || 0).toFixed(2)}</td>
                    <td style="white-space:nowrap; min-width:100px;"><input type="number" class="form-control item-pieces" min="0" value="${existingPieces}" onchange="app.updatePackingListTotals()" style="width:80px; max-width:100px;"></td>
                    <td class="item-total-cbm" style="white-space:nowrap; text-align:center; min-width:100px;">${((item.cbm || 0) * existingPieces).toFixed(2)}</td>
                    <td style="white-space:nowrap; min-width:100px;"><button type="button" class="btn btn-sm btn-danger" onclick="app.removeItemFromTable(this)">Remove</button></td>
                `;
                return row;
            }

            removeItemFromTable(btn) {
                btn.closest('tr').remove();
                this.updatePackingListTotals();
            }

            filterPackingListItems() {
                const searchTerm = document.getElementById('packing-list-search')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#packing-list-items-tbody tr');
                
                rows.forEach(row => {
                    const itemName = row.querySelector('.item-name')?.textContent.toLowerCase() || '';
                    if (itemName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            updatePackingListTotals() {
                let totalCbm = 0;
                let totalPackages = 0;
                
                const rows = document.querySelectorAll('#packing-list-items-tbody tr');
                rows.forEach(row => {
                    const cbm = parseFloat(row.querySelector('.item-cbm')?.textContent || 0);
                    const pieces = parseInt(row.querySelector('.item-pieces')?.value || 0);
                    const totalRowCbm = cbm * pieces;
                    totalCbm += totalRowCbm;
                    totalPackages += pieces;
                    
                    // Update row total
                    const totalCell = row.querySelector('.item-total-cbm');
                    if (totalCell) totalCell.textContent = totalRowCbm.toFixed(2);
                });
                
                // Update totals fields
                document.getElementById('pl-total-cbm').value = totalCbm.toFixed(2);
                document.getElementById('pl-total-packages').value = totalPackages;
                
                // Estimated KG (rough calculation: 1 CBM ‚âà 300 KG)
                const estimatedKg = totalCbm * 300;
                document.getElementById('pl-estimated-kg').value = estimatedKg.toFixed(2);
            }

            initSignatureCanvases() {
                ['pl-customer-signature', 'pl-moveit-signature'].forEach(canvasId => {
                    const oldCanvas = document.getElementById(canvasId);
                    if (!oldCanvas) return;

                    // Replace to remove old listeners
                    const canvas = oldCanvas.cloneNode(true);
                    oldCanvas.parentNode.replaceChild(canvas, oldCanvas);

                    // Handle HiDPI scaling for crisp lines
                    const dpr = window.devicePixelRatio || 1;
                    const cssWidth = canvas.clientWidth || canvas.width;
                    const cssHeight = canvas.clientHeight || canvas.height;
                    canvas.width = Math.max(400, Math.round(cssWidth * dpr));
                    canvas.height = Math.max(150, Math.round(cssHeight * dpr));
                    canvas.style.width = (cssWidth || 400) + 'px';
                    canvas.style.height = (cssHeight || 150) + 'px';

                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;

                    let isDrawing = false;
                    const getPoint = (evt) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = (evt.clientX - rect.left);
                        const y = (evt.clientY - rect.top);
                        return { x, y };
                    };

                    const start = (evt) => {
                        isDrawing = true;
                        const p = getPoint(evt);
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                    };
                    const move = (evt) => {
                        if (!isDrawing) return;
                        const p = getPoint(evt);
                        ctx.lineTo(p.x, p.y);
                        ctx.stroke();
                    };
                    const stop = () => { isDrawing = false; };

                    // Mouse
                    canvas.addEventListener('mousedown', (e) => start(e));
                    canvas.addEventListener('mousemove', (e) => move(e));
                    canvas.addEventListener('mouseup', stop);
                    canvas.addEventListener('mouseleave', stop);

                    // Touch
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (e.touches && e.touches[0]) start(e.touches[0]);
                    }, { passive: false });
                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (e.touches && e.touches[0]) move(e.touches[0]);
                    }, { passive: false });
                    canvas.addEventListener('touchend', stop);
                    canvas.addEventListener('touchcancel', stop);
                });
            }

            clearSignature(canvasId) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            showAddCustomItemModal() {
                document.getElementById('add-custom-item-form').reset();
                this.showModal('add-custom-item-modal');
            }

            addCustomItem() {
                const name = document.getElementById('custom-item-name').value.trim();
                const cbm = parseFloat(document.getElementById('custom-item-cbm').value || 0);
                
                if (!name || cbm <= 0) {
                    this.showNotification('Please enter item name and valid CBM', 'error');
                    return;
                }
                
                // Add to table
                const tbody = document.getElementById('packing-list-items-tbody');
                const row = this.createItemRow({ name, cbm }, tbody.children.length);
                tbody.appendChild(row);
                
                this.hideModals();
                this.updatePackingListTotals();
                this.showNotification('Custom item added', 'success');
            }

            populatePackingListForm(data) {
                // Populate customer details
                if (data.companyName) document.getElementById('pl-company-name').value = data.companyName;
                if (data.personName) document.getElementById('pl-person-name').value = data.personName;
                if (data.mobile) document.getElementById('pl-mobile').value = data.mobile;
                if (data.email) document.getElementById('pl-email').value = data.email;
                if (data.source) document.getElementById('pl-source').value = data.source;
                
                // Populate service types
                (data.serviceTypes || []).forEach(type => {
                    const checkbox = document.getElementById(`pl-type-${type.toLowerCase()}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Populate origin/destination
                if (data.origin) document.getElementById('pl-origin').value = data.origin;
                if (data.originDate) document.getElementById('pl-origin-date').value = data.originDate;
                if (data.originTime) document.getElementById('pl-origin-time').value = data.originTime;
                if (data.destination) document.getElementById('pl-destination').value = data.destination;
                if (data.destDate) document.getElementById('pl-dest-date').value = data.destDate;
                if (data.destTime) document.getElementById('pl-dest-time').value = data.destTime;
                
                // Populate items
                if (data.items && data.items.length > 0) {
                    this.populateItemsTable(data.items);
                }
                
                // Populate totals
                if (data.totalCurtains) document.getElementById('pl-total-curtains').value = data.totalCurtains;
                if (data.totalFixtures) document.getElementById('pl-total-fixtures').value = data.totalFixtures;
                if (data.permit) document.getElementById('pl-permit').value = data.permit;
                if (data.totalBoxes) document.getElementById('pl-total-boxes').value = data.totalBoxes;
                if (data.commodity) document.getElementById('pl-commodity').value = data.commodity;
                if (data.totalValue) document.getElementById('pl-total-value').value = data.totalValue;
                if (data.workingDays) document.getElementById('pl-working-days').value = data.workingDays;
                if (data.trips) document.getElementById('pl-trips').value = data.trips;
                if (data.amount) document.getElementById('pl-amount').value = data.amount;
                if (data.estimator) document.getElementById('pl-estimator').value = data.estimator;
                if (data.terms) document.getElementById('pl-terms').value = data.terms;
                
                // Load signatures if they exist
                if (data.customerSignature) {
                    const canvas = document.getElementById('pl-customer-signature');
                    if (canvas) {
                        const img = new Image();
                        img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0);
                        img.src = data.customerSignature;
                    }
                }
                if (data.moveitSignature) {
                    const canvas = document.getElementById('pl-moveit-signature');
                    if (canvas) {
                        const img = new Image();
                        img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0);
                        img.src = data.moveitSignature;
                    }
                }
                
                // Load stamp if exists
                if (data.stamp) {
                    const preview = document.getElementById('pl-stamp-preview');
                    preview.innerHTML = `<img src="${this.getImageUrl(data.stamp)}" style="max-width:200px; max-height:200px; border:1px solid #ddd; border-radius:4px;">`;
                }
            }

            showSurveyDetails(surveyId) {
                const survey = this.data.surveys.find(s => s.id === surveyId);
                if (!survey) {
                    this.showNotification('Survey not found', 'error');
                    return;
                }

                const body = document.getElementById('survey-details-body');
                const surveyData = survey.surveyData || {};
                const images = surveyData.images || [];

                body.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Survey ID:</div>
                        <div class="detail-value">#${survey.id}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Client Name:</div>
                        <div class="detail-value">${survey.clientName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Client Number:</div>
                        <div class="detail-value">${survey.clientNumber || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Location:</div>
                        <div class="detail-value">${survey.location || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Apartment Size:</div>
                        <div class="detail-value">${this.formatApartmentSize(survey.apartmentSize, survey.apartmentSizeCustom) || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Survey Time:</div>
                        <div class="detail-value">${survey.surveyDate || 'N/A'} ${survey.surveyTime || ''}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Assigned To:</div>
                        <div class="detail-value">${survey.assignedTo || 'Unassigned'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge status-${survey.status}">${this.formatStatus(survey.status)}</span></div>
                    </div>
                    ${survey.status === 'completed' ? `
                        <div class="detail-row">
                            <div class="detail-label">Completed At:</div>
                            <div class="detail-value">${survey.completedAt ? new Date(survey.completedAt).toLocaleString() : 'N/A'}</div>
                        </div>
                        ${images.length > 0 ? `
                            <div class="detail-row">
                                <div class="detail-label">Apartment Images:</div>
                                <div class="detail-value">
                                    <div class="image-gallery">
                                        ${images.map(img => `
                                            <div class="image-item" onclick="app.showImageModal('${img}')">
                                                <img src="${app.getImageUrl(img)}" alt="Apartment Image" onerror="this.style.display='none'">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        ${surveyData.comments ? `
                            <div class="detail-row">
                                <div class="detail-label">Comments/Notes:</div>
                                <div class="detail-value" style="white-space: pre-wrap; background: #f0f9ff; padding: 12px; border-radius: 8px;">${surveyData.comments}</div>
                            </div>
                        ` : ''}
                        ${surveyData.clientInstructions ? `
                            <div class="detail-row">
                                <div class="detail-label">Client Instructions:</div>
                                <div class="detail-value" style="white-space: pre-wrap; background: #fef3c7; padding: 12px; border-radius: 8px;">${surveyData.clientInstructions}</div>
                            </div>
                        ` : ''}
                    ` : ''}
                `;

                this.showModal('survey-details-modal');

                const downloadBtn = document.getElementById('download-survey-report');
                if (downloadBtn) {
                    downloadBtn.onclick = () => this.downloadSurveyReport(surveyId);
                }
            }

            async downloadSurveyReport(surveyId) {
                const survey = this.data.surveys.find(s => s.id === surveyId);
                if (!survey) return;
                const container = document.createElement('div');
                const surveyData = survey.surveyData || {};
                const images = surveyData.images || [];
                const pl = survey.packingList || null;
                const itemsTable = pl && pl.items && pl.items.length ? `
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                                <thead>
                            <tr>
                                <th style="border:1px solid #e5e7eb; padding:6px; text-align:left;">Items</th>
                                <th style="border:1px solid #e5e7eb; padding:6px;">CBM</th>
                                <th style="border:1px solid #e5e7eb; padding:6px;">Nos. of Pcs</th>
                                <th style="border:1px solid #e5e7eb; padding:6px;">Total CBM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pl.items.map(it => `
                                <tr>
                                    <td style=\"border:1px solid #e5e7eb; padding:6px;\">${it.name || ''}</td>
                                    <td style=\"border:1px solid #e5e7eb; padding:6px; text-align:center;\">${Number(it.cbm || 0).toFixed(2)}</td>
                                    <td style=\"border:1px solid #e5e7eb; padding:6px; text-align:center;\">${it.pieces || 0}</td>
                                    <td style=\"border:1px solid #e5e7eb; padding:6px; text-align:center;\">${Number(it.totalCbm || (it.cbm||0)*(it.pieces||0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '';
                // Branding logo (if set)
                let logoHtml = '';
                try {
                    const branding = await fetch('/api/branding').then(r=>r.json());
                    if (branding && branding.logoUrl) {
                        logoHtml = `<div style=\\"margin-bottom:12px;\\"><img src=\\"${this.getImageUrl(branding.logoUrl)}\\" style=\\"height:36px; width:auto;\\"/></div>`;
                    }
                } catch(e) {}

                container.innerHTML = `
                    <div style="font-family: Arial, sans-serif; padding: 16px; color:#111827;">
                        ${logoHtml}
                        <h2 style="margin:0 0 12px;">Survey Report #${survey.id}</h2>
                        <div style="margin:8px 0;"><strong>Client:</strong> ${survey.clientName} (${survey.clientNumber})</div>
                        <div style="margin:8px 0;"><strong>Location:</strong> ${survey.location}</div>
                        <div style="margin:8px 0;"><strong>Apartment Size:</strong> ${this.formatApartmentSize(survey.apartmentSize, survey.apartmentSizeCustom)}</div>
                        <div style="margin:8px 0;"><strong>Survey Time:</strong> ${survey.surveyDate} ${survey.surveyTime}</div>
                        <div style="margin:8px 0;"><strong>Assigned To:</strong> ${survey.assignedTo || 'Unassigned'}</div>
                        <div style="margin:8px 0;"><strong>Status:</strong> ${this.formatStatus(survey.status)}</div>
                        ${survey.completedAt ? `<div style=\"margin:8px 0;\"><strong>Completed At:</strong> ${new Date(survey.completedAt).toLocaleString()}</div>` : ''}
                        ${pl ? `
                        <hr style=\"margin:16px 0; border:none; border-top:1px solid #e5e7eb;\"/>
                        <h3 style=\"margin:0 0 8px;\">Packing List ${pl.serialNo ? `- S.No. ${pl.serialNo}` : ''}</h3>
                        <div style=\"display:grid; grid-template-columns:repeat(2,1fr); gap:8px;\">
                            <div><strong>Company:</strong> ${pl.companyName || ''}</div>
                            <div><strong>Person:</strong> ${pl.personName || ''}</div>
                            <div><strong>Mobile:</strong> ${pl.mobile || ''}</div>
                            <div><strong>Email:</strong> ${pl.email || ''}</div>
                            <div><strong>Service:</strong> ${(pl.serviceTypes||[]).join(', ')}</div>
                            <div><strong>Source:</strong> ${pl.source || ''}</div>
                            <div><strong>Origin:</strong> ${pl.origin || ''} ${pl.originDate || ''} ${pl.originTime || ''}</div>
                            <div><strong>Destination:</strong> ${pl.destination || ''} ${pl.destDate || ''} ${pl.destTime || ''}</div>
                        </div>
                        <div style=\"margin:10px 0;\">${itemsTable}</div>
                        <div style=\"display:grid; grid-template-columns:repeat(3,1fr); gap:8px;\">
                            <div><strong>Total Curtains/Blinds:</strong> ${pl.totalCurtains || 0}</div>
                            <div><strong>Total Wall Fixtures:</strong> ${pl.totalFixtures || 0}</div>
                            <div><strong>BLDG. PERMIT:</strong> ${pl.permit || ''}</div>
                            <div><strong>Total Boxes:</strong> ${pl.totalBoxes || 0}</div>
                            <div><strong>Total Packages:</strong> ${pl.totalPackages || 0}</div>
                            <div><strong>Commodity:</strong> ${pl.commodity || ''}</div>
                            <div><strong>Total Value:</strong> ${pl.totalValue || 0}</div>
                            <div><strong>Working Days:</strong> ${pl.workingDays || 0}</div>
                            <div><strong>No. of Trips:</strong> ${pl.trips || 0}</div>
                            <div><strong>Total CBM:</strong> ${Number(pl.totalCbm || 0).toFixed(2)}</div>
                            <div><strong>Estimated KG:</strong> ${Number(pl.estimatedKg || 0).toFixed(2)}</div>
                            <div><strong>Amount:</strong> ${pl.amount || 0}</div>
                        </div>
                        ${pl.terms ? `<div style=\"margin:12px 0;\"><strong>Terms:</strong><div style=\"white-space:pre-wrap; background:#f8fafc; padding:10px; border-radius:8px;\">${pl.terms}</div></div>` : ''}
                        ` : ''}
                        ${surveyData.comments ? `<div style=\"margin:12px 0;\"><strong>Comments/Notes:</strong><div style=\"white-space:pre-wrap; background:#f0f9ff; padding:10px; border-radius:8px;\">${surveyData.comments}</div></div>` : ''}
                        ${surveyData.clientInstructions ? `<div style=\"margin:12px 0;\"><strong>Client Instructions:</strong><div style=\"white-space:pre-wrap; background:#fef3c7; padding:10px; border-radius:8px;\">${surveyData.clientInstructions}</div></div>` : ''}
                        ${images.length ? `<div style=\"margin:12px 0;\"><strong>Images:</strong><div style=\"display:flex; flex-wrap:wrap; gap:10px;\">${images.map(u => `<img src=\"${this.getImageUrl(u)}\" style=\"width:180px; height:auto; border:1px solid #e5e7eb; border-radius:6px;\"/>`).join('')}</div></div>` : ''}
                    </div>
                `;
                const w = window.open('', '_blank');
                if (!w) return;
                w.document.write('<html><head><title>Survey Report</title><style>@page{size:auto; margin:12mm;} body{margin:0;}</style></head><body>' + container.innerHTML + '</body></html>');
                w.document.close();
                w.focus();
                // Give images a moment to load before printing
                setTimeout(() => { try { w.print(); } catch (e) {} }, 500);
            }

            filterSurveys() {
                const searchTerm = document.getElementById('surveys-search').value.toLowerCase();
                const rows = document.querySelectorAll('#surveys-table tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            // View Details Methods
            showJobDetails(jobId) {
                const job = this.data.jobs.find(j => j.id === jobId);
                if (!job) return;

                // Get assigned staff details
                const assignedStaff = this.data.staff.filter(staff => 
                    job.assignedStaff.includes(staff.name)
                );

                const body = document.getElementById('job-details-body');
                body.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Job ID:</div>
                        <div class="detail-value">#${job.id}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Client Name:</div>
                        <div class="detail-value">${job.clientName}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${job.clientPhone || job.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${job.clientEmail || job.email || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving Date:</div>
                        <div class="detail-value">${job.date}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving Time:</div>
                        <div class="detail-value">${job.time || 'Not specified'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Apartment Size:</div>
                        <div class="detail-value">${job.apartmentSize === 'custom' ? (job.apartmentSizeCustom || 'Custom (not specified)') : (job.apartmentSize || 'Not specified')}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving From:</div>
                        <div class="detail-value">${job.moveFrom}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving To:</div>
                        <div class="detail-value">${job.moveTo}</div>
                    </div>
                    ${job.instructions ? `
                    <div class="detail-row">
                        <div class="detail-label">Special Instructions:</div>
                        <div class="detail-value" style="white-space: pre-wrap; background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 8px;"></i>${job.instructions}
                        </div>
                    </div>
                    ` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Team Leader:</div>
                        <div class="detail-value">
                            ${job.teamLeader ? `
                                <div class="team-leader-info">
                                    <h4>${job.teamLeader}</h4>
                                    ${(() => {
                                        const teamLeader = this.data.teamLeaders.find(tl => tl.name === job.teamLeader);
                                        if (teamLeader && (teamLeader.emiratesIdFront || teamLeader.emiratesIdBack)) {
                                            return `
                                                <div class="emirates-id-display">
                                                    ${teamLeader.emiratesIdFront ? `
                                                        <div class="emirates-id-item">
                                                            <h4>Emirates ID Front</h4>
                                                            <img src="${app.getImageUrl(teamLeader.emiratesIdFront)}" alt="Emirates ID Front" onclick="app.showImageModal('${teamLeader.emiratesIdFront}')">
                                                        </div>
                                                    ` : ''}
                                                    ${teamLeader.emiratesIdBack ? `
                                                        <div class="emirates-id-item">
                                                            <h4>Emirates ID Back</h4>
                                                            <img src="${app.getImageUrl(teamLeader.emiratesIdBack)}" alt="Emirates ID Back" onclick="app.showImageModal('${teamLeader.emiratesIdBack}')">
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }
                                        return '';
                                    })()}
                                </div>
                            ` : 'No team leader assigned'}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge status-${job.status}">${this.formatStatus(job.status)}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Assigned Staff:</div>
                        <div class="detail-value">
                            <div class="staff-list">
                                ${assignedStaff.length > 0 ? assignedStaff.map(staff => `
                                    <div class="staff-card">
                                        <img src="${app.getImageUrl(staff.profileImage || '')}" alt="${staff.name}" onerror="this.style.display='none'">
                                        <h4>${staff.name}</h4>
                                        <p>${staff.designation}</p>
                                        ${staff.emiratesIdFront || staff.emiratesIdBack ? `
                                            <div class="emirates-id-display">
                                                ${staff.emiratesIdFront ? `
                                                    <div class="emirates-id-item">
                                                        <h4>Emirates ID Front</h4>
                                                        <img src="${app.getImageUrl(staff.emiratesIdFront)}" alt="Emirates ID Front" onclick="app.showImageModal('${staff.emiratesIdFront}')">
                                                    </div>
                                                ` : ''}
                                                ${staff.emiratesIdBack ? `
                                                    <div class="emirates-id-item">
                                                        <h4>Emirates ID Back</h4>
                                                        <img src="${app.getImageUrl(staff.emiratesIdBack)}" alt="Emirates ID Back" onclick="app.showImageModal('${staff.emiratesIdBack}')">
                                                    </div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : 'No staff assigned'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving Out Permit:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${job.moveOutPermit ? `
                                    <div class="image-item" onclick="app.showImageModal('${job.moveOutPermit}')">
                                        <img src="${app.getImageUrl(job.moveOutPermit)}" alt="Move Out Permit" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Moving In Permit:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${job.moveInPermit ? `
                                    <div class="image-item" onclick="app.showImageModal('${job.moveInPermit}')">
                                        <img src="${app.getImageUrl(job.moveInPermit)}" alt="Move In Permit" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Item Images:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${job.itemImages && job.itemImages.length > 0 ? job.itemImages.map((img, index) => `
                                    <div class="image-item" onclick="app.showImageModal('${img}')">
                                        <img src="${app.getImageUrl(img)}" alt="Item Image" onerror="this.style.display='none'">
                                        ${this.currentRole === 'admin' && job.status === 'completed' ? `
                                            <button class="delete-image-btn" onclick="event.stopPropagation(); app.deleteItemImage(${job.id}, ${index}, '${img}')" title="Delete Image">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('') : 'No item images available'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Job History Section -->
                    <div class="job-history-container">
                        <h3>Job History</h3>
                        <div class="history-timeline">
                            ${this.renderJobHistory(job)}
                        </div>
                        
                        <!-- Bills Section -->
                        ${this.renderJobBills(job)}
                        
                        <!-- Attach Bill Button (for Admin, Supervisor, Team Leader) -->
                        ${['admin', 'supervisor', 'teamleader'].includes(this.currentRole) ? `
                            <button class="btn btn-success attach-bill-btn" id="attach-bill-btn-${job.id}" data-job-id="${job.id}">
                                <i class="fas fa-file-invoice-dollar"></i> Attach Bill
                            </button>
                        ` : ''}
                    </div>
                `;

                this.showModal('job-details-modal');
                
                // Attach event listener to the bill button after modal is shown
                setTimeout(() => {
                    const billBtn = document.getElementById(`attach-bill-btn-${job.id}`);
                    if (billBtn) {
                        console.log('Bill button found, attaching event listener');
                        billBtn.onclick = (e) => {
                            console.log('Bill button clicked!');
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Visual feedback
                            billBtn.disabled = true;
                            billBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening...';
                            
                            // Small delay to show the feedback
                            setTimeout(() => {
                                this.showAttachBillModal(job.id);
                                // Re-enable button
                                setTimeout(() => {
                                    billBtn.disabled = false;
                                    billBtn.innerHTML = '<i class="fas fa-file-invoice-dollar"></i> Attach Bill';
                                }, 500);
                            }, 200);
                        };
                    } else {
                        console.log('Bill button not found. Current role:', this.currentRole);
                        console.log('Allowed roles:', ['admin', 'supervisor', 'teamleader']);
                        console.log('Role check:', ['admin', 'supervisor', 'teamleader'].includes(this.currentRole));
                    }
                }, 100);
            }

            async deleteItemImage(jobId, imageIndex, imageUrl) {
                if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
                    return;
                }

                if (this.currentRole !== 'admin') {
                    this.showNotification('Only administrators can delete images', 'error');
                    return;
                }

                try {
                    // Delete image from backend
                    const response = await fetch(`/api/jobs/${jobId}/images/${imageIndex}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete image');
                    }

                    const result = await response.json();
                    
                    // Update local data
                    const job = this.data.jobs.find(j => j.id === jobId);
                    if (job && job.itemImages) {
                        job.itemImages.splice(imageIndex, 1);
                    }

                    this.showNotification('Image deleted successfully', 'success');
                    
                    // Reload job details to show updated images
                    this.showJobDetails(jobId);
                } catch (error) {
                    console.error('Error deleting image:', error);
                    this.showNotification('Failed to delete image', 'error');
                }
            }

            async showSupervisorDetails(supervisorId) {
                // Always refresh from backend to avoid stale data across roles/sessions
                await this.fetchPeople('supervisors');
                const supervisor = this.data.supervisors.find(s => s.id === supervisorId);
                if (!supervisor) return;

                const body = document.getElementById('supervisor-details-body');
                const userFallback = this.data.users && this.data.users[supervisor.username] ? this.data.users[supervisor.username] : {};
                const supProfileImage = supervisor.profileImage || userFallback.profileImage || '';
                const supEmiFront = supervisor.emiratesIdFront || userFallback.emiratesIdFront || '';
                const supEmiBack = supervisor.emiratesIdBack || userFallback.emiratesIdBack || '';
                body.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Name:</div>
                        <div class="detail-value">${supervisor.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${supervisor.phone}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${supervisor.email}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Designation:</div>
                        <div class="detail-value">${supervisor.designation}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Username:</div>
                        <div class="detail-value">${supervisor.username}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge status-${supervisor.status}">${this.formatStatus(supervisor.status)}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Profile Image:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${supProfileImage ? `
                                    <div class="image-item" onclick="app.showImageModal('${supProfileImage}')">
                                        <img src="${app.getImageUrl(supProfileImage)}" alt="Profile Image" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No profile image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Front):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${supEmiFront ? `
                                    <div class="image-item" onclick="app.showImageModal('${supEmiFront}')">
                                        <img src="${app.getImageUrl(supEmiFront)}" alt="Emirates ID Front" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID front image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Back):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${supEmiBack ? `
                                    <div class="image-item" onclick="app.showImageModal('${supEmiBack}')">
                                        <img src="${app.getImageUrl(supEmiBack)}" alt="Emirates ID Back" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID back image available'}
                            </div>
                        </div>
                    </div>
                `;

                this.showModal('supervisor-details-modal');
            }

            async showTeamLeaderDetails(teamLeaderId) {
                // Always refresh from backend to avoid stale data across roles/sessions
                await this.fetchPeople('teamLeaders');
                const teamLeader = this.data.teamLeaders.find(t => t.id === teamLeaderId);
                if (!teamLeader) return;

                const body = document.getElementById('teamleader-details-body');
                body.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Name:</div>
                        <div class="detail-value">${teamLeader.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${teamLeader.phone}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${teamLeader.email}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Designation:</div>
                        <div class="detail-value">${teamLeader.designation}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Username:</div>
                        <div class="detail-value">${teamLeader.username}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Jobs Completed:</div>
                        <div class="detail-value">${teamLeader.jobsCompleted}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Jobs Delayed:</div>
                        <div class="detail-value">${teamLeader.jobsDelayed}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge status-${teamLeader.status}">${this.formatStatus(teamLeader.status)}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Profile Image:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${teamLeader.profileImage ? `
                                    <div class="image-item" onclick="app.showImageModal('${teamLeader.profileImage}')">
                                        <img src="${app.getImageUrl(teamLeader.profileImage)}" alt="Profile Image" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No profile image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Front):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${teamLeader.emiratesIdFront ? `
                                    <div class="image-item" onclick="app.showImageModal('${teamLeader.emiratesIdFront}')">
                                        <img src="${app.getImageUrl(teamLeader.emiratesIdFront)}" alt="Emirates ID Front" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID front image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Back):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${teamLeader.emiratesIdBack ? `
                                    <div class="image-item" onclick="app.showImageModal('${teamLeader.emiratesIdBack}')">
                                        <img src="${app.getImageUrl(teamLeader.emiratesIdBack)}" alt="Emirates ID Back" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID back image available'}
                            </div>
                        </div>
                    </div>
                `;

                this.showModal('teamleader-details-modal');
            }

            async showStaffDetails(staffId) {
                // Always refresh from backend to avoid stale data across roles/sessions
                await this.fetchPeople('staff');
                const staff = this.data.staff.find(s => s.id === staffId);
                if (!staff) return;

                const body = document.getElementById('staff-details-body');
                body.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Name:</div>
                        <div class="detail-value">${staff.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${staff.phone}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${staff.email}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Designation:</div>
                        <div class="detail-value">${staff.designation}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Username:</div>
                        <div class="detail-value">${staff.username}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Team Leader:</div>
                        <div class="detail-value">${staff.teamLeader}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value"><span class="status-badge status-${staff.status}">${this.formatStatus(staff.status)}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Profile Image:</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${staff.profileImage ? `
                                    <div class="image-item" onclick="app.showImageModal('${staff.profileImage}')">
                                        <img src="${app.getImageUrl(staff.profileImage)}" alt="Profile Image" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No profile image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Front):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${staff.emiratesIdFront ? `
                                    <div class="image-item" onclick="app.showImageModal('${staff.emiratesIdFront}')">
                                        <img src="${app.getImageUrl(staff.emiratesIdFront)}" alt="Emirates ID Front" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID front image available'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Emirates ID (Back):</div>
                        <div class="detail-value">
                            <div class="image-gallery">
                                ${staff.emiratesIdBack ? `
                                    <div class="image-item" onclick="app.showImageModal('${staff.emiratesIdBack}')">
                                        <img src="${app.getImageUrl(staff.emiratesIdBack)}" alt="Emirates ID Back" onerror="this.style.display='none'">
                                    </div>
                                ` : 'No Emirates ID back image available'}
                            </div>
                        </div>
                    </div>
                `;

                this.showModal('staff-details-modal');
            }

            // Edit Methods
            editSupervisor(supervisorId) {
                const supervisor = this.data.supervisors.find(s => s.id === supervisorId);
                if (!supervisor) return;

                document.getElementById('edit-supervisor-id').value = supervisor.id;
                document.getElementById('edit-supervisor-name').value = supervisor.name;
                document.getElementById('edit-supervisor-phone').value = supervisor.phone;
                document.getElementById('edit-supervisor-email').value = supervisor.email;
                document.getElementById('edit-supervisor-designation').value = supervisor.designation;
                document.getElementById('edit-supervisor-username').value = supervisor.username;
                document.getElementById('edit-supervisor-password').value = '';

                this.showModal('edit-supervisor-modal');
            }

            editTeamLeader(teamLeaderId) {
                const teamLeader = this.data.teamLeaders.find(t => t.id === teamLeaderId);
                if (!teamLeader) return;

                document.getElementById('edit-teamleader-id').value = teamLeader.id;
                document.getElementById('edit-teamleader-name').value = teamLeader.name;
                document.getElementById('edit-teamleader-phone').value = teamLeader.phone;
                document.getElementById('edit-teamleader-email').value = teamLeader.email;
                document.getElementById('edit-teamleader-designation').value = teamLeader.designation;
                document.getElementById('edit-teamleader-username').value = teamLeader.username;
                document.getElementById('edit-teamleader-password').value = '';

                this.showModal('edit-teamleader-modal');
            }

            editStaff(staffId) {
                const staff = this.data.staff.find(s => s.id === staffId);
                if (!staff) return;

                document.getElementById('edit-staff-id').value = staff.id;
                document.getElementById('edit-staff-name').value = staff.name;
                document.getElementById('edit-staff-phone').value = staff.phone;
                document.getElementById('edit-staff-email').value = staff.email;
                document.getElementById('edit-staff-designation').value = staff.designation;
                document.getElementById('edit-staff-username').value = staff.username;
                document.getElementById('edit-staff-password').value = '';
                
                // Hide designation field for supervisors (admin only)
                const designationGroup = document.getElementById('edit-staff-designation-group');
                const designationField = document.getElementById('edit-staff-designation');
                if (designationGroup && designationField) {
                    if (this.currentRole === 'admin') {
                        designationGroup.style.display = 'block';
                        designationField.required = true;
                    } else {
                        designationGroup.style.display = 'none';
                        designationField.required = false;
                    }
                }

                // Populate team leaders dropdown
                const teamLeaderSelect = document.getElementById('edit-staff-teamleader');
                teamLeaderSelect.innerHTML = '<option value="">Select Team Leader</option>';
                this.data.teamLeaders.forEach(tl => {
                    const option = document.createElement('option');
                    option.value = tl.name;
                    option.textContent = tl.name;
                    option.selected = tl.name === staff.teamLeader;
                    teamLeaderSelect.appendChild(option);
                });

                this.showModal('edit-staff-modal');
            }

            // Update Methods
            updateSupervisor() {
                const supervisorId = parseInt(document.getElementById('edit-supervisor-id').value);
                const supervisor = this.data.supervisors.find(s => s.id === supervisorId);
                
                if (supervisor) {
                    const oldUsername = supervisor.username;
                    supervisor.name = document.getElementById('edit-supervisor-name').value;
                    supervisor.phone = document.getElementById('edit-supervisor-phone').value;
                    supervisor.email = document.getElementById('edit-supervisor-email').value;
                    supervisor.designation = document.getElementById('edit-supervisor-designation').value;
                    const newUsername = document.getElementById('edit-supervisor-username').value;
                    supervisor.username = newUsername;
                    
                    const newPassword = document.getElementById('edit-supervisor-password').value;
                    const finalPassword = newPassword || (this.data.users[oldUsername]?.password || supervisor.password);
                    supervisor.password = finalPassword;
                    // Sync users map on username/password changes
                    if (oldUsername !== newUsername && this.data.users[oldUsername]) {
                        delete this.data.users[oldUsername];
                    }
                    this.data.users[newUsername] = {
                        username: newUsername,
                        password: finalPassword,
                        role: 'supervisor',
                        name: supervisor.name
                    };
                    // If current user edited self, update currentUser and storage
                    if (this.currentUser && this.currentUser.username === oldUsername) {
                        this.currentUser = { ...this.currentUser, username: newUsername, name: supervisor.name, password: finalPassword };
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    }

                    this.saveData();
                    this.hideModals();
                    this.loadSupervisors();
                    this.showNotification('Supervisor updated successfully!', 'success');
                }
            }

            updateTeamLeader() {
                const teamLeaderId = parseInt(document.getElementById('edit-teamleader-id').value);
                const teamLeader = this.data.teamLeaders.find(t => t.id === teamLeaderId);
                
                if (teamLeader) {
                    const oldUsername = teamLeader.username;
                    teamLeader.name = document.getElementById('edit-teamleader-name').value;
                    teamLeader.phone = document.getElementById('edit-teamleader-phone').value;
                    teamLeader.email = document.getElementById('edit-teamleader-email').value;
                    teamLeader.designation = document.getElementById('edit-teamleader-designation').value;
                    const newUsername = document.getElementById('edit-teamleader-username').value;
                    teamLeader.username = newUsername;
                    
                    const newPassword = document.getElementById('edit-teamleader-password').value;
                    const finalPassword = newPassword || (this.data.users[oldUsername]?.password || teamLeader.password);
                    teamLeader.password = finalPassword;
                    // Sync users map on username/password changes
                    if (oldUsername !== newUsername && this.data.users[oldUsername]) {
                        delete this.data.users[oldUsername];
                    }
                    this.data.users[newUsername] = {
                        username: newUsername,
                        password: finalPassword,
                        role: 'teamleader',
                        name: teamLeader.name
                    };
                    if (this.currentUser && this.currentUser.username === oldUsername) {
                        this.currentUser = { ...this.currentUser, username: newUsername, name: teamLeader.name, password: finalPassword };
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    }

                    this.saveData();
                    this.hideModals();
                    this.loadTeamLeaders();
                    this.showNotification('Team Leader updated successfully!', 'success');
                }
            }

            updateStaff() {
                const staffId = parseInt(document.getElementById('edit-staff-id').value);
                const staff = this.data.staff.find(s => s.id === staffId);
                
                if (staff) {
                    const oldUsername = staff.username;
                    staff.name = document.getElementById('edit-staff-name').value;
                    staff.phone = document.getElementById('edit-staff-phone').value;
                    staff.email = document.getElementById('edit-staff-email').value;
                    // Only admin can update designation
                    if (this.currentRole === 'admin') {
                        staff.designation = document.getElementById('edit-staff-designation').value;
                    }
                    const newUsername = document.getElementById('edit-staff-username').value;
                    staff.username = newUsername;
                    staff.teamLeader = document.getElementById('edit-staff-teamleader').value;
                    
                    const newPassword = document.getElementById('edit-staff-password').value;
                    const finalPassword = newPassword || (this.data.users[oldUsername]?.password || staff.password);
                    staff.password = finalPassword;
                    // Sync users map on username/password changes
                    if (oldUsername !== newUsername && this.data.users[oldUsername]) {
                        delete this.data.users[oldUsername];
                    }
                    this.data.users[newUsername] = {
                        username: newUsername,
                        password: finalPassword,
                        role: 'staff',
                        name: staff.name
                    };
                    if (this.currentUser && this.currentUser.username === oldUsername) {
                        this.currentUser = { ...this.currentUser, username: newUsername, name: staff.name, password: finalPassword };
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    }

                    this.saveData();
                    this.hideModals();
                    this.loadStaff();
                    this.showNotification('Staff updated successfully!', 'success');
                }
            }

            // Toggle Status Methods
            toggleSupervisorStatus(supervisorId) {
                const supervisor = this.data.supervisors.find(s => s.id === supervisorId);
                if (!supervisor) return;
                const newStatus = supervisor.status === 'available' ? 'dayoff' : 'available';
                fetch(`/api/supervisors/${encodeURIComponent(supervisorId)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
                .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                .then(() => { this.loadSupervisors(); this.showNotification(`Supervisor status updated to ${newStatus === 'available' ? 'Available' : 'Day Off'}`, 'success'); })
                .catch(() => this.showNotification('Failed to update status', 'error'));
            }

            toggleTeamLeaderStatus(teamLeaderId) {
                const teamLeader = this.data.teamLeaders.find(t => t.id === teamLeaderId);
                if (!teamLeader) return;
                const newStatus = teamLeader.status === 'available' ? 'dayoff' : 'available';
                fetch(`/api/teamleaders/${encodeURIComponent(teamLeaderId)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
                .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                .then(() => { this.loadTeamLeaders(); this.showNotification(`Team Leader status updated to ${newStatus === 'available' ? 'Available' : 'Day Off'}`, 'success'); })
                .catch(() => this.showNotification('Failed to update status', 'error'));
            }

            toggleStaffStatus(staffId) {
                const staff = this.data.staff.find(s => s.id === staffId);
                if (!staff) return;
                const newStatus = staff.status === 'available' ? 'dayoff' : 'available';
                fetch(`/api/staff/${encodeURIComponent(staffId)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
                .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                .then(() => { this.loadStaff(); this.showNotification(`Staff status updated to ${newStatus === 'available' ? 'Available' : 'Day Off'}`, 'success'); })
                .catch(() => this.showNotification('Failed to update status', 'error'));
            }

            // Profile Update Method
            async updateProfile(e) {
                e.preventDefault();
                
                try {
                    console.log('Updating profile for role:', this.currentRole);
                    
                    // Get current user data
                    let userData;
                    console.log('Current role:', this.currentRole);
                    console.log('Current user:', this.currentUser);
                    console.log('Available users:', this.data.users);
                    
                    if (this.currentRole === 'admin') {
                        userData = this.data.users['admin'];
                        console.log('Admin user data:', userData);
                    } else if (this.currentRole === 'supervisor') {
                        console.log('Looking for supervisor with username:', this.currentUser.username);
                        console.log('Available supervisors:', this.data.supervisors);
                        userData = this.data.supervisors.find(s => s.username === this.currentUser.username);
                        console.log('Supervisor user data:', userData);
                    } else if (this.currentRole === 'teamleader') {
                        console.log('Looking for team leader with username:', this.currentUser.username);
                        console.log('Available team leaders:', this.data.teamLeaders);
                        userData = this.data.teamLeaders.find(t => t.username === this.currentUser.username);
                        console.log('Team leader user data:', userData);
                    } else if (this.currentRole === 'staff') {
                        console.log('Looking for staff with username:', this.currentUser.username);
                        console.log('Available staff:', this.data.staff);
                        userData = this.data.staff.find(s => s.username === this.currentUser.username);
                        console.log('Staff user data:', userData);
                    }
                    
                    if (!userData) {
                        console.error('User data not found for role:', this.currentRole);
                        console.error('Available data:', this.data);
                        this.showNotification('User data not found', 'error');
                        return;
                    }

                    console.log('Found user data before update:', userData);

                    // Validate inputs
                    const name = document.getElementById('profile-name').value?.trim();
                    const phone = document.getElementById('profile-phone').value?.trim();
                    const email = document.getElementById('profile-email').value?.trim();
                    const newPassword = document.getElementById('profile-password').value;
                    const confirmPassword = document.getElementById('profile-confirm-password').value;
                    
                    if (!name) {
                        this.showNotification('Name is required', 'error');
                        return;
                    }

                    if (email && !this.isValidEmail(email)) {
                        this.showNotification('Please enter a valid email address', 'error');
                        return;
                    }

                    if (phone && !this.isValidPhone(phone)) {
                        this.showNotification('Please enter a valid phone number', 'error');
                        return;
                    }
                    
                    // Update basic info
                    userData.name = name;
                    userData.phone = phone || userData.phone;
                    userData.email = email || userData.email;
                    
                    // Update password if provided
                    if (newPassword) {
                        if (newPassword.length < 6) {
                            this.showNotification('Password must be at least 6 characters long', 'error');
                            return;
                        }
                        if (newPassword !== confirmPassword) {
                            this.showNotification('Passwords do not match', 'error');
                            return;
                        }
                        userData.password = newPassword;
                        
                        // Also update in users collection for login
                        if (this.data.users[userData.username]) {
                            this.data.users[userData.username].password = newPassword;
                        }
                    }
                    
                    // Handle profile image upload
                    const profileInput = document.getElementById('profile-image');
                    if (profileInput && profileInput.files && profileInput.files[0]) {
                        try {
                            const form = new FormData();
                            form.append('file', profileInput.files[0]);
                            const res = await fetch('/api/upload', { method: 'POST', body: form });
                            const data = await res.json();
                            if (data && data.url) {
                                userData.profileImage = data.url;
                                console.log('Profile image uploaded:', data.url);
                            }
                        } catch (error) {
                            console.error('Failed to upload profile image:', error);
                            this.showNotification('Failed to upload profile image', 'error');
                        }
                    }
                    
                    // Handle Emirates ID uploads (Front/Back)
                    const emiratesFrontInput = document.getElementById('emirates-id-front');
                    if (emiratesFrontInput && emiratesFrontInput.files && emiratesFrontInput.files[0] && !emiratesFrontInput.dataset.uploadUrl) {
                        this.showNotification('Uploading Emirates ID Front... please wait then click Update again', 'warning');
                        return;
                    }
                    if (emiratesFrontInput && emiratesFrontInput.files && emiratesFrontInput.files[0]) {
                        try {
                            const form = new FormData();
                            form.append('file', emiratesFrontInput.files[0]);
                            const res = await fetch('/api/upload', { method: 'POST', body: form });
                            const data = await res.json();
                            if (data && data.url) {
                                userData.emiratesIdFront = data.url;
                                // Also mirror into users map for redundancy
                                if (this.data.users[userData.username]) {
                                    this.data.users[userData.username].emiratesIdFront = data.url;
                                }
                                console.log('Emirates ID Front uploaded:', data.url);
                            }
                        } catch (error) {
                            console.error('Failed to upload Emirates ID Front:', error);
                            this.showNotification('Failed to upload Emirates ID Front', 'error');
                        }
                    }

                    const emiratesBackInput = document.getElementById('emirates-id-back');
                    if (emiratesBackInput && emiratesBackInput.files && emiratesBackInput.files[0] && !emiratesBackInput.dataset.uploadUrl) {
                        this.showNotification('Uploading Emirates ID Back... please wait then click Update again', 'warning');
                        return;
                    }
                    if (emiratesBackInput && emiratesBackInput.files && emiratesBackInput.files[0]) {
                        try {
                            const form = new FormData();
                            form.append('file', emiratesBackInput.files[0]);
                            const res = await fetch('/api/upload', { method: 'POST', body: form });
                            const data = await res.json();
                            if (data && data.url) {
                                userData.emiratesIdBack = data.url;
                                // Also mirror into users map for redundancy
                                if (this.data.users[userData.username]) {
                                    this.data.users[userData.username].emiratesIdBack = data.url;
                                }
                                console.log('Emirates ID Back uploaded:', data.url);
                            }
                        } catch (error) {
                            console.error('Failed to upload Emirates ID Back:', error);
                            this.showNotification('Failed to upload Emirates ID Back', 'error');
                        }
                    }
                    
                    // Update current user in localStorage
                    if (this.currentUser && this.currentUser.username === userData.username) {
                        this.currentUser.name = userData.name;
                        this.currentUser.phone = userData.phone;
                        this.currentUser.email = userData.email;
                        this.currentUser.profileImage = userData.profileImage;
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    }
                    
                    // Save data based on role
                    console.log('User data after update:', userData);
                    
                    if (this.currentRole === 'admin') {
                        // For admin, update both users collection and save
                        this.data.users['admin'] = userData;
                        console.log('Updated admin in users collection:', this.data.users['admin']);
                    }
                    
                    // Persist directly to the specific collection first to avoid race conditions
                    if (this.currentRole === 'supervisor' && userData.id != null) {
                        await fetch(`/api/supervisors/${encodeURIComponent(userData.id)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(userData)
                        });
                    } else if (this.currentRole === 'teamleader' && userData.id != null) {
                        await fetch(`/api/teamleaders/${encodeURIComponent(userData.id)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(userData)
                        });
                    } else if (this.currentRole === 'staff' && userData.id != null) {
                        await fetch(`/api/staff/${encodeURIComponent(userData.id)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(userData)
                        });
                    }

                    // Also persist aggregate maps
                    console.log('About to save data...');
                    await this.saveData();
                    console.log('Data saved successfully');
                    // Refresh latest data for the current role so other views see the updates immediately
                    if (this.currentRole === 'supervisor') {
                        await this.fetchPeople('supervisors');
                    } else if (this.currentRole === 'teamleader') {
                        await this.fetchPeople('teamLeaders');
                    } else if (this.currentRole === 'staff') {
                        await this.fetchPeople('staff');
                    }
                    
                    // Update UI
                    this.updateUserAvatar();
                    
                    this.showNotification('Profile updated successfully!', 'success');
                    this.hideModals();
                    
                } catch (error) {
                    console.error('Profile update error:', error);
                    this.showNotification('Error updating profile: ' + error.message, 'error');
                }
            }

            // Update user avatar in UI
            updateUserAvatar() {
                const avatarEl = document.getElementById('user-avatar');
                const initialsEl = document.getElementById('user-initials');
                
                if (this.currentUser && this.currentUser.profileImage) {
                    if (avatarEl && initialsEl) {
                        initialsEl.style.display = 'none';
                        avatarEl.style.backgroundImage = `url(${this.currentUser.profileImage})`;
                        avatarEl.style.backgroundSize = 'cover';
                        avatarEl.style.backgroundPosition = 'center';
                    }
                } else if (this.currentUser && this.currentUser.name) {
                    if (avatarEl && initialsEl) {
                        initialsEl.style.display = 'flex';
                        initialsEl.textContent = this.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                        avatarEl.style.backgroundImage = '';
                    }
                }
            }

            // Load Profile
            async loadProfile() {
                if (!this.currentUser) return;
                
                // Populate profile form
                document.getElementById('profile-name').value = this.currentUser.name || '';
                document.getElementById('profile-phone').value = this.currentUser.phone || '';
                document.getElementById('profile-email').value = this.currentUser.email || '';
                document.getElementById('profile-password').value = '';
                document.getElementById('profile-confirm-password').value = '';
                
                // Show profile image preview
                if (this.currentUser.profileImage) {
                    const preview = document.getElementById('profile-image-preview');
                    preview.innerHTML = `<img src="${this.getImageUrl(this.currentUser.profileImage)}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:10px;" onerror="this.style.display='none'">`;
                }
                
                // Show Emirates ID previews
                if (this.currentUser.emiratesIdFront) {
                    const preview = document.getElementById('emirates-front-preview');
                    preview.innerHTML = `<img src="${this.getImageUrl(this.currentUser.emiratesIdFront)}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:10px;" onerror="this.style.display='none'">`;
                }
                if (this.currentUser.emiratesIdBack) {
                    const preview = document.getElementById('emirates-back-preview');
                    preview.innerHTML = `<img src="${this.getImageUrl(this.currentUser.emiratesIdBack)}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:10px;" onerror="this.style.display='none'">`;
                }
                
                // Show branding section only for admin
                const brandingCard = document.getElementById('branding-card');
                if (brandingCard) {
                    brandingCard.style.display = this.currentRole === 'admin' ? 'block' : 'none';
                    
                    if (this.currentRole === 'admin') {
                        // Load current branding
                        fetch('/api/branding')
                            .then(r => r.json())
                            .then(b => {
                                if (b && b.logoUrl) {
                                    const preview = document.getElementById('branding-logo-preview');
                                    preview.innerHTML = `<img src="${this.getImageUrl(b.logoUrl)}" style="max-width:300px; max-height:150px; border-radius:8px; margin-top:10px;" onerror="this.style.display='none'">`;
                                }
                            })
                            .catch(() => {});
                    }
                }
                
                // Setup branding logo preview
                const brandingLogoInput = document.getElementById('branding-logo');
                if (brandingLogoInput) {
                    brandingLogoInput.onchange = (e) => {
                        if (e.target.files && e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const preview = document.getElementById('branding-logo-preview');
                                preview.innerHTML = `<img src="${event.target.result}" style="max-width:300px; max-height:150px; border-radius:8px; margin-top:10px;">`;
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    };
                }
            }
            
            // Save Branding
            async saveBranding() {
                const logoInput = document.getElementById('branding-logo');
                if (!logoInput || !logoInput.files || !logoInput.files[0]) {
                    this.showNotification('Please select a logo file', 'error');
                    return;
                }
                
                try {
                    // Upload logo
                    const logoUrl = await this.uploadFile(logoInput.files[0]);
                    
                    // Save to backend
                    const response = await fetch('/api/branding', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ logoUrl })
                    });
                    
                    if (!response.ok) throw new Error('Failed to save branding');
                    
                    // Update localStorage and reload logos
                    localStorage.setItem('moveit_logo_url', logoUrl);
                    this.loadBrandingLogo();
                    
                    this.showNotification('Logo saved successfully! It will appear in sidebar, header, and PDF reports.', 'success');
                    
                    // Update preview
                    const preview = document.getElementById('branding-logo-preview');
                    preview.innerHTML = `<img src="${this.getImageUrl(logoUrl)}" style="max-width:300px; max-height:150px; border-radius:8px; margin-top:10px;">`;
                    
                } catch (error) {
                    console.error('Error saving branding:', error);
                    this.showNotification('Error saving logo: ' + error.message, 'error');
                }
            }

            // Mobile sidebar toggle
            toggleSidebar() {
                document.body.classList.toggle('sidebar-open');
            }

            // Clear all cached data and refresh
            clearAllData() {
                this.data = {
                    jobs: [],
                    supervisors: [],
                    teamLeaders: [],
                    staff: [],
                    surveys: [],
                    users: {}
                };
                localStorage.removeItem('moveit247_data');
                this.forceRefresh();
                this.showNotification('All data cleared and refreshed', 'success');
            }

            // Rest of the methods remain the same as previous implementation
            showJobCompletionModal(jobId) {
                document.getElementById('completion-job-id').value = jobId;
                document.getElementById('client-satisfaction').value = '';
                document.getElementById('tip-amount').value = '';
                document.getElementById('client-comments').value = '';
                this.showModal('job-completion-modal');
            }

            // Removed duplicate submitJobCompletion function - using the one with signature below

            // Team Leader Actions
            renderTeamLeaderActions(job) {
                const actions = [];
                
                if (job.status === 'assigned') {
                    actions.push(`<button class="btn btn-success btn-sm tl-arrived-btn" data-id="${job.id}">Arrived at 1st Location</button>`);
                } else if (job.status === 'arrived') {
                    actions.push(`<button class="btn btn-warning btn-sm tl-packing-btn" data-id="${job.id}">Start Packing</button>`);
                } else if (job.status === 'packing-start') {
                    actions.push(`<button class="btn btn-primary btn-sm tl-first-complete-btn" data-id="${job.id}">1st Location Complete</button>`);
                } else if (job.status === 'first-location-completed') {
                    actions.push(`<button class="btn btn-info btn-sm tl-arrived-second-btn" data-id="${job.id}">Arrived at 2nd Location</button>`);
                } else if (job.status === 'arrived-second-location') {
                    actions.push(`<button class="btn btn-warning btn-sm tl-unpacking-btn" data-id="${job.id}">Start Unpacking</button>`);
                } else if (job.status === 'unpacking-start') {
                    actions.push(`<button class="btn btn-success btn-sm tl-complete-btn" data-id="${job.id}">Complete Job</button>`);
                } else if (job.status === 'delayed') {
                    // If job is delayed, show button to resume
                    actions.push(`<button class="btn btn-warning btn-sm tl-resume-btn" data-id="${job.id}">Resume Job</button>`);
                }
                
                // Add delay button for any active job (not completed or waiting approval)
                if (!['completed', 'waiting-approval'].includes(job.status)) {
                    actions.push(`<button class="btn btn-danger btn-sm tl-delay-btn" data-id="${job.id}" style="margin-left: 5px;">Mark as Delayed</button>`);
                }
                
                return actions.join(' ');
            }

            bindTeamLeaderActionButtons(container, job) {
                const arrivedBtn = container.querySelector('.tl-arrived-btn');
                if (arrivedBtn) {
                    arrivedBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'arrived'));
                }
                
                const packingBtn = container.querySelector('.tl-packing-btn');
                if (packingBtn) {
                    packingBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'packing-start'));
                }
                
                const firstCompleteBtn = container.querySelector('.tl-first-complete-btn');
                if (firstCompleteBtn) {
                    firstCompleteBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'first-location-completed'));
                }
                
                const arrivedSecondBtn = container.querySelector('.tl-arrived-second-btn');
                if (arrivedSecondBtn) {
                    arrivedSecondBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'arrived-second-location'));
                }
                
                const unpackingBtn = container.querySelector('.tl-unpacking-btn');
                if (unpackingBtn) {
                    unpackingBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'unpacking-start'));
                }
                
                const completeBtn = container.querySelector('.tl-complete-btn');
                if (completeBtn) {
                    completeBtn.addEventListener('click', () => this.showJobCompletionModal(job.id));
                }
                
                // Delay button - available on all active jobs
                const delayBtn = container.querySelector('.tl-delay-btn');
                if (delayBtn) {
                    delayBtn.addEventListener('click', () => this.tlSetStatus(job.id, 'delayed'));
                }
                
                // Resume button - when job is delayed, resume to previous status
                const resumeBtn = container.querySelector('.tl-resume-btn');
                if (resumeBtn) {
                    resumeBtn.addEventListener('click', () => this.tlResumeFromDelay(job.id));
                }
            }

            // Team Leader Status Change with Image Upload
            pendingStatusChange = null;

            tlResumeFromDelay(jobId) {
                // Find the job
                const job = this.data.jobs.find(j => j.id === jobId);
                if (!job) {
                    this.showNotification('Job not found', 'error');
                    return;
                }
                
                // Find the status before the delay by checking history
                let previousStatus = 'assigned'; // default
                if (job.history && job.history.length > 0) {
                    // Find the last non-delayed status
                    for (let i = job.history.length - 1; i >= 0; i--) {
                        if (job.history[i].status !== 'delayed') {
                            previousStatus = job.history[i].status;
                            break;
                        }
                    }
                }
                
                // Resume to the previous status
                this.tlSetStatus(jobId, previousStatus);
            }

            tlSetStatus(jobId, status) {
                this.pendingStatusChange = { jobId, status };
                document.getElementById('status-image-input').value = '';
                document.getElementById('status-image-preview').src = '';
                document.getElementById('status-notes').value = '';
                
                // Customize modal based on status
                const notesField = document.getElementById('status-notes');
                const notesRequired = document.getElementById('notes-required-indicator');
                const instruction = document.getElementById('status-modal-instruction');
                const hint = document.getElementById('status-notes-hint');
                
                // Make comments required for delayed status
                if (status === 'delayed') {
                    notesRequired.style.display = 'inline';
                    notesField.required = true;
                    instruction.textContent = 'Status update to DELAYED - Please explain the reason:';
                    hint.textContent = 'Required: Please specify the reason for the delay (e.g., traffic, client not ready, missing permits, etc.)';
                    notesField.placeholder = 'e.g., Heavy traffic on Sheikh Zayed Road causing 30 min delay...';
                } else {
                    notesRequired.style.display = 'none';
                    notesField.required = false;
                    instruction.textContent = 'Please upload an image and add comments for this status change:';
                    hint.textContent = 'Please provide details about this status update. This helps track job progress and any issues encountered.';
                    notesField.placeholder = 'Add comments about this status change (e.g., arrived on time, loading completed, etc.)...';
                }
                
                this.showModal('status-image-modal');
            }

            previewStatusImage() {
                const input = document.getElementById('status-image-input');
                const preview = document.getElementById('status-image-preview');
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            closeStatusImageModal() {
                console.log('Closing status image modal without saving');
                // Clear the form
                const input = document.getElementById('status-image-input');
                if (input) input.value = '';
                const preview = document.getElementById('status-image-preview');
                if (preview) preview.style.display = 'none';
                const notes = document.getElementById('status-notes');
                if (notes) notes.value = '';
                
                // Clear pending change and close modal
                this.pendingStatusChange = null;
                this.hideModals();
            }

            async confirmStatusChange() {
                console.log('confirmStatusChange called');
                console.log('pendingStatusChange:', this.pendingStatusChange);
                
                if (!this.pendingStatusChange) {
                    console.error('No pending status change found!');
                    this.showNotification('No pending status change', 'error');
                    return;
                }
                
                const { jobId, status } = this.pendingStatusChange;
                console.log('Changing status for job:', jobId, 'to:', status);
                
                // Validate required notes for delayed status
                const notesField = document.getElementById('status-notes');
                const notes = notesField.value.trim();
                if (status === 'delayed' && !notes) {
                    this.showNotification('Please provide a reason for the delay', 'error');
                    notesField.focus();
                    return;
                }
                
                let imageUrl = null;
                
                // Upload image if selected
                const input = document.getElementById('status-image-input');
                if (input && input.files && input.files[0]) {
                    console.log('Uploading image...');
                    try {
                        const formData = new FormData();
                        formData.append('file', input.files[0]);
                        const res = await fetch('/api/upload', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (data && data.url) {
                            imageUrl = data.url;
                            console.log('Image uploaded:', imageUrl);
                        }
                    } catch (error) {
                        console.error('Image upload error:', error);
                        this.showNotification('Failed to upload image', 'error');
                        return;
                    }
                } else {
                    console.log('No image selected');
                }
                
                // Update job status
                try {
                    console.log('Updating job status...');
                    const payload = { 
                        status, 
                        image: imageUrl,
                        notes: document.getElementById('status-notes')?.value || ''
                    };
                    console.log('Payload:', payload);
                    
                    const res = await fetch(`/api/jobs/${jobId}/status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('Status update response:', res.status);
                    
                    if (res.ok) {
                        console.log('Status updated successfully');
                        this.closeStatusImageModal();
                        this.showNotification('Status updated successfully!', 'success');
                        
                        // Refresh the jobs list and reload the dashboard
                        await this.fetchJobs();
                        this.populateCurrentJobs();
                        await this.loadDashboard();
                    } else {
                        const errorData = await res.json();
                        console.error('Status update failed:', errorData);
                        throw new Error('Status update failed');
                    }
                } catch (error) {
                    console.error('Status update error:', error);
                    this.showNotification('Failed to update status', 'error');
                }
                
                this.pendingStatusChange = null;
            }

            // Job History Rendering
            renderJobHistory(job) {
                if (!job.history || job.history.length === 0) {
                    return '<p>No history available</p>';
                }
                
                return `
                    <div class="history-timeline">
                        ${job.history.map(entry => {
                            const isDelayed = entry.status === 'delayed';
                            const itemClass = isDelayed ? 'history-item history-item-delayed' : 'history-item';
                            return `
                                <div class="${itemClass}">
                                    <div class="history-status">${this.formatStatus(entry.status)}${isDelayed ? ' ‚ö†Ô∏è' : ''}</div>
                                <div class="history-time">${new Date(entry.at).toLocaleString()}</div>
                                    ${entry.image ? `<img src="${app.getImageUrl(entry.image)}" class="history-image" alt="Status image" onclick="app.showImageModal('${entry.image}')">` : ''}
                                ${entry.notes ? `<p class="history-notes">${entry.notes}</p>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // Bills Rendering
            renderJobBills(job) {
                if (!job.bills || job.bills.length === 0) {
                    return '<div style="margin-top: 20px;"><h4>Bills & Expenses</h4><p>No bills attached yet</p></div>';
                }
                
                const totalAmount = job.bills.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                
                return `
                    <div style="margin-top: 30px;">
                        <h4>Bills & Expenses (Total: ${totalAmount.toFixed(2)} AED)</h4>
                        ${job.bills.map((bill, index) => `
                            <div class="bill-item">
                                <div class="bill-header">
                                    <div class="bill-description">üìã ${bill.description}</div>
                                    <div class="bill-amount">${parseFloat(bill.amount).toFixed(2)} AED</div>
                                </div>
                                <div class="bill-meta">
                                    <div class="bill-meta-item">
                                        <i class="fas fa-user"></i>
                                        <span>Attached by: ${bill.attachedBy}</span>
                                    </div>
                                    <div class="bill-meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${new Date(bill.attachedAt).toLocaleString()}</span>
                                    </div>
                                </div>
                                ${bill.fileUrl ? `
                                    <a href="${bill.fileUrl}" target="_blank" class="bill-file-link">
                                        <i class="fas fa-file-download"></i>
                                        View/Download Bill Document
                                    </a>
                                ` : ''}
                                ${bill.notes ? `<div class="bill-notes"><strong>Notes:</strong> ${bill.notes}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Bill Attachment Functions
            showAttachBillModal(jobId) {
                console.log('showAttachBillModal called with jobId:', jobId);
                
                try {
                    // Check if all required elements exist
                    const requiredElements = [
                        'bill-modal',
                        'bill-job-id',
                        'bill-description',
                        'bill-amount',
                        'bill-file',
                        'bill-notes',
                        'bill-preview'
                    ];
                    
                    for (const elemId of requiredElements) {
                        const elem = document.getElementById(elemId);
                        if (!elem) {
                            throw new Error(`Required element '${elemId}' not found in DOM`);
                        }
                    }
                    
                    document.getElementById('bill-job-id').value = jobId;
                    document.getElementById('bill-description').value = '';
                    document.getElementById('bill-amount').value = '';
                    document.getElementById('bill-file').value = '';
                    document.getElementById('bill-notes').value = '';
                    document.getElementById('bill-preview').innerHTML = '';
                    
                    // Setup file preview
                    const billFileInput = document.getElementById('bill-file');
                    billFileInput.onchange = () => {
                        const file = billFileInput.files[0];
                        if (file) {
                            const preview = document.getElementById('bill-preview');
                            if (file.type.startsWith('image/')) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; margin-top: 10px;">`;
                                };
                                reader.readAsDataURL(file);
                            } else if (file.type === 'application/pdf') {
                                preview.innerHTML = `<div style="margin-top: 10px; color: #4caf50;"><i class="fas fa-file-pdf"></i> ${file.name} (${(file.size / 1024).toFixed(2)} KB)</div>`;
                            }
                        }
                    };
                    
                    console.log('Opening bill modal...');
                    const modal = document.getElementById('bill-modal');
                    modal.style.display = 'flex';
                    console.log('Bill modal display set to flex, should be visible now');
                } catch (error) {
                    console.error('Error in showAttachBillModal:', error);
                    this.showNotification('Error opening bill form: ' + error.message, 'error');
                }
            }

            closeBillModal() {
                this.hideModals();
            }

            async submitBill() {
                console.log('=== submitBill function called ===');
                
                // Get button and show loading state
                const submitBtn = document.getElementById('submit-bill-btn');
                if (!submitBtn) {
                    alert('Error: Submit button not found!');
                    return;
                }
                
                try {
                    // Disable button and show loading
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                    
                    const jobId = document.getElementById('bill-job-id').value;
                    const description = document.getElementById('bill-description').value.trim();
                    const amount = document.getElementById('bill-amount').value;
                    const notes = document.getElementById('bill-notes').value.trim();
                    const fileInput = document.getElementById('bill-file');
                    
                    console.log('Bill form data:', { jobId, description, amount, hasFile: !!fileInput.files[0] });
                    
                    if (!description || !amount || !fileInput.files[0]) {
                        this.showNotification('Please fill in all required fields', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Attach Bill';
                        return;
                    }
                    
                    console.log('Starting file upload...');
                    // Upload file first
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    
                    const uploadRes = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('Upload response status:', uploadRes.status);
                    
                    if (!uploadRes.ok) {
                        throw new Error('File upload failed with status: ' + uploadRes.status);
                    }
                    
                    const uploadData = await uploadRes.json();
                    console.log('Upload response data:', uploadData);
                    
                    if (!uploadData.url) {
                        throw new Error('No URL returned from upload');
                    }
                    
                    console.log('File uploaded successfully:', uploadData.url);
                    
                    // Update button text
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Attaching Bill...';
                    
                    // Attach bill to job
                    const billData = {
                        description,
                        amount: parseFloat(amount),
                        fileUrl: uploadData.url,
                        notes,
                        attachedBy: this.currentUser.name,
                        attachedAt: new Date().toISOString()
                    };
                    
                    console.log('Attaching bill to job:', billData);
                    
                    const res = await fetch(`/api/jobs/${jobId}/bills`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(billData)
                    });
                    
                    console.log('Bill attach response status:', res.status);
                    
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('Bill attach failed:', errorData);
                        throw new Error(errorData.error || 'Failed to attach bill');
                    }
                    
                    console.log('Bill attached successfully!');
                    this.showNotification('Bill attached successfully!', 'success');
                    
                    // Close modal
                    this.closeBillModal();
                    
                    // Reload jobs and refresh details
                    await this.fetchJobs();
                    this.showJobDetails(parseInt(jobId));
                    
                } catch (error) {
                    console.error('=== Error in submitBill ===');
                    console.error('Error details:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    
                    // Show error to user
                    this.showNotification('Failed to attach bill: ' + error.message, 'error');
                    alert('Error attaching bill: ' + error.message + '\n\nCheck console for details.');
                    
                    // Re-enable button
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Attach Bill';
                    }
                }
            }

            // Star Rating System
            initStarRating() {
                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const rating = parseInt(star.dataset.rating);
                        this.setRating(rating);
                    });
                    
                    star.addEventListener('mouseenter', () => {
                        const rating = parseInt(star.dataset.rating);
                        this.highlightStars(rating);
                    });
                });
                
                document.querySelector('.star-rating')?.addEventListener('mouseleave', () => {
                    const currentRating = document.querySelector('.star-rating').dataset.rating || 0;
                    this.highlightStars(parseInt(currentRating));
                });
            }

            setRating(rating) {
                const starContainer = document.querySelector('.star-rating');
                if (starContainer) {
                    starContainer.dataset.rating = rating;
                    this.highlightStars(rating);
                }
            }

            highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            // Signature Pad
            initSignaturePad() {
                const canvas = document.getElementById('signature-pad');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                
                canvas.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    ctx.beginPath();
                    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;
                    const rect = canvas.getBoundingClientRect();
                    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                    ctx.stroke();
                });
                
                canvas.addEventListener('mouseup', () => {
                    isDrawing = false;
                });
                
                // Touch events for mobile
                canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    ctx.beginPath();
                    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
                });
                
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (!isDrawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                    ctx.stroke();
                });
                
                canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    isDrawing = false;
                });
            }

            clearSignature() {
                const canvas = document.getElementById('signature-pad');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            saveSignature() {
                const canvas = document.getElementById('signature-pad');
                const preview = document.getElementById('signature-preview');
                if (canvas && preview) {
                    const dataURL = canvas.toDataURL();
                    preview.src = dataURL;
                    return dataURL;
                }
                return null;
            }

            toggleBoxesCount() {
                const boxesCollected = document.getElementById('boxes-collected').value;
                const boxesCountGroup = document.getElementById('boxes-count-group');
                if (boxesCollected === 'yes') {
                    boxesCountGroup.style.display = 'block';
                } else {
                    boxesCountGroup.style.display = 'none';
                    document.getElementById('boxes-count').value = '';
                }
            }

            showJobCompletionModal(jobId) {
                document.getElementById('completion-job-id').value = jobId;
                this.setRating(0);
                this.clearSignature();
                this.initStarRating();
                this.initSignaturePad();
                // Reset boxes selection
                document.getElementById('boxes-collected').value = 'no';
                document.getElementById('boxes-count-group').style.display = 'none';
                document.getElementById('boxes-count').value = '';
                document.getElementById('completion-tip-amount').value = '';
                this.showModal('completion-modal');
            }

            closeCompletionModal() {
                console.log('Closing completion modal without saving');
                // Clear the form
                const rating = document.querySelector('.star-rating');
                if (rating) rating.dataset.rating = '0';
                
                // Clear stars
                document.querySelectorAll('.star').forEach(star => star.classList.remove('selected'));
                
                // Clear signature
                const canvas = document.getElementById('signature-pad');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // Clear notes
                const notes = document.getElementById('completion-notes');
                if (notes) notes.value = '';
                
                // Clear tip amount
                const tipAmount = document.getElementById('completion-tip-amount');
                if (tipAmount) tipAmount.value = '';
                
                // Clear boxes fields
                const boxesCollected = document.getElementById('boxes-collected');
                if (boxesCollected) boxesCollected.value = 'no';
                const boxesCount = document.getElementById('boxes-count');
                if (boxesCount) boxesCount.value = '';
                const boxesCountGroup = document.getElementById('boxes-count-group');
                if (boxesCountGroup) boxesCountGroup.style.display = 'none';
                
                // Hide signature preview
                const preview = document.getElementById('signature-preview');
                if (preview) preview.style.display = 'none';
                
                this.hideModals();
            }

            submitJobCompletion() {
                console.log('submitJobCompletion called');
                const jobId = document.getElementById('completion-job-id')?.value;
                console.log('Job ID:', jobId);
                
                if (!jobId) {
                    console.error('No job ID found');
                    this.showNotification('Job ID is missing', 'error');
                    return;
                }
                
                const rating = document.querySelector('.star-rating')?.dataset.rating || 0;
                console.log('Rating:', rating);
                
                const signature = this.saveSignature();
                console.log('Signature:', signature ? 'Present' : 'Missing');
                
                const notes = document.getElementById('completion-notes')?.value || '';
                console.log('Notes:', notes);
                
                const tipAmount = parseFloat(document.getElementById('completion-tip-amount')?.value) || 0;
                console.log('Tip Amount:', tipAmount);
                
                const boxesCollected = document.getElementById('boxes-collected')?.value || 'no';
                const boxesCount = boxesCollected === 'yes' ? parseInt(document.getElementById('boxes-count')?.value) || 0 : 0;
                console.log('Boxes Collected:', boxesCollected, 'Count:', boxesCount);
                
                if (!signature) {
                    console.error('No signature provided');
                    this.showNotification('Please provide a signature', 'error');
                    return;
                }
                
                const payload = { 
                    rating: parseInt(rating), 
                    signature, 
                    notes,
                    tipAmount,
                    boxesCollected,
                    boxesCount
                };
                console.log('Submitting completion with payload:', payload);
                
                fetch(`/api/jobs/${jobId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    console.log('Completion response status:', res.status);
                    if (!res.ok) {
                        throw new Error('Completion failed');
                    }
                    return res.json();
                })
                .then(async (data) => {
                    console.log('Job completion successful:', data);
                    this.closeCompletionModal();
                    this.showNotification('Job completed and submitted for approval!', 'success');
                    
                    // Refresh the jobs list and reload the dashboard
                    await this.fetchJobs();
                    this.populateCurrentJobs();
                    await this.loadDashboard();
                })
                .catch((error) => {
                    console.error('Completion error:', error);
                    this.showNotification('Failed to complete job', 'error');
                });
            }
        }

        // Initialize the application
        window.app = new MoveIt247();
        // initializeApp() is already called in constructor, no need to call again

        // Close sidebar when clicking outside (on overlay)
        document.addEventListener('click', function(e) {
            if (document.body.classList.contains('sidebar-open')) {
                const sidebar = document.querySelector('.sidebar');
                const menuToggle = document.querySelector('.menu-toggle');
                
                // Close if clicked outside sidebar and not on menu toggle
                if (sidebar && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    document.body.classList.remove('sidebar-open');
                }
            }
        });
    </script>
</body>
</html>